<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡πÄ‡∏î‡πá‡∏Å 2-5 ‡∏õ‡∏µ (‡∏™‡πÄ‡∏Å‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏£‡∏°‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand-brown: #74640a; --brand-brown-dark: #3b3305; --brand-bg-start: #efe6d0; --brand-bg-end: #e9dcc0; }
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(180deg, var(--brand-bg-start) 0%, var(--brand-bg-end) 100%); }
        .header-bg { background-color: var(--brand-brown) !important; color: #fff !important; }
        .brand-btn { background-color: var(--brand-brown) !important; border-color: var(--brand-brown) !important; color: #fff !important; }
        .brand-btn:hover { background-color: #5f4f07 !important; }
        .gender-selector input:checked + div {
            border-color: currentColor;
            background-color: rgba(currentColor, 0.1);
            border-width: 2px;
        }
        /* Status pill styles (match bmi-dashboard) */
        .status-pill {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 90px;
            white-space: nowrap;
        }
        .status-red { background-color: #ffe4e6; color: #e11d48; }
        .status-orange { background-color: #ffedd5; color: #c2410c; }
        .status-yellow { background-color: #fef9c3; color: #a16207; }
        .status-green { background-color: #dcfce7; color: #15803d; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div class="max-w-7xl mx-auto px-4 py-8 flex justify-center">
        
        <div class="space-y-6 w-full max-w-md">
            <div class="bg-white p-5 rounded-2xl shadow-lg border border-gray-100">
                <h2 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2 text-center">‡∏™‡∏°‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏ó‡∏£‡∏Ñ</h2>

                <div class="mt-3">
                    <label class="block text-sm font-medium text-gray-600 mb-1">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î <span class="text-xs text-gray-400">(‡∏ñ‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô)</span></label>
                    <div class="flex items-center gap-3">
                        <input id="photoInput" type="file" accept="image/*" capture="environment" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <img id="photoPreview" src="" alt="preview" style="display:none; width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb;" />
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">‡πÄ‡∏û‡∏®</label>
                    <div class="grid grid-cols-2 gap-3 gender-selector">
                        <label class="cursor-pointer">
                            <input type="radio" name="gender" value="boy" class="hidden" checked onchange="updateTheme()">
                            <div class="text-center p-3 rounded-xl border border-gray-200 hover:bg-gray-50 transition-all text-blue-500">
                                <span class="text-2xl block">üë¶</span>
                                <span class="text-sm font-bold">‡∏ä‡∏≤‡∏¢</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="gender" value="girl" class="hidden" onchange="updateTheme()">
                            <div class="text-center p-3 rounded-xl border border-gray-200 hover:bg-gray-50 transition-all text-pink-500">
                                <span class="text-2xl block">üëß</span>
                                <span class="text-sm font-bold">‡∏´‡∏ç‡∏¥‡∏á</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="classroom" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1/1 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏õ.1/‡∏Å" class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 outline-none text-center font-semibold" />
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="childName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 outline-none text-center font-semibold" />
                    </div>

                    

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                            <input type="number" id="ageYears" placeholder="0" min="0" max="6" class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 outline-none text-center font-semibold">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                            <input type="number" id="ageMonthsInput" placeholder="0" min="0" max="11" class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 outline-none text-center font-semibold">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                            <input type="number" id="weight" step="0.1" placeholder="0.0" class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 outline-none text-center font-semibold">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                            <input type="number" id="height" step="0.1" placeholder="0.0" class="w-full p-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 outline-none text-center font-semibold">
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <button onclick="addRecord()" id="calcBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-md transition-all transform hover:scale-[1.02] flex justify-center items-center brand-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" />
                        </svg>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </button>
                    <div class="mt-3 flex justify-center">
                        <a href="/bmi-dashboard" class="text-sm bg-white border border-gray-200 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl transform transition-all">
            
            <div id="captureArea" class="bg-gradient-to-br from-white to-gray-50 p-6 relative">
                <div class="absolute top-0 right-0 w-24 h-24 rounded-bl-full opacity-50 -mr-4 -mt-4 z-0" style="background-color: rgba(116,100,10,0.12);"></div>
                
                <div class="text-center relative z-10">
                    <h3 class="text-xl font-bold text-gray-800 mb-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h3>
                    <p class="text-xs text-gray-500" id="resDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -</p>
                </div>

                <div class="mt-4 flex flex-col items-center relative z-10">
                    <div class="w-28 h-28 rounded-full border-4 border-white shadow-md overflow-hidden bg-gray-200 mb-4">
                        <img id="resPhoto" src="" class="w-full h-full object-cover hidden">
                        <span id="resPhotoPlaceholder" class="w-full h-full flex items-center justify-center text-2xl">üë∂</span>
                    </div>
                    <h2 class="text-2xl font-bold text-blue-600" id="resName">‡∏ô‡πâ‡∏≠‡∏á...</h2>
                    <p class="text-sm text-gray-600" id="resAge">‡∏≠‡∏≤‡∏¢‡∏∏ - ‡∏õ‡∏µ - ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4 relative z-10">
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm text-center">
                        <div class="text-xs text-gray-500">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
                        <div class="text-lg font-bold text-gray-800"><span id="resWeight">-</span> <span class="text-xs font-normal">‡∏Å‡∏Å.</span></div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm text-center">
                        <div class="text-xs text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</div>
                        <div class="text-lg font-bold text-gray-800"><span id="resHeight">-</span> <span class="text-xs font-normal">‡∏ã‡∏°.</span></div>
                    </div>
                </div>

                <div class="mt-5 space-y-2 relative z-10">
                    <div class="flex flex-col p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center">
                                <span class="text-sm font-semibold text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</span>
                                <span id="resStatWH" class="status-pill status-green">-</span>
                            </div>
                    </div>
                    
                    <div class="flex flex-col p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏</span>
                            <span id="resStatHA" class="status-pill status-green">-</span>
                        </div>
                    </div>

                    <div class="flex flex-col p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏</span>
                            <span id="resStatWA" class="status-pill status-green">-</span>
                        </div>
                    </div>
                </div>

                <div class="mt-4 text-center">
                   <p class="text-[10px] text-gray-400">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ‡∏Å‡∏£‡∏°‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢ (2564)</p>
                </div>
            </div>

            <div class="bg-gray-50 p-4 border-t flex gap-3">
                <button onclick="editResult()" class="flex-1 py-2 rounded-lg border border-gray-300 text-gray-600 font-medium text-sm hover:bg-gray-100">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button onclick="saveAndGoDashboard()" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-medium text-sm hover:bg-blue-700 flex justify-center items-center shadow-md brand-btn">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
            </div>
        </div>
    </div>

    
    <script>
        // --- HIGH RESOLUTION DATA (2-5 Years) ---
        // array indices: 0:-2SD, 1:-1.5SD, 2:Median, 3:+1.5SD, 4:+2SD, 5:+3SD
const growthData = {
            boy: {
                group_0_5: {
                    w_h: [
                        {x:65,y:[6.6,6.9,7.5,8.3,8.9,9.8]}, 
                        {x:70,y:[7.4,7.8,8.5,9.5,10.2,11.5]}, 
                        {x:75,y:[8.2,8.7,9.6,10.8,11.6,13.0]}, 
                        {x:80,y:[9.1,9.6,10.6,12.0,12.9,14.6]}, 
                        {x:85,y:[10.0,10.7,11.8,13.4,14.5,16.4]}, 
                        {x:90,y:[11.0,11.8,13.0,14.8,16.0,18.2]}, 
                        {x:95,y:[12.1,12.9,14.3,16.4,17.7,20.1]}, 
                        {x:100,y:[13.2,14.1,15.7,18.0,19.5,22.2]}, 
                        {x:105,y:[14.4,15.5,17.3,19.9,21.5,24.5]}, 
                        {x:110,y:[15.8,16.9,19.0,22.0,23.7,27.0]}, 
                        {x:115,y:[17.2,18.5,20.9,24.2,26.1,29.9]}, 
                        {x:120,y:[18.8,20.2,23.0,26.7,28.8,33.0]},
                        {x:125,y:[20.5,22.1,25.3,29.5,31.8,36.5]},
                        {x:130,y:[22.5,24.3,28.0,32.7,35.3,40.6]},
                        {x:135,y:[24.8,26.8,30.9,36.2,39.2,45.1]},
                        {x:140,y:[27.3,29.7,34.3,40.2,43.6,50.4]}
                    ],
                    w_a: [
                        {x:0,y:[2.4,2.6,3.3,4.2,4.5]}, 
                        {x:6,y:[6.4,6.8,7.9,9.4,9.9]}, 
                        {x:12,y:[7.7,8.2,9.6,11.2,11.9]}, 
                        {x:18,y:[8.8,9.4,10.9,12.8,13.7]}, 
                        {x:24,y:[9.7,10.3,12.2,14.4,15.3]}, 
                        {x:30,y:[10.5,11.2,13.3,15.7,16.9]}, 
                        {x:36,y:[11.3,12.0,14.3,17.0,18.3]}, 
                        {x:42,y:[12.0,12.8,15.3,18.2,19.7]}, 
                        {x:48,y:[12.7,13.6,16.3,19.4,21.2]}, 
                        {x:54,y:[13.4,14.3,17.3,20.7,22.7]}, 
                        {x:60,y:[14.1,15.1,18.3,21.9,24.2]}, 
                        {x:72,y:[15.5,16.6,20.2,24.5,27.0]}
                    ],
                    h_a: [
                        {x:0,y:[46,47,50,53,54]}, 
                        {x:6,y:[63,64,68,71,72]}, 
                        {x:12,y:[71,72,76,79,81]}, 
                        {x:18,y:[77,78,82,86,88]}, 
                        {x:24,y:[81,82,87,92,93]}, 
                        {x:30,y:[85,86,92,97,98]}, 
                        {x:36,y:[88,90,96,101,103]}, 
                        {x:42,y:[92,93,100,105,107]}, 
                        {x:48,y:[95,96,103,109,111]}, 
                        {x:54,y:[98,99,107,113,115]}, 
                        {x:60,y:[100,102,110,116,119]}, 
                        {x:72,y:[105,107,116,123,125]}
                    ]
                },
                group_6_19: {
                    w_h: [
                        {x:90, y:[11.0, 11.8, 13.0, 14.8, 16.0, 18.2]},
                        {x:95, y:[12.1, 12.9, 14.3, 16.4, 17.7, 20.1]},
                        {x:100, y:[13.2, 14.1, 15.7, 18.0, 19.5, 22.2]},
                        {x:105, y:[14.4, 15.5, 17.3, 19.9, 21.5, 24.5]},
                        {x:110, y:[15.8, 16.9, 19.0, 22.0, 23.7, 27.0]},
                        {x:115, y:[17.2, 18.5, 20.9, 24.2, 26.1, 29.9]},
                        {x:120, y:[18.8, 20.2, 23.0, 26.7, 28.8, 33.0]},
                        {x:125, y:[20.5, 22.1, 25.3, 29.5, 31.8, 36.5]},
                        {x:130, y:[22.5, 24.3, 28.0, 32.7, 35.3, 40.6]},
                        {x:135, y:[24.8, 26.8, 30.9, 36.2, 39.2, 45.1]},
                        {x:140, y:[27.3, 29.7, 34.3, 40.2, 43.6, 50.4]},
                        {x:145, y:[30.0, 32.5, 37.5, 44.5, 48.0, 56.0]},
                        {x:150, y:[32.5, 35.5, 41.0, 48.5, 53.0, 61.5]},
                        {x:155, y:[35.5, 38.5, 45.0, 53.5, 58.0, 67.0]},
                        {x:160, y:[38.5, 42.0, 49.0, 58.0, 63.0, 73.0]},
                        {x:165, y:[41.5, 45.5, 53.0, 62.5, 68.0, 79.0]},
                        {x:170, y:[45.0, 49.0, 57.0, 67.0, 73.0, 85.0]},
                        {x:175, y:[48.0, 52.5, 61.0, 72.0, 78.0, 91.0]},
                        {x:180, y:[51.0, 56.0, 65.0, 77.0, 83.0, 97.0]},
                        {x:185, y:[54.0, 59.0, 69.0, 81.0, 88.0, 103.0]}
                    ],
                    h_a: [
                        {x:6, y:[106, 109, 116, 122, 125]},
                        {x:7, y:[111, 114, 121, 128, 131]},
                        {x:8, y:[116, 119, 127, 134, 137]},
                        {x:9, y:[121, 125, 132, 140, 143]},
                        {x:10, y:[126, 130, 138, 146, 149]},
                        {x:11, y:[131, 136, 144, 153, 157]},
                        {x:12, y:[137, 142, 151, 161, 165]},
                        {x:13, y:[144, 149, 159, 169, 174]},
                        {x:14, y:[150, 156, 166, 176, 181]},
                        {x:15, y:[155, 161, 171, 181, 186]},
                        {x:16, y:[158, 164, 174, 184, 189]},
                        {x:17, y:[160, 166, 176, 186, 190]},
                        {x:18, y:[161, 167, 177, 186, 191]},
                        {x:19, y:[161, 167, 177, 187, 191]}
                    ]
                }
            },
            girl: {
                group_0_5: {
                    w_h: [
                        {x:65,y:[6.3,6.5,7.2,8.1,8.7,9.6]}, 
                        {x:70,y:[7.0,7.3,8.2,9.2,9.9,11.1]}, 
                        {x:75,y:[7.8,8.2,9.1,10.3,11.1,12.5]}, 
                        {x:80,y:[8.6,9.1,10.2,11.5,12.4,14.0]}, 
                        {x:85,y:[9.6,10.1,11.4,12.9,13.9,15.7]}, 
                        {x:90,y:[10.6,11.2,12.7,14.4,15.6,17.7]}, 
                        {x:95,y:[11.7,12.4,14.1,16.1,17.4,19.8]}, 
                        {x:100,y:[12.9,13.7,15.7,18.0,19.4,22.2]}, 
                        {x:105,y:[14.2,15.1,17.4,20.1,21.7,24.9]}, 
                        {x:110,y:[15.7,16.7,19.3,22.4,24.3,27.8]}, 
                        {x:115,y:[17.3,18.4,21.4,25.0,27.1,31.1]}, 
                        {x:120,y:[19.1,20.4,23.8,27.9,30.3,34.8]},
                        {x:125,y:[21.1,22.6,26.6,31.3,34.0,39.1]},
                        {x:130,y:[23.4,25.1,29.8,35.2,38.3,44.1]},
                        {x:135,y:[25.9,27.9,33.3,39.6,43.1,49.8]},
                        {x:140,y:[28.7,31.1,37.3,44.6,48.6,56.4]}
                    ],
                    w_a: [
                        {x:0,y:[2.3,2.5,3.2,4.0,4.3]}, 
                        {x:6,y:[5.7,6.1,7.3,8.7,9.3]}, 
                        {x:12,y:[7.0,7.5,8.9,10.6,11.4]}, 
                        {x:18,y:[8.1,8.6,10.2,12.2,13.1]}, 
                        {x:24,y:[9.0,9.6,11.5,13.7,14.8]}, 
                        {x:30,y:[9.8,10.5,12.7,15.2,16.4]}, 
                        {x:36,y:[10.7,11.4,13.9,16.7,18.1]}, 
                        {x:42,y:[11.5,12.3,15.0,18.1,19.6]}, 
                        {x:48,y:[12.2,13.1,16.1,19.5,21.2]}, 
                        {x:54,y:[12.9,13.9,17.2,21.0,22.9]}, 
                        {x:60,y:[13.6,14.6,18.2,22.3,24.4]}, 
                        {x:72,y:[15.0,16.1,20.5,25.5,28.0]}
                    ],
                    h_a: [
                        {x:0,y:[45,46,49,52,53]}, 
                        {x:6,y:[61,62,66,69,70]}, 
                        {x:12,y:[69,70,74,78,79]}, 
                        {x:18,y:[75,76,81,85,87]}, 
                        {x:24,y:[80,81,86,91,92]}, 
                        {x:30,y:[84,85,91,96,97]}, 
                        {x:36,y:[87,89,95,101,102]}, 
                        {x:42,y:[91,92,99,105,106]}, 
                        {x:48,y:[94,95,103,109,111]}, 
                        {x:54,y:[97,98,106,113,115]}, 
                        {x:60,y:[99,101,109,117,119]}, 
                        {x:72,y:[105,106,116,123,125]}
                    ]
                },
                group_6_19: {
                    w_h: [
                        {x:90, y:[11.0, 11.5, 12.8, 14.5, 16.0, 17.5]},
                        {x:95, y:[12.0, 12.8, 14.0, 16.0, 17.5, 19.5]},
                        {x:100, y:[13.0, 14.0, 15.5, 17.5, 19.0, 21.5]},
                        {x:105, y:[14.2, 15.2, 17.2, 19.5, 21.5, 24.5]},
                        {x:110, y:[15.8, 16.8, 19.0, 22.0, 24.0, 27.5]},
                        {x:115, y:[17.5, 18.5, 21.0, 24.5, 27.0, 31.0]},
                        {x:120, y:[19.0, 20.5, 23.5, 27.5, 30.0, 34.5]},
                        {x:125, y:[21.0, 22.5, 26.0, 31.0, 33.5, 38.5]},
                        {x:130, y:[23.5, 25.0, 29.5, 34.5, 38.0, 43.5]},
                        {x:135, y:[26.0, 28.0, 33.0, 39.0, 42.5, 49.0]},
                        {x:140, y:[29.0, 31.0, 37.0, 44.0, 48.0, 55.5]},
                        {x:145, y:[31.5, 34.0, 40.5, 48.5, 53.0, 62.0]},
                        {x:150, y:[34.5, 37.0, 44.5, 53.5, 58.5, 68.0]},
                        {x:155, y:[37.5, 40.5, 48.0, 57.5, 63.5, 74.0]},
                        {x:160, y:[40.0, 43.5, 52.0, 62.0, 68.0, 80.0]},
                        {x:165, y:[43.0, 46.5, 55.5, 66.0, 72.5, 85.0]},
                        {x:170, y:[45.5, 49.0, 58.5, 70.0, 77.0, 90.0]},
                        {x:175, y:[47.5, 51.5, 61.5, 73.5, 81.0, 95.0]}
                    ],
                    h_a: [
                        {x:6, y:[105, 108, 115, 121, 124]},
                        {x:7, y:[110, 113, 120, 127, 130]},
                        {x:8, y:[115, 118, 126, 133, 136]},
                        {x:9, y:[120, 124, 132, 139, 142]},
                        {x:10, y:[126, 130, 138, 146, 149]},
                        {x:11, y:[132, 137, 145, 153, 157]},
                        {x:12, y:[138, 143, 151, 159, 163]},
                        {x:13, y:[144, 149, 159, 169, 174]},
                        {x:14, y:[150, 156, 166, 176, 181]},
                        {x:15, y:[155, 161, 171, 181, 186]},
                        {x:16, y:[158, 164, 174, 184, 189]},
                        {x:17, y:[160, 166, 176, 186, 190]},
                        {x:18, y:[161, 167, 177, 186, 191]},
                        {x:19, y:[161, 167, 177, 187, 191]}
                    ]
                }
            }
        };

        // Helper to choose a reference group by age/height (same logic as dashboard)
        function getRefsFor(gender, ageTotalM, height) {
            const g = growthData[gender] || growthData['boy'];
            const use0_5 = (ageTotalM <= 72);
            const group = use0_5 ? g.group_0_5 : g.group_6_19;

            let refWA = null, refHA = null, refWH = null;

            if (use0_5) {
                if (group && group.w_a) refWA = getLinearInterpolation(group.w_a, ageTotalM);
                if (group && group.h_a) refHA = getLinearInterpolation(group.h_a, ageTotalM);
                if (group && group.w_h) refWH = getLinearInterpolation(group.w_h, height);
            } else {
                const ageY = Math.floor(ageTotalM / 12);
                if (group && group.h_a) refHA = getLinearInterpolation(group.h_a, ageY);
                if (group && group.w_h) refWH = getLinearInterpolation(group.w_h, height);
                // For ages 6-19 we do NOT provide Weight-for-Age (WA); do not fallback to 0-5 WA
            }

            return { refWA, refHA, refWH };
        }

        let historyData = [];
        
        let pendingRecord = null; // holds the record until user explicitly saves
        function getGender() { return document.querySelector('input[name="gender"]:checked').value; }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                const fr = new FileReader();
                fr.onload = () => resolve(fr.result);
                fr.onerror = reject;
                fr.readAsDataURL(file);
            });
        }
        
        function updateTheme() {
            const gender = getGender();
            const btn = document.getElementById('calcBtn');
            const elements = ['ageYears', 'ageMonthsInput', 'weight', 'height'];
            const headerDeco = document.querySelector('#captureArea .absolute');

            if (gender === 'boy') {
                btn.className = btn.className.replace(/pink/g, 'blue');
                elements.forEach(id => {
                    document.getElementById(id).className = document.getElementById(id).className.replace(/pink/g, 'blue');
                });
                document.body.style.backgroundColor = '#F3F4F6';
                headerDeco.style.backgroundColor = 'rgba(116,100,10,0.12)';
            } else {
                btn.className = btn.className.replace(/blue/g, 'pink');
                elements.forEach(id => {
                    document.getElementById(id).className = document.getElementById(id).className.replace(/blue/g, 'pink');
                });
                document.body.style.backgroundColor = '#FFF1F2';
                headerDeco.style.backgroundColor = 'rgba(116,100,10,0.12)';
            }
        }

        function getLinearInterpolation(dataset, inputX) {
            if (inputX <= dataset[0].x) return dataset[0].y;
            if (inputX >= dataset[dataset.length-1].x) return dataset[dataset.length-1].y;
            for (let i = 0; i < dataset.length - 1; i++) {
                if (inputX >= dataset[i].x && inputX <= dataset[i+1].x) {
                    const t = (inputX - dataset[i].x) / (dataset[i+1].x - dataset[i].x);
                    const yArr = [];
                    const len = Math.max(dataset[i].y.length, dataset[i+1].y.length);
                    for (let j = 0; j < len; j++) {
                        const a = dataset[i].y[j] != null ? dataset[i].y[j] : dataset[i].y[dataset[i].y.length - 1];
                        const b = dataset[i+1].y[j] != null ? dataset[i+1].y[j] : dataset[i+1].y[dataset[i+1].y.length - 1];
                        yArr.push(a * (1 - t) + b * t);
                    }
                    return yArr;
                }
            }
            return dataset[0].y;
        }

        // --- UPDATED EVALUATION LOGIC ---
        function evaluateStatus(val, ref, type) {
            if (!ref || !Array.isArray(ref) || ref.length === 0) return { t: '-', c: 'bg-gray-100' };
            const len = ref.length;
            const median = ref[Math.floor((len - 1) / 2)];
            const low = ref[0];
            const high = ref[len - 1];

            if (type === 'HA') {
                if (val > high) return { t: "‡∏™‡∏π‡∏á", c: "status-green bg-green-100 text-green-700" };
                if (val >= median) return { t: "‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå", c: "status-green" };
                if (val >= low) return { t: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢", c: "status-orange" };
                return { t: "‡πÄ‡∏ï‡∏µ‡πâ‡∏¢", c: "status-red" };
            }

            if (type === 'WA') {
                if (val > high) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å", c: "status-red" };
                if (val >= median) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå", c: "status-green" };
                if (val >= low) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢", c: "status-orange" };
                return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", c: "status-red" };
            }

            if (type === 'WH') {
                if (val > high) return { t: "‡∏≠‡πâ‡∏ß‡∏ô", c: "status-red" };
                if (val >= median) return { t: "‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô", c: "status-green" };
                if (val >= low) return { t: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏°", c: "status-orange" };
                return { t: "‡∏ú‡∏≠‡∏°", c: "status-red" };
            }

            return { t: '-', c: 'bg-gray-100' };
        }

        async function addRecord() {
            const yrsInput = parseInt(document.getElementById('ageYears').value) || 0;
            const mthsInput = parseInt(document.getElementById('ageMonthsInput').value) || 0;
            const childName = (document.getElementById('childName').value || '').trim();
            const classroom = (document.getElementById('classroom') && document.getElementById('classroom').value) ? document.getElementById('classroom').value.trim() : '';
            const photoFile = document.getElementById('photoInput').files && document.getElementById('photoInput').files[0];
            const w = parseFloat(document.getElementById('weight').value);
            const h = parseFloat(document.getElementById('height').value);
            const dateStr = (new Date()).toISOString();
            const gender = getGender();

            if (isNaN(w) || isNaN(h)) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á"); return; }

            let totalMonths = (yrsInput * 12) + mthsInput;
            if (totalMonths < 0) totalMonths = 0;
            if (totalMonths < 24) { alert("‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏ 2 ‡∏õ‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

            const normYears = Math.floor(totalMonths / 12);
            const normMonths = totalMonths % 12;

            const refs = getRefsFor(gender, totalMonths, h);
            const refWA = refs.refWA;
            const refHA = refs.refHA;
            const refWH = refs.refWH;

            // Calculate Status (guard when refs are missing)
            const statWA = refWA ? evaluateStatus(w, refWA, 'WA') : { t: '-', c: 'bg-gray-100' };
            const statHA = refHA ? evaluateStatus(h, refHA, 'HA') : { t: '-', c: 'bg-gray-100' };
            const statWH = refWH ? evaluateStatus(w, refWH, 'WH') : { t: '-', c: 'bg-gray-100' };

            const record = {
                id: Date.now(),
                date: dateStr,
                ageY: normYears, ageM_Input: normMonths, ageTotalM: totalMonths,
                name: childName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
                classroom: classroom || '',
                gender: gender,
                photo: null,
                w: w, h: h,
                statWA: statWA, statHA: statHA, statWH: statWH
            };
            
            if (photoFile) {
                try {
                    record.photo = await readFileAsDataURL(photoFile);
                } catch (e) { console.warn('Failed to read photo file', e); }
            }

            // --- 1. Show Modal Immediately ---
            showResultModal(record);

            // --- 2. Store pending record but DO NOT send to server yet ---
            // Prepare base64/mime values for later upload
            let photoBase64 = null, photoMime = null;
            if (record.photo && typeof record.photo === 'string') {
                const m = record.photo.match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,(.*)$/);
                if (m) { photoMime = m[1]; photoBase64 = m[2]; }
            }
            pendingRecord = {
                ...record,
                photoBase64,
                photoMime,
                statWA: statWA.t,
                statHA: statHA.t,
                statWH: statWH.t,
                colorWH: statWH.c,
                classroom: classroom || ''
            };
        }

        // --- NEW MODAL & SHARE FUNCTIONS ---

        function showResultModal(data) {
            const modal = document.getElementById('resultModal');
            
            // Populate Data
            const d = new Date(data.date);
            document.getElementById('resDate').innerText = d.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: '2-digit' });
            document.getElementById('resName').innerText = data.name;
            document.getElementById('resAge').innerText = `‡∏≠‡∏≤‡∏¢‡∏∏ ${data.ageY} ‡∏õ‡∏µ ${data.ageM_Input} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            document.getElementById('resWeight').innerText = data.w;
            document.getElementById('resHeight').innerText = data.h;
            
            // Photo handling
            const imgEl = document.getElementById('resPhoto');
            const phEl = document.getElementById('resPhotoPlaceholder');
            if (data.photo) {
                imgEl.src = data.photo;
                imgEl.classList.remove('hidden');
                phEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                phEl.classList.remove('hidden');
            }

            // Set Status & Colors (Updated Code)
            const setStat = (id, statObj) => {
                const el = document.getElementById(id);
                el.innerText = statObj.t;
                // Use the shared status-pill classes from bmi-dashboard for consistent styling
                el.className = `status-pill ${statObj.c}`;
            };
            
            setStat('resStatWH', data.statWH);
            setStat('resStatHA', data.statHA);
            setStat('resStatWA', data.statWA);

            // Show Modal
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        async function shareResult() {
            const captureArea = document.getElementById('captureArea');
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î/‡πÅ‡∏ä‡∏£‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° (‡∏Å‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß)
            const buttons = captureArea.nextElementSibling;
            
            try {
                // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ layout ‡∏ô‡∏¥‡πà‡∏á‡∏™‡∏±‡∏Å‡∏ô‡∏¥‡∏î
                await new Promise(resolve => setTimeout(resolve, 100));

                const canvas = await html2canvas(captureArea, {
                    scale: 3, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (2 ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏ï‡∏Å‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏à‡∏≠, 3 ‡∏ä‡∏±‡∏î‡∏Å‡∏ß‡πà‡∏≤)
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: "#ffffff", // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏†‡∏≤‡∏û‡∏î‡∏≥
                    
                    // --- ‡∏ä‡∏∏‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏Å‡πâ‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô ---
                    scrollY: -window.scrollY, // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏†‡∏≤‡∏û‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£ Scroll
                    windowWidth: document.documentElement.offsetWidth, // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏≠
                    windowHeight: document.documentElement.offsetHeight, // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á
                    x: 0, // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î X (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
                    // --------------------------------
                    
                    onclone: (clonedDoc) => {
                        // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á element ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
                        // ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏ö‡πÄ‡∏á‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
                        const clonedArea = clonedDoc.getElementById('captureArea');
                        if(clonedArea) {
                            clonedArea.style.boxShadow = 'none';
                            clonedArea.style.transform = 'none'; // ‡∏•‡∏ö CSS Transform ‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                        }
                    }
                });

                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
                        return;
                    }

                    const file = new File([blob], "growth_result.png", { type: "image/png" });
                    
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï',
                                text: '‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≠‡∏¢'
                            });
                        } catch (err) {
                            console.log('Error sharing', err);
                            // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô user ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
                        }
                    } else {
                        // Fallback: Download image ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PC ‡∏´‡∏£‡∏∑‡∏≠ Browser ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Share
                        const link = document.createElement('a');
                        link.download = 'growth_result.png';
                        link.href = canvas.toDataURL();
                        link.click();
                    }
                }, 'image/png', 1.0); // 1.0 ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î

            } catch (err) {
                console.error("Capture failed", err);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ: " + err.message);
            }
        }

        // Replace sharing flow: provide Edit and Save actions
        function editResult() {
            // Close modal and allow user to edit inputs again
            closeModal();
            // Focus name input for convenience
            const nameEl = document.getElementById('childName');
            if (nameEl) nameEl.focus();
        }

        function saveAndGoDashboard() {
                    // If there's a pending record, send it to server when user explicitly saves
                    (async () => {
                        if (pendingRecord) {
                            let savedToServer = false;
                            try {
                                const res = await fetch('/api/bmi-record', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(pendingRecord)
                                });
                                if (res && res.ok) savedToServer = true;
                            } catch (e) { console.error('Error saving record to server', e); }

                            // Fallback: persist to localStorage so dashboard can read it offline
                            if (!savedToServer) {
                                try {
                                    const existing = localStorage.getItem('bmiRecords') ? JSON.parse(localStorage.getItem('bmiRecords')) : [];
                                    existing.unshift(pendingRecord);
                                    localStorage.setItem('bmiRecords', JSON.stringify(existing));
                                    console.log('[BMI] saved pending record to localStorage fallback');
                                } catch (le) { console.error('Error saving to localStorage', le); }
                            }

                            pendingRecord = null;
                        }

                        // Navigate to dashboard for overview.
                        // Use a relative file path when running from file://, otherwise use server route
                        try {
                            const dest = (window.location.protocol === 'file:') ? 'bmi-dashboard.html' : '/bmi-dashboard';
                            window.location.href = dest;
                        } catch (e) {
                            try { location.assign((window.location.protocol === 'file:') ? 'bmi-dashboard.html' : '/bmi-dashboard'); } catch(e2) { console.warn('Navigation failed', e2); }
                        }
                    })();
        }

        // Init
        updateTheme();
        const photoInput = document.getElementById('photoInput');
        const photoPreview = document.getElementById('photoPreview');
        if (photoInput && photoPreview) {
            photoInput.addEventListener('change', function(){
                const f = this.files && this.files[0];
                if (!f) { photoPreview.style.display = 'none'; photoPreview.src = ''; return; }
                const fr = new FileReader();
                fr.onload = () => { photoPreview.src = fr.result; photoPreview.style.display = 'block'; };
                fr.readAsDataURL(f);
            });
        }
    </script>
</body>
</html>