<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teachermath Setup</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/teacherpicture.css">
<script src="/js/prevent-image-download.js"></script>
</head>
<body>

<div class="info-section">
    <h1>‡∏™‡∏°‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ä‡πá‡∏Ñ</h1>
  <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
  <div class="form-grid">
    <div class="form-group">
      <label for="weekInput">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</label>
      <input type="text" id="weekInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">
    </div>
    <div class="form-group">
      <label for="topicInput">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
      <input type="text" id="topicInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">
    </div>
    <div class="form-group">
      <label for="unitInput">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
      <input type="text" id="unitInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">
    </div>
    <div class="form-group">
      <label for="teacherInput">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏™‡∏≠‡∏ô</label>
      <input type="text" id="teacherInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">
    </div>
    <div class="form-group">
      <label for="classroomInput">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
      <input type="text" id="classroomInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.1/1, ‡∏°.2/3">
    </div>
    <div class="form-group">
      <label for="userNameInput">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</label>
      <input type="text" id="userNameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
    </div>
  </div>
</div>

<div class="main-container">
  <!-- ‡∏•‡∏ö section ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏≠‡∏≠‡∏Å ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏≠‡∏ö‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
  <h3 style="margin-top:40px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
  <input id="mainTopicInput" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" style="max-width:500px; font-size:18px; padding:12px; border-radius:15px; margin-bottom:20px; background:#fff; border:2px solid #ccc; box-shadow:none; color:#333;"><br>
  <div style="display:flex; gap:5px; justify-content:center; margin-top:20px;">
  <div style="flex:1 1 calc(50% - 12px); max-width:calc(50% - 12px); background:rgba(76, 175, 80, 0.1); padding:12px; border-radius:10px; border:2px solid #4CAF50; text-align:center;">
      <label style="color:#4CAF50; font-weight:bold;">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úÖ</label><br>
      <div class="file-input-wrapper" style="margin-top:10px; display:inline-block;">
        <label class="file-input-label file-input-label-correct">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û
          <input type="file" id="correctImageInput" accept="image/*" onchange="handleImageUpload(event, 'correct')">
        </label>
      </div>
      <div id="correctImagesList" style="margin-top:10px;"></div>
    </div>
  <div style="flex:1 1 calc(50% - 12px); max-width:calc(50% - 12px); background:rgba(244, 67, 54, 0.1); padding:12px; border-radius:10px; border:2px solid #f44336; text-align:center;">
      <label style="color:#f44336; font-weight:bold;">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î ‚ùå</label><br>
      <div class="file-input-wrapper" style="margin-top:10px; display:inline-block;">
        <label class="file-input-label file-input-label-wrong">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û
          <input type="file" id="wrongImageInput" accept="image/*" onchange="handleImageUpload(event, 'wrong')">
        </label>
      </div>
      <div id="wrongImagesList" style="margin-top:10px;"></div>
    </div>
  </div>
</div>

<!-- Control Buttons -->
<div style="display: flex; justify-content: center; gap: 15px; margin: 20px auto; max-width: 900px; flex-wrap: wrap;">
  <button class="neon-btn" onclick="saveConfig()" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
  <button class="neon-btn" onclick="saveActivity()" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
  <button class="neon-btn" onclick="loadActivity()" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
  <button class="neon-btn" onclick="window.location.href='student-reports.html'" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
</div>

<!-- Activity Selection Modal -->
<div id="activityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 30px; border-radius: 20px; max-width: 700px; width: 95%; max-height: 85vh; overflow-y: auto; border: 5px solid #4CAF50;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0; color: #1b5e20;">‚òÅÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå</h2>
      <button onclick="closeActivityModal()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px;">‚úñ</button>
    </div>
    <div id="teacherList"></div>
    <div id="activityList" style="display: none;"></div>
  </div>
</div>

<script type="module">
import { db, saveActivityToFirebase, getAllActivities, deleteActivityFromFirebase } from '/js/firebase-config.js';

let correctImages = [];
let wrongImages = [];

// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å
window.saveActivityToFirebase = saveActivityToFirebase;
window.getAllActivities = getAllActivities;
window.deleteActivityFromFirebase = deleteActivityFromFirebase;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
window.handleImageUpload = function(event, type) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      // Auto crop to square
      const croppedImageData = autoCropToSquare(img);
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå
      if (type === 'correct') {
        correctImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('correct');
      } else {
        wrongImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('wrong');
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function autoCropToSquare(img) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
  const maxSize = 300;
  let width = img.width;
  let height = img.height;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isMobile = window.innerWidth <= 768;

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
  if (!isMobile && (width > maxSize || height > maxSize)) {
    if (width > height) {
      height = (height / width) * maxSize;
      width = maxSize;
    } else {
      width = (width / height) * maxSize;
      height = maxSize;
    }
  }

  canvas.width = width;
  canvas.height = height;

  // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏•‡∏á‡∏ö‡∏ô canvas
  ctx.drawImage(img, 0, 0, width, height);

  // ‡∏ï‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;

  // ‡∏´‡∏≤‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏°‡∏∏‡∏° 4 ‡∏°‡∏∏‡∏°)
  const corners = [
    [0, 0], // ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô
    [width - 1, 0], // ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
    [0, height - 1], // ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á
    [width - 1, height - 1] // ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á
  ];

  let bgColor = null;
  for (let corner of corners) {
    const x = corner[0];
    const y = corner[1];
    const index = (y * width + x) * 4;
    const r = data[index];
    const g = data[index + 1];
    const b = data[index + 2];

    if (r > 200 && g > 200 && b > 200) { // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
      bgColor = { r, g, b };
      break;
    }
  }

  // ‡∏ï‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á)
  if (bgColor) {
    const threshold = 40; // ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏µ
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      // ‡∏ñ‡πâ‡∏≤‡∏™‡∏µ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
      if (
        Math.abs(r - bgColor.r) < threshold &&
        Math.abs(g - bgColor.g) < threshold &&
        Math.abs(b - bgColor.b) < threshold
      ) {
        data[i + 3] = 0; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
      }
    }

    ctx.putImageData(imageData, 0, 0);
  }

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 (‡πÉ‡∏ä‡πâ PNG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)
  return canvas.toDataURL('image/png', 0.9);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
function removeImage(type, index) {
  if (type === 'correct') {
    correctImages.splice(index, 1);
    renderImages('correct');
  } else {
    wrongImages.splice(index, 1);
    renderImages('wrong');
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
function renderImages(type) {
  const listId = type === 'correct' ? 'correctImagesList' : 'wrongImagesList';
  const images = type === 'correct' ? correctImages : wrongImages;
  const list = document.getElementById(listId);
  
  list.innerHTML = images.map((imgData, i) => `
    <div class="image-preview-item">
      <img src="${imgData}" alt="Image ${i+1}">
      <button class="remove-btn" onclick="removeImage('${type}', ${i})">√ó</button>
    </div>
  `).join('');
}

// ‡πÇ‡∏´‡∏•‡∏î config ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
const savedConfig = JSON.parse(localStorage.getItem('emojiGameConfig')||'{}');
if(savedConfig.topic && document.getElementById('topicInput')) document.getElementById('topicInput').value = savedConfig.topic;
if(savedConfig.date && document.getElementById('dateInput')) document.getElementById('dateInput').value = savedConfig.date;
if(savedConfig.correctImages) correctImages = savedConfig.correctImages;
if(savedConfig.wrongImages) wrongImages = savedConfig.wrongImages;
renderImages('correct');
renderImages('wrong');

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
if(!savedConfig.date) {
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('dateInput');
  if(dateInput) dateInput.value = today;
}

// Updated saveConfig to include userName in the saved configuration
function saveConfig() {
  const week = document.getElementById('weekInput')?.value.trim();
  const topic = document.getElementById('topicInput')?.value.trim();
  const unit = document.getElementById('unitInput')?.value.trim();
  const teacher = document.getElementById('teacherInput')?.value.trim();
  const mainTopic = document.getElementById('mainTopicInput')?.value.trim();
  const classroom = document.getElementById('classroomInput')?.value.trim();
  const userName = document.getElementById('userNameInput')?.value.trim();

  // Allow saving even when some fields are empty ‚Äî use sensible defaults
  const cfgWeek = week || '-';
  const cfgTopic = topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUnit = unit || '-';
  const cfgTeacher = teacher || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgMainTopic = mainTopic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUserName = userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  if (correctImages.length === 0) console.warn('[SAVE CONFIG] saving with 0 correctImages');
  if (wrongImages.length === 0) console.warn('[SAVE CONFIG] saving with 0 wrongImages');

  // Save config (accept empty image lists)
  const config = {
    week: cfgWeek,
    topic: cfgTopic,
    unit: cfgUnit,
    teacher: cfgTeacher,
    mainTopic: cfgMainTopic,
    classroom: classroom || '',
    userName: cfgUserName,
    correctImages: correctImages || [],
    wrongImages: wrongImages || []
  };
  localStorage.setItem('emojiGameConfig', JSON.stringify(config));

  window.location.href = 'gamepicture.html';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Cloud)
async function saveActivity() {
  const week = document.getElementById('weekInput')?.value.trim();
  const topic = document.getElementById('topicInput')?.value.trim();
  const unit = document.getElementById('unitInput')?.value.trim();
  const teacher = document.getElementById('teacherInput')?.value.trim();
  const mainTopic = document.getElementById('mainTopicInput')?.value.trim();
  const classroom = document.getElementById('classroomInput')?.value.trim();
  const userName = document.getElementById('userNameInput')?.value.trim();

  if (!teacher) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
    return;
  }

  const cfgWeek = week || '-';
  const cfgTopic = topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUnit = unit || '-';
  const cfgTeacher = teacher;
  const cfgMainTopic = mainTopic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUserName = userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  if (correctImages.length === 0 && wrongImages.length === 0) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
    return;
  }

  // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
  if (window.editingCloudActivity) {
    const { teacherName, activityId } = window.editingCloudActivity;
    try {
      const res = await fetch(`/api/settings/picture/${encodeURIComponent(teacherName)}/${activityId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: window.editingCloudActivityName || `${cfgMainTopic} - ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${cfgWeek}`,
          config: {
            week: cfgWeek,
            topic: cfgTopic,
            unit: cfgUnit,
            teacher: cfgTeacher,
            mainTopic: cfgMainTopic,
            classroom: classroom || '',
            userName: cfgUserName,
            correctImages: correctImages,
            wrongImages: wrongImages
          }
        })
      });
      if (!res.ok) throw new Error('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      alert('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      delete window.editingCloudActivity;
      delete window.editingCloudActivityName;
      return;
    } catch (err) {
      alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      return;
    }
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
  const activityName = prompt('‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:', `${cfgMainTopic} - ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${cfgWeek}`);
  if (!activityName) return;

  try {
    const res = await fetch('/api/settings/picture', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        teacherName: cfgTeacher,
        name: activityName,
        config: {
          week: cfgWeek,
          topic: cfgTopic,
          unit: cfgUnit,
          teacher: cfgTeacher,
          mainTopic: cfgMainTopic,
          classroom: classroom || '',
          userName: cfgUserName,
          correctImages: correctImages,
          wrongImages: wrongImages
        }
      })
    });
    if (!res.ok) throw new Error('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const data = await res.json();
    alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™: ${data.data?.activityId || '-'}`);
  } catch (err) {
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
async function loadActivity() {
  const teacherList = document.getElementById('teacherList');
  const activityList = document.getElementById('activityList');
  teacherList.innerHTML = '<p style="text-align:center;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå...</p>';
  activityList.style.display = 'none';
  document.getElementById('activityModal').style.display = 'flex';

  try {
    const res = await fetch('/api/settings/picture');
    if (!res.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const result = await res.json();
    const activities = result.data || [];

    const teacherMap = {};
    activities.forEach(a => {
      if (!teacherMap[a.teacherName]) teacherMap[a.teacherName] = [];
      teacherMap[a.teacherName].push(a);
    });

    const teachers = Object.keys(teacherMap);
    if (teachers.length === 0) {
      teacherList.innerHTML = '<p style="text-align:center; color:#666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ö‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå</p>';
      return;
    }

    teacherList.innerHTML = `
      <h3 style="margin: 0 0 15px 0; color: #2e7d32;">üë©‚Äçüè´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
        ${teachers.map(t => `
          <div onclick="showTeacherActivities('${encodeURIComponent(t)}')" 
               style="background: white; padding: 15px; border-radius: 10px; cursor: pointer; border: 3px solid #4CAF50; transition: all 0.2s;"
               onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
            <div style="font-size: 18px; font-weight: bold; color: #1b5e20;">üë§ ${t}</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">${teacherMap[t].length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
          </div>
        `).join('')}
      </div>
    `;
    window.cloudTeacherMap = teacherMap;
  } catch (err) {
    teacherList.innerHTML = `<p style="text-align:center; color:red;">‚ùå ${err.message}</p>`;
  }
}

function showTeacherActivities(encodedTeacherName) {
  const teacherName = decodeURIComponent(encodedTeacherName);
  const activities = window.cloudTeacherMap[teacherName] || [];
  const teacherList = document.getElementById('teacherList');
  const activityList = document.getElementById('activityList');

  teacherList.style.display = 'none';
  activityList.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <h3 style="margin: 0; color: #2e7d32;">üñºÔ∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á ${teacherName}</h3>
      <button onclick="backToTeacherList()" style="background: #607d8b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
    <div style="display: grid; gap: 10px;">
      ${activities.map(a => `
        <div style="background: white; padding: 15px; border-radius: 10px; border: 3px solid #4CAF50;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin: 0 0 8px 0; color: #1b5e20; font-size: 16px;">üñºÔ∏è ${a.name}</h4>
              <p style="margin: 4px 0; font-size: 13px; color: #666;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${a.config?.mainTopic || '-'}</p>
              <p style="margin: 4px 0; font-size: 13px; color: #666;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: ${a.config?.week || '-'}</p>
              <p style="margin: 4px 0; font-size: 13px; color: #4CAF50; font-weight: bold;">‡∏£‡∏π‡∏õ‡∏ñ‡∏π‡∏Å: ${a.config?.correctImages?.length || 0} / ‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î: ${a.config?.wrongImages?.length || 0}</p>
              <p style="margin: 4px 0; font-size: 11px; color: #999;">‡∏£‡∏´‡∏±‡∏™: ${a.activityId}</p>
              <p style="margin: 4px 0; font-size: 11px; color: #888;">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${a.createdAtThai || a.updatedAtThai || '-'}</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="playCloudActivity('${encodeURIComponent(teacherName)}', ${a.activityId})" 
                      style="background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô</button>
              <button onclick="editCloudActivity('${encodeURIComponent(teacherName)}', ${a.activityId})" 
                      style="background: #2196F3; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button onclick="deleteCloudActivity('${encodeURIComponent(teacherName)}', ${a.activityId})" 
                      style="background: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;">üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
  `;
  activityList.style.display = 'block';
}

function backToTeacherList() {
  document.getElementById('activityList').style.display = 'none';
  document.getElementById('teacherList').style.display = 'block';
}

function playCloudActivity(encodedTeacherName, activityId) {
  const teacherName = decodeURIComponent(encodedTeacherName);
  const activities = window.cloudTeacherMap[teacherName] || [];
  const activity = activities.find(a => a.activityId === activityId);
  if (!activity) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ'); return; }
  localStorage.setItem('emojiGameConfig', JSON.stringify(activity.config));
  window.location.href = 'gamepicture.html';
}

function editCloudActivity(encodedTeacherName, activityId) {
  const teacherName = decodeURIComponent(encodedTeacherName);
  const activities = window.cloudTeacherMap[teacherName] || [];
  const activity = activities.find(a => a.activityId === activityId);
  if (!activity) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ'); return; }

  const config = activity.config || {};
  if(document.getElementById('weekInput')) document.getElementById('weekInput').value = config.week || '';
  if(document.getElementById('topicInput')) document.getElementById('topicInput').value = config.topic || '';
  if(document.getElementById('unitInput')) document.getElementById('unitInput').value = config.unit || '';
  if(document.getElementById('teacherInput')) document.getElementById('teacherInput').value = config.teacher || '';
  if(document.getElementById('mainTopicInput')) document.getElementById('mainTopicInput').value = config.mainTopic || '';
  if(document.getElementById('userNameInput')) document.getElementById('userNameInput').value = config.userName || '';

  correctImages = config.correctImages || [];
  wrongImages = config.wrongImages || [];
  renderImages('correct');
  renderImages('wrong');

  window.editingCloudActivity = { teacherName, activityId };
  window.editingCloudActivityName = activity.name;

  closeActivityModal();
  alert(`üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activity.name}"\n\n‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó`);
}

async function deleteCloudActivity(encodedTeacherName, activityId) {
  const teacherName = decodeURIComponent(encodedTeacherName);
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏£‡∏´‡∏±‡∏™ ${activityId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  try {
    const res = await fetch(`/api/settings/picture/${encodeURIComponent(teacherName)}/${activityId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    alert('‚úÖ ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    loadActivity();
  } catch (err) {
    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
  }
}

// ‡∏õ‡∏¥‡∏î Modal
function closeActivityModal() {
  document.getElementById('activityModal').style.display = 'none';
}

// ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å
window.handleImageUpload = handleImageUpload;
window.removeImage = removeImage;
window.saveConfig = saveConfig;
window.saveActivity = saveActivity;
window.loadActivity = loadActivity;
window.playCloudActivity = playCloudActivity;
window.editCloudActivity = editCloudActivity;
window.deleteCloudActivity = deleteCloudActivity;
window.showTeacherActivities = showTeacherActivities;
window.backToTeacherList = backToTeacherList;
window.closeActivityModal = closeActivityModal;

</script>

<!-- Socket client (connect + heartbeat) -->
<script src="/socket.io/socket.io.js"></script>
<script src="/socket-client.js"></script>
<script>
// ‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (teacherpicture)
var __localUsageId_teacherpicture = null;
window.addEventListener('load', function(){
  try{
    if (window.usageTracker && typeof window.usageTracker.start === 'function') {
      __localUsageId_teacherpicture = window.usageTracker.start(location.pathname || 'teacherpicture.html', 'teacher-config');
      console.log('usage started (teacherpicture)', __localUsageId_teacherpicture);
    }
  }catch(e){ console.warn('usage start failed', e); }
});
window.addEventListener('beforeunload', function(){
  try{
    if (window.usageTracker && typeof window.usageTracker.end === 'function') {
      window.usageTracker.end(__localUsageId_teacherpicture, location.pathname, 'teacher-config');
    }
  }catch(e){}
});
</script>
<script>
  try { localStorage.setItem('lastVisitedPage', location.pathname + location.search + location.hash); } catch(e){}
</script>
</body>
</html>