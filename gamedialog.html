<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏Å‡∏°‡∏ù‡∏∂‡∏Å‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/gamedialog.css">
<script src="/js/prevent-image-download.js"></script>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1 id="activityTitle">‡∏ù‡∏∂‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h1>
      <div id="contextInfo" style="display: none; background: #fff3e0; padding: 12px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ff9800;">
        <strong id="contextTitle" style="color: #e65100; display: block; margin-bottom: 5px;"></strong>
        <p id="contextDescription" style="margin: 0; color: #666; font-size: 14px;"></p>
      </div>
      <div class="info">
        <span id="topicDisplay">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: -</span>
        <span id="progressDisplay">‡∏ö‡∏ó‡∏ó‡∏µ‡πà: 0/0</span>
      </div>
    </div>
 </div>

  <!-- Dialog Display Area -->
  <div class="dialog-area">
    <div class="dialog-container" id="dialogContainer">
      <div class="character-left" id="characterLeft">
        <img src="picture/RM.png" alt="RM Character" class="character-img">
        <p id="characterLeftName" style="margin-top: 8px; font-weight: bold; color: #4CAF50; font-size: 16px;">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ã‡πâ‡∏≤‡∏¢</p>
      </div>
      
      <div class="dialog-content" id="dialogContent">
        <div class="speech-bubble left" id="speechBubble">
          <p class="dialog-text-thai" id="dialogTextThai">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</p>
          <p class="dialog-text-english" id="dialogTextEnglish"></p>
        </div>
      </div>
      
      <div class="character-right" id="characterRight">
        <img src="picture/WL.png" alt="WL Character" class="character-img">
        <p id="characterRightName" style="margin-top: 8px; font-weight: bold; color: #FF6B9D; font-size: 16px;">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏ß‡∏≤</p>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button class="btn-control btn-prev" id="btnPrev" onclick="previousDialog()" disabled>
     <
    </button>
    
    <button class="btn-control btn-start" id="btnStart" onclick="startGame()">
      ‚ñ∂
    </button>
    
    <button class="btn-control btn-next" id="btnNext" onclick="nextDialog()" style="display:none;">
      >
    </button>
    
    <button class="btn-control" id="btnRepeat" onclick="repeatDialog()" style="display:none; background: linear-gradient(135deg, #7d4a16 0%, #7d4a16  100%);">
      ‚ü≤‚ñ∂
    </button>
    
    <button class="btn-control btn-restart" id="btnRestart" onclick="restartGame()" style="display:none;">
      ‚Üª
    </button>
  </div>
  
  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill"></div>
  </div>
</div>

<script>
console.log('üöÄ gamedialog.html loaded');

let config = null;
let dialogs = [];
let currentIndex = -1;
let gameStarted = false;

// ‡πÇ‡∏´‡∏•‡∏î config
function loadConfig() {
  const configStr = localStorage.getItem('thaiDialogConfig');
  if (!configStr) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà');
    window.location.href = 'teacherthai.html';
    return false;
  }
  
  config = JSON.parse(configStr);
  dialogs = config.dialogs || [];
  
  if (dialogs.length === 0) {
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤');
    window.location.href = 'teacherthai.html';
    return false;
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• header
  document.getElementById('activityTitle').textContent = config.topic || '‡∏ù‡∏∂‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤';
  document.getElementById('topicDisplay').textContent = `‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${config.topic || '-'}`;
  document.getElementById('progressDisplay').textContent = `‡∏ö‡∏ó‡∏ó‡∏µ‡πà: 0/${dialogs.length}`;
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
  if (config.characterLeftName) {
    document.getElementById('characterLeftName').textContent = config.characterLeftName;
  }
  if (config.characterRightName) {
    document.getElementById('characterRightName').textContent = config.characterRightName;
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏£‡∏¥‡∏ö‡∏ó (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (config.contextTitle || config.contextDescription) {
    const contextInfo = document.getElementById('contextInfo');
    const contextTitle = document.getElementById('contextTitle');
    const contextDescription = document.getElementById('contextDescription');
    
    if (config.contextTitle) {
      contextTitle.textContent = 'üìå ' + config.contextTitle;
    }
    if (config.contextDescription) {
      contextDescription.textContent = config.contextDescription;
    }
    contextInfo.style.display = 'block';
  }
  
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (config.backgroundImage) {
    const dialogArea = document.querySelector('.dialog-area');
    dialogArea.style.backgroundImage = `url(${config.backgroundImage})`;
    dialogArea.style.backgroundSize = 'cover';
    dialogArea.style.backgroundPosition = 'center';
    dialogArea.style.backgroundRepeat = 'no-repeat';
    dialogArea.style.backgroundAttachment = 'scroll';
    dialogArea.style.imageRendering = 'high-quality';
    console.log('üñºÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
  
  console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î config ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', config);
  console.log('üìã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:', dialogs.length);
  
  return true;
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
function startGame() {
  gameStarted = true;
  currentIndex = 0;
  
  // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
  document.getElementById('btnStart').style.display = 'none';
  document.getElementById('btnNext').style.display = 'inline-block';
  document.getElementById('btnRepeat').style.display = 'inline-block';
  document.getElementById('btnRestart').style.display = 'inline-block';
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÅ‡∏£‡∏Å
  showDialog(currentIndex);
}

// ‡∏ü‡∏±‡∏á‡∏ã‡πâ‡∏≥
function repeatDialog() {
  if (currentIndex >= 0 && currentIndex < dialogs.length) {
    const dialog = dialogs[currentIndex];
    playDialogSound(dialog);
  }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
function showDialog(index) {
  if (index < 0 || index >= dialogs.length) return;
  
  const dialog = dialogs[index];
  const characterLeft = document.getElementById('characterLeft');
  const characterRight = document.getElementById('characterRight');
  const speechBubble = document.getElementById('speechBubble');
  const dialogTextThai = document.getElementById('dialogTextThai');
  const dialogTextEnglish = document.getElementById('dialogTextEnglish');
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
  document.getElementById('progressDisplay').textContent = `‡∏ö‡∏ó‡∏ó‡∏µ‡πà: ${index + 1}/${dialogs.length}`;
  updateProgressBar();
  
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á speech bubble ‡πÅ‡∏•‡∏∞ highlight ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
  const isLeft = dialog.position === 'left';
  if (isLeft) {
    // ‡∏ã‡πâ‡∏≤‡∏¢‡∏û‡∏π‡∏î
    speechBubble.className = 'speech-bubble left';
    characterLeft.classList.add('active');
    characterRight.classList.remove('active');
  } else {
    // ‡∏Ç‡∏ß‡∏≤‡∏û‡∏π‡∏î
    speechBubble.className = 'speech-bubble right';
    characterLeft.classList.remove('active');
    characterRight.classList.add('active');
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
  dialogTextThai.textContent = dialog.text;
  dialogTextEnglish.style.display = 'none';
  
  // Animation
  speechBubble.style.animation = 'none';
  setTimeout(() => {
    speechBubble.style.animation = 'fadeIn 0.5s ease-in-out';
  }, 10);
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏õ‡∏∏‡πà‡∏°
  document.getElementById('btnPrev').disabled = (index === 0);
  document.getElementById('btnNext').disabled = (index === dialogs.length - 1);
  
  // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  playDialogSound(dialog);
}

// ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
function nextDialog() {
  if (currentIndex < dialogs.length - 1) {
    currentIndex++;
    showDialog(currentIndex);
  } else {
    // ‡∏à‡∏ö‡πÄ‡∏Å‡∏°
    showCompletionMessage();
  }
}

// ‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
function previousDialog() {
  if (currentIndex > 0) {
    currentIndex--;
    showDialog(currentIndex);
  }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà
function restartGame() {
  currentIndex = 0;
  showDialog(currentIndex);
}

// ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Progress Bar
function updateProgressBar() {
  const progress = ((currentIndex + 1) / dialogs.length) * 100;
  document.getElementById('progressFill').style.width = progress + '%';
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏Å‡∏°
function showCompletionMessage() {
  const dialogTextThai = document.getElementById('dialogTextThai');
  const dialogTextEnglish = document.getElementById('dialogTextEnglish');
  
  dialogTextThai.textContent = '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏≠‡πà‡∏≤‡∏ô‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ö‡∏ó‡πÅ‡∏•‡πâ‡∏ß';
  dialogTextEnglish.style.display = 'none';
  
  document.getElementById('characterLeft').classList.add('active');
  document.getElementById('characterRight').classList.add('active');
  
  document.getElementById('btnNext').disabled = true;
}

// ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á TTS
let speechSynthesis = window.speechSynthesis;
let currentUtterance = null;
let speechRate = 0.9; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ñ‡∏á‡∏ó‡∏µ‡πà

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô
function splitSentences(text) {
  // ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å
  const sentences = [];
  let current = '';
  
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const nextChar = i < text.length - 1 ? text[i + 1] : '';
    
    current += char;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const isFullStop = char === '.' || char === '?' || char === '!' || char === '„ÄÇ'; // ‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ
    const isComma = char === ',' || char === '„ÄÅ'; // ‡∏à‡∏∏‡∏•‡∏†‡∏≤‡∏Ñ
    const isPunctuation = isFullStop || isComma;
    
    // ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏£‡∏£‡∏Ñ‡∏ï‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
    const shouldSplit = isPunctuation && (nextChar === '' || nextChar === ' ' || nextChar === '\n');
    
    if (shouldSplit) {
      const sentence = current.trim();
      if (sentence) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° ... ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ TTS ‡∏´‡∏¢‡∏∏‡∏î‡∏û‡∏±‡∏Å‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏à‡∏ö)
        if (isFullStop) {
          sentences.push(sentence + '...');
        } else {
          sentences.push(sentence + '.');
        }
      }
      current = '';
    }
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  if (current.trim()) {
    sentences.push(current.trim() + '...');
  }
  
  return sentences.length > 0 ? sentences : [text];
}

function playDialogSound(dialog) {
  // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (currentUtterance) {
    speechSynthesis.cancel();
    currentUtterance = null;
  }
  
  // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á TTS
  if (dialog.text && speechSynthesis) {
    try {
      // ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÜ
      const sentences = splitSentences(dialog.text);
      console.log('üìù ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ:', sentences.length, '‡∏™‡πà‡∏ß‡∏ô');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á queue ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡πà‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
      let currentIndex = 0;
      
      function speakNext() {
        if (currentIndex >= sentences.length) {
          console.log('‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ');
          return;
        }
        
        const sentence = sentences[currentIndex];
        if (!sentence.trim()) {
          currentIndex++;
          speakNext();
          return;
        }
        
        currentUtterance = new SpeechSynthesisUtterance(sentence);
        
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        currentUtterance.lang = 'th-TH';
        currentUtterance.rate = speechRate * 0.75; // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•
        currentUtterance.volume = 1;
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î pitch ‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥)
        const voiceType = dialog.voiceType || (dialog.position === 'left' ? 'male' : 'female');
        let pitch = 1.0;
        if (voiceType === 'male') {
          pitch = 0.9; // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ö‡∏™‡∏•‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
        } else if (voiceType === 'female') {
          pitch = 1.05; // ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
        } else if (voiceType === 'female-soft') {
          pitch = 1.0;
        } else if (voiceType === 'female-high') {
          pitch = 1.15;
        }
        currentUtterance.pitch = pitch;
        
        // ‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
        const voices = speechSynthesis.getVoices();
        const thaiVoices = voices.filter(v => v.lang.includes('th') || v.lang.includes('TH'));
        
        let selectedVoice = null;
        
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏ó‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏® (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î)
        if (thaiVoices.length > 0) {
          if (voiceType.startsWith('female')) {
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô
            selectedVoice = thaiVoices.find(v => 
              v.name.toLowerCase().includes('female') || 
              v.name.toLowerCase().includes('woman') ||
              v.name.includes('Kanya') ||
              v.name.includes('Premwadee')
            );
          } else if (voiceType === 'male') {
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô
            selectedVoice = thaiVoices.find(v => 
              v.name.toLowerCase().includes('male') || 
              v.name.toLowerCase().includes('man') ||
              v.name.includes('Pattara')
            );
          }
          
          // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏ó‡∏¢‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ
          if (!selectedVoice) {
            selectedVoice = thaiVoices[0];
          }
        }
        
        if (selectedVoice) {
          currentUtterance.voice = selectedVoice;
          console.log(`üé§ ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${selectedVoice.name} (${voiceType}, pitch: ${currentUtterance.pitch})`);
        } else {
          console.log(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (${voiceType}, pitch: ${currentUtterance.pitch})`);
        }
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        currentUtterance.onend = function() {
          currentIndex++;
          
          // ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡πà‡∏ß‡∏á 500ms ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•
          if (currentIndex < sentences.length) {
            setTimeout(speakNext, 500);
          }
        };
        
        currentUtterance.onerror = function(event) {
          console.error('TTS Error:', event);
          currentIndex++;
          speakNext();
        };
        
        // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        speechSynthesis.speak(currentUtterance);
        console.log(`üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${currentIndex + 1}/${sentences.length} (${voiceType}):`, sentence);
      }
      
      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÅ‡∏£‡∏Å
      speakNext();
      
    } catch (err) {
      console.log('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ:', err);
    }
  }
}

// ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î
window.addEventListener('load', () => {
  // ‡∏£‡∏≠‡πÉ‡∏´‡πâ voices ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  if (speechSynthesis.getVoices().length === 0) {
    speechSynthesis.addEventListener('voiceschanged', () => {
      const voices = speechSynthesis.getVoices();
      console.log('üì¢ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ:', voices.length, '‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
      const thaiVoices = voices.filter(v => v.lang.includes('th') || v.lang.includes('TH'));
      console.log('üáπüá≠ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢:', thaiVoices.length, '‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
    });
  }
});

// ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
function goHome() {
  // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å
  if (speechSynthesis) {
    speechSynthesis.cancel();
  }
  
  if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    window.location.href = 'teacherthai.html';
  }
}

// ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
window.addEventListener('beforeunload', () => {
  if (speechSynthesis) {
    speechSynthesis.cancel();
  }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (!gameStarted) return;
  
  if (e.key === 'ArrowRight' || e.key === ' ') {
    e.preventDefault();
    if (currentIndex < dialogs.length - 1) nextDialog();
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    if (currentIndex > 0) previousDialog();
  } else if (e.key === 'r' || e.key === 'R') {
    restartGame();
  }
});

// ‡πÇ‡∏´‡∏•‡∏î config ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î
window.addEventListener('load', () => {
  if (loadConfig()) {
    console.log('‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°');
  }
});
</script>

<!-- Socket client -->
<script src="/socket.io/socket.io.js"></script>
<script src="/socket-client.js"></script>
<script>
  try { localStorage.setItem('lastVisitedPage', location.pathname + location.search + location.hash); } catch(e){}
</script>
<script>
var __localUsageId_gamedialog = null;
window.addEventListener('load', function(){
  try{
    if(typeof io === 'undefined') return;
    const socket = io();
    socket.emit('usageStart', { page: 'gamedialog.html', params: {} }, function(resp){
      if(resp && resp.usageId) __localUsageId_gamedialog = resp.usageId;
    });
  }catch(e){ console.warn('usageTracker.start failed (gamedialog)', e); }
});
window.addEventListener('beforeunload', function(){
  try{
    if(typeof io === 'undefined' || !__localUsageId_gamedialog) return;
    const socket = io();
    socket.emit('usageEnd', { usageId: __localUsageId_gamedialog });
  }catch(e){}
});
</script>
</body>
</html>
