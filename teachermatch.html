<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teachermath Setup</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/teachermatch.css">
<script src="/js/prevent-image-download.js"></script>
<style>
/* Custom Alert Modal */
.custom-alert-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}
.custom-alert-overlay.show {
  display: flex;
}
.custom-alert-box {
  background: white;
  border-radius: 15px;
  padding: 30px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: alertSlideIn 0.3s ease;
}
@keyframes alertSlideIn {
  from { transform: translateY(-20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
.custom-alert-message {
  font-size: 18px;
  color: #333;
  margin-bottom: 20px;
  line-height: 1.5;
}
.custom-alert-btn {
  background: linear-gradient(180deg, #57e167 0%, #57e167 100%);
  color: #000;
  border: 3px solid #74640a;
  padding: 12px 40px;
  border-radius: 25px;
  font-size: 16px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.custom-alert-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 15px rgba(87, 225, 103, 0.4);
}
</style>
<style>
* {
  font-family: 'Roboto', sans-serif !important;
}
body {
  text-align: center;
  margin: 0;
  padding: 20px;
  position: relative;
  min-height: 100vh;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}

body::before {
  content: '';
  position: fixed;
  top: 0; 
  left: 0; 
  right: 0; 
  bottom: 0;
  background: linear-gradient(to bottom, #ebd09e 0%, #251f03 100%);
  z-index: -1;
}
input, button { font-size:16px; margin:5px; padding:10px; text-transform: lowercase; border-radius:15px; border:2px solid #ccc; }
textarea {
  font-size:16px; margin:5px; padding:10px; width:250px; height:120px; resize:none;
  border:2px solid #ccc; border-radius:15px;
  background: repeating-linear-gradient(
    to bottom,
    #fff,
    #fff 28px,
    #ccc 28px,
    #ccc 30px
  );
  line-height:30px;
  text-transform: lowercase; /* ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å */
}
button { cursor:pointer; }
.image-preview-item {
  display: inline-block;
  margin: 10px;
  position: relative;
  border: 2px solid #ddd;
  border-radius: 10px;
  overflow: hidden;
  width: 120px;
  height: 120px;
  background: repeating-conic-gradient(#ddd 0% 25%, transparent 0% 50%) 50% / 20px 20px;
}
.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.image-preview-item .remove-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  font-size: 16px;
  line-height: 1;
}
.file-input-wrapper {
  position: relative;
  display: inline-block;
  margin: 10px;
}
.file-input-wrapper input[type=file] {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.neon-btn-green, .file-input-label {
  background: linear-gradient(180deg, #57e167 0%, #57e167 45%, #57e167 55%, #57e167 100%);
  color: #000000;
  border: 6px solid #74640a;
  border-radius: 9999px;
  box-shadow: 1px 1px 0 #000, -8px 6px #3b3305, 0 0 20px rgba(255,230,160,0.55);
  font-weight: 700;
  font-size: clamp(1rem, 2vw, 1.5rem);
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3), 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  padding: clamp(14px, 2.5vw, 20px) clamp(35px, 5vw, 50px);
  transform: translateZ(0);
  transition: all 0.3s ease;
  z-index: 10;
  min-height: 55px;
  display: inline-block;
  cursor: pointer;
}

/* Neon Button Style */
.neon-btn, .file-input-label {
  background: linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
  color: #000000;
  border: 6px solid #74640a;
  border-radius: 9999px;
  box-shadow: 1px 1px 0 #000, -8px 6px #3b3305, 0 0 20px rgba(255,230,160,0.55);
  font-weight: 700;
  font-size: clamp(1rem, 2vw, 1.5rem);
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3), 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  padding: clamp(14px, 2.5vw, 20px) clamp(35px, 5vw, 50px);
  transform: translateZ(0);
  transition: all 0.3s ease;
  z-index: 10;
  min-height: 55px;
  display: inline-block;
  cursor: pointer;
}

.neon-btn:hover, .file-input-label:hover {
  transform: translateY(-2px);
  box-shadow: 2px 2px 0 #000, -10px 8px #3b3305, 0 0 25px rgba(255,230,160,0.75);
}

.file-input-label {
  padding: 10px 20px;
  font-size: 16px;
}
.choice-item {
  background: #f0f0f0;
  padding: 8px;
  margin: 5px 0;
  border-radius: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.choice-item button {
  background: #f44336;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
}

/* Responsive Design */
.form-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 20px 0;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  font-weight: 600;
  color: #333;
  font-size: 14px;
}

.form-group input {
  padding: 10px;
  border: 2px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
}

.info-inputs {
  display: flex;
  gap: 5px;
  justify-content: center;
  margin: 10px 0 20px 0;
  flex-wrap: wrap;
}

.info-inputs input {
  width: 120px;
  font-size: 16px;
  padding: 10px;
  border-radius: 15px;
}

.info-inputs input:nth-child(1) {
  width: 120px;
}

.info-inputs input:nth-child(2),
.info-inputs input:nth-child(3),
.info-inputs input:nth-child(4),
.info-inputs input:nth-child(5),
.info-inputs input:nth-child(6) {
  width: 180px;
}

.main-container {
  max-width: 900px;
  width: 100%;
  background: rgba(255,255,255,0.9);
  padding: 20px;
  border-radius: 10px;
  border: 4px solid #74640a;
  box-shadow: 0 0 15px rgba(255,230,160,0.5), 1px 1px 0 #000, -6px 4px #3b3305;
}

/* Mobile: < 768px */
@media (max-width: 767px) {
  .form-grid {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  
  .form-group label {
    font-size: 14px;
  }
  
  .form-group input {
    font-size: 16px;
    padding: 10px;
  }
  
  body {
    padding: 5px;
  }
  
  h2 {
    font-size: 18px;
    margin: 10px 0;
  }
  
  h3 {
    font-size: 16px;
    margin: 10px 0;
  }
  
  .info-section {
  padding: 10px 15px !important;
  max-width: 91% !important;
  width: 91% !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
  
  .info-inputs {
    gap: 3px;
  }
  
  .info-inputs input {
    width: calc(50% - 3px) !important;
    font-size: 12px !important;
    padding: 6px !important;
    box-sizing: border-box;
  }
  
  .main-container {
    padding: 6px;
    max-width: 85%;
    width: 85%;
    border: 3px solid #74640a;
  }
  
  .main-container input {
    font-size: 14px !important;
    padding: 6px !important;
    max-width: 100% !important;
  }
  
  .main-container label {
    font-size: 12px !important;
  }
  
  .main-container > div[style*="display:flex"] {
    flex-direction: column;
    gap: 6px !important;
  }
  
  .main-container > div[style*="display:flex"] > div {
    width: calc(100% - 4px) !important;
    padding: 6px !important;
    box-sizing: border-box !important;
    max-width: 100% !important;
    margin: 0 2px !important;
  }
  
  .main-container > div[style*="display:flex"] > div input {
    max-width: calc(100% - 4px) !important;
    width: calc(100% - 4px) !important;
    box-sizing: border-box !important;
  }
  
  .neon-btn, .neon-btn-green {
    font-size: 12px !important;
    padding: 6px 12px !important;
    min-height: 35px !important;
  }
}

/* Tablet: 768px - 1024px */
@media (min-width: 768px) and (max-width: 1024px) {
  .info-inputs input:nth-child(1) {
    width: 100px;
  }
  
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 150px;
  }
}

/* Desktop: > 1024px */
@media (min-width: 1025px) {
  .info-inputs input:nth-child(1) {
    width: 120px;
  }
  
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 180px;
  }
}

.info-section {
  background: rgba(255,255,255,0.9);
  padding: 20px;
  border-radius: 10px;
  border: 4px solid #74640a;
  box-shadow: 0 0 15px rgba(255,230,160,0.5), 1px 1px 0 #000, -6px 4px #3b3305;
  margin-bottom: 20px;
  max-width: 900px;
  width: 100%;
}

.info-section h1 {
  margin-top: 0;
  margin-bottom: 10px;
}

.info-section h2 {
  margin-top: 0;
}

.section-title {
  font-size: 18px;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
}

.image-preview {
  max-width: 200px;
  max-height: 200px;
  border: 2px solid #ddd;
  border-radius: 8px;
  margin: 5px;
}

.remove-image-btn {
  background: #f44336;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
  margin-top: 5px;
}
</style>
</head>
<body>

<!-- Custom Alert Modal -->
<div id="customAlertOverlay" class="custom-alert-overlay" onclick="closeCustomAlert(event)">
  <div class="custom-alert-box" onclick="event.stopPropagation()">
    <div id="customAlertMessage" class="custom-alert-message"></div>
    <button class="custom-alert-btn" onclick="closeCustomAlert()">‡∏ï‡∏Å‡∏•‡∏á</button>
  </div>
</div>

<script>
function showCustomAlert(message) {
  document.getElementById('customAlertMessage').innerHTML = message;
  document.getElementById('customAlertOverlay').classList.add('show');
}
function closeCustomAlert(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('customAlertOverlay').classList.remove('show');
}
</script>

<div class="info-section">
  <h1>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏•‡∏Ç</h1>
  <h2 class="section-title">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
  
  <div class="form-grid">
    <div class="form-group">
      <label for="weekInput">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà</label>
      <input type="text" id="weekInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">
    </div>
    <div class="form-group">
      <label for="topicInput">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
      <input type="text" id="topicInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
    </div>
    <div class="form-group">
      <label for="unitInput">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
      <input type="text" id="unitInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ">
    </div>
    <div class="form-group">
      <label for="teacherInput">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</label>
      <input type="text" id="teacherInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">
    </div>
    <div class="form-group">
      <label for="gradeSelect">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
      <select id="gradeSelect">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option>
        <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1</option>
        <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2</option>
        <option value="‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3">‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3</option>
        <option value="‡∏õ.1">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1</option>
        <option value="‡∏õ.2">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2</option>
        <option value="‡∏õ.3">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3</option>
        <option value="‡∏õ.4">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>
        <option value="‡∏õ.5">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>
        <option value="‡∏õ.6">‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>
        <option value="‡∏°.1">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1</option>
        <option value="‡∏°.2">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2</option>
        <option value="‡∏°.3">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3</option>
        <option value="‡∏°.4">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4</option>
        <option value="‡∏°.5">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5</option>
        <option value="‡∏°.6">‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6</option>
      </select>
    </div>
    <div class="form-group">
      <label for="roomInput">‡∏´‡πâ‡∏≠‡∏á</label>
      <input type="text" id="roomInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1, 2, 3...">
    </div>
    <input type="hidden" id="classroomInput">
    <div class="form-group">
      <label for="userNameInput">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</label>
      <input type="text" id="userNameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
    </div>
  </div>
</div>

<!-- Mode Selection -->
<div style="display: flex; justify-content: center; gap: 20px; margin: 20px auto; max-width: 900px; flex-wrap: wrap;">
  <button id="modeQuestion" class="neon-btn-green" onclick="switchMode('question')" style="font-size: 18px; padding: 15px 30px;">‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>
  <button id="modeCount" class="neon-btn" onclick="switchMode('count')" style="font-size: 18px; padding: 15px 30px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö</button>
</div>

<!-- Question Mode -->
<div id="questionMode" class="main-container">
  <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</h3>
  <input id="questionInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏•‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô 2 + 2)" style="max-width:500px; font-size:18px; padding:12px; border-radius:15px; margin-bottom:10px;"><br>
  
  <div style="margin: 15px 0;">
    <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
    <input type="file" id="questionImageInput" accept="image/*" onchange="handleQuestionImage(event)" style="padding: 8px; border: 2px dashed #ccc; border-radius: 8px; cursor: pointer; max-width: 500px;">
    <div id="questionImagePreview" style="margin-top: 10px; text-align: center;"></div>
  </div>
  
  <div style="margin: 15px 0;">
    <button class="neon-btn-green" onclick="autoGenerateAnswers()" style="font-size:14px; padding:8px 16px; min-height:40px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
    <span style="margin-left: 10px; color: #666; font-size: 14px;">‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</span>
  </div>
  
  <div style="display:flex; gap:5px; justify-content:center; margin-top:20px;">
    <div style="flex:1; background:rgba(76, 175, 80, 0.1); padding:15px; border-radius:10px; border:2px solid #4CAF50;">
      <label style="color:#4CAF50; font-weight:bold;">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úÖ</label><br>
      <input id="correctAnswerInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 4)" style="max-width:300px; font-size:18px; padding:10px; margin:10px 0; border-radius:15px;">
      <button class="neon-btn" onclick="addAnswer('correct')" style="font-size:14px; padding:8px 16px; min-height:40px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
      <div id="correctAnswersList" style="margin-top:10px;"></div>
    </div>
    
    <div style="flex:1; background:rgba(244, 67, 54, 0.1); padding:15px; border-radius:10px; border:2px solid #f44336;">
      <label style="color:#f44336; font-weight:bold;">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î ‚ùå</label><br>
      <input id="wrongAnswerInput" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î (‡πÄ‡∏ä‡πà‡∏ô 3, 5, 6)" style="max-width:300px; font-size:18px; padding:10px; margin:10px 0; border-radius:15px;">
      <button class="neon-btn" onclick="addAnswer('wrong')" style="font-size:14px; padding:8px 16px; min-height:40px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
      <div id="wrongAnswersList" style="margin-top:10px;"></div>
    </div>
  </div>
  
  <button class="neon-btn-green" onclick="addQuestion()" style="margin-top:20px; font-size:14px; padding:8px 16px; min-height:40px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå</button>
  
  <hr style="margin:30px 0; border:none; border-top:2px solid #ccc;">
  
  <h3>‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="questionCount">0</span> ‡∏Ç‡πâ‡∏≠)</h3>
  <div id="questionsList" style="max-height:400px; overflow-y:auto;"></div>
</div>

<!-- Count Mode -->
<div id="countMode" class="main-container" style="display:none;">
  <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö</h3>
  <p style="color: #666; margin: 15px 0;">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡∏ú‡∏¥‡∏î‡∏à‡∏∞‡πÇ‡∏î‡∏ô‡∏•‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
  
  <div style="display: flex; gap: 20px; justify-content: center; align-items: center; margin: 30px 0; flex-wrap: wrap;">
    <div style="text-align: left;">
      <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</label>
      <input type="number" id="countStartInput" value="1" min="1" max="100" style="width: 150px; padding: 12px; font-size: 20px; border-radius: 10px; border: 2px solid #74640a;">
    </div>
    <div style="text-align: left;">
      <label style="font-weight: 600; color: #333; display: block; margin-bottom: 8px;">‡∏ñ‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç:</label>
      <input type="number" id="countEndInput" value="10" min="1" max="100" style="width: 150px; padding: 12px; font-size: 20px; border-radius: 10px; border: 2px solid #74640a;">
    </div>
  </div>
</div>

<!-- Control Buttons -->
<div id="controlButtons" style="display: flex; justify-content: center; gap: 15px; margin: 20px auto; max-width: 900px; flex-wrap: wrap;">
  <button class="neon-btn" onclick="saveConfig()" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
  <button class="neon-btn" onclick="saveActivity()" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
  <button class="neon-btn" onclick="loadActivity()" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
  <button class="neon-btn" onclick="window.location.href='student-reports.html'" style="font-size: clamp(0.9rem, 1.8vw, 1.2rem); padding: 12px 25px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
</div>

<!-- Activity Selection Modal -->
<div id="activityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); padding: 30px; border-radius: 20px; max-width: 700px; width: 95%; max-height: 85vh; overflow-y: auto; border: 5px solid #00acc1;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0; color: #006064;">‚òÅÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå</h2>
      <button onclick="closeActivityModal()" style="background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px;">‚úñ</button>
    </div>
    <div id="teacherList"></div>
    <div id="activityList" style="display: none;"></div>
  </div>
</div>

<script>

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö export PDF ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö

let correctAnswers = [];
let wrongAnswers = [];
let allQuestions = []; // ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
let currentQuestionImage = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
let currentMode = 'question'; // ‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: 'question' ‡∏´‡∏£‡∏∑‡∏≠ 'count'

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î
function switchMode(mode) {
  currentMode = mode;
  
  const questionMode = document.getElementById('questionMode');
  const countMode = document.getElementById('countMode');
  const btnQuestion = document.getElementById('modeQuestion');
  const btnCount = document.getElementById('modeCount');
  
  if (mode === 'question') {
    questionMode.style.display = 'block';
    countMode.style.display = 'none';
    btnQuestion.className = 'neon-btn-green';
    btnCount.className = 'neon-btn';
  } else {
    questionMode.style.display = 'none';
    countMode.style.display = 'block';
    btnQuestion.className = 'neon-btn';
    btnCount.className = 'neon-btn-green';
  }
  
  updateCountInfo();
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö
function updateCountInfo() {
  const start = parseInt(document.getElementById('countStartInput').value) || 1;
  const end = parseInt(document.getElementById('countEndInput').value) || 10;
  const total = Math.max(0, end - start + 1);
  
  document.getElementById('countTotal').textContent = total;
  document.getElementById('countRange').textContent = `${start}-${end}`;
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ input
document.addEventListener('DOMContentLoaded', function() {
  const startInput = document.getElementById('countStartInput');
  const endInput = document.getElementById('countEndInput');
  
  if (startInput) startInput.addEventListener('input', updateCountInfo);
  if (endInput) endInput.addEventListener('input', updateCountInfo);
});

function handleQuestionImage(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    currentQuestionImage = e.target.result;
    const preview = document.getElementById('questionImagePreview');
    preview.innerHTML = `
      <img src="${e.target.result}" class="image-preview" />
      <br>
      <button class="remove-image-btn" onclick="removeQuestionImage()">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
    `;
  };
  reader.readAsDataURL(file);
}

function removeQuestionImage() {
  currentQuestionImage = null;
  document.getElementById('questionImageInput').value = '';
  document.getElementById('questionImagePreview').innerHTML = '';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å
function convertThaiToArabicNumbers(text) {
  const thaiNumbers = ['‡πê', '‡πë', '‡πí', '‡πì', '‡πî', '‡πï', '‡πñ', '‡πó', '‡πò', '‡πô'];
  const arabicNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
  
  let result = text;
  for (let i = 0; i < thaiNumbers.length; i++) {
    result = result.split(thaiNumbers[i]).join(arabicNumbers[i]);
  }
  return result;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢
function convertArabicToThaiNumbers(text) {
  const thaiNumbers = ['‡πê', '‡πë', '‡πí', '‡πì', '‡πî', '‡πï', '‡πñ', '‡πó', '‡πò', '‡πô'];
  const arabicNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
  
  let result = text.toString();
  for (let i = 0; i < arabicNumbers.length; i++) {
    result = result.split(arabicNumbers[i]).join(thaiNumbers[i]);
  }
  return result;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
function hasThaiNumbers(text) {
  const thaiNumbers = ['‡πê', '‡πë', '‡πí', '‡πì', '‡πî', '‡πï', '‡πñ', '‡πó', '‡πò', '‡πô'];
  return thaiNumbers.some(num => text.includes(num));
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function autoGenerateAnswers() {
  const questionInput = document.getElementById('questionInput').value.trim();
  if (!questionInput) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }
  
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const useThaiNumbers = hasThaiNumbers(questionInput);
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å
    let expression = convertThaiToArabicNumbers(questionInput);
    
    // ‡∏•‡∏ö = ‡πÅ‡∏•‡∏∞ ? ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå
    expression = expression.replace(/=/g, '').replace(/\?/g, '').trim();
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å
    let correctAnswer = eval(expression);
    
    if (isNaN(correctAnswer) || !isFinite(correctAnswer)) {
      showCustomAlert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå');
      return;
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    if (!Number.isInteger(correctAnswer)) {
      correctAnswer = parseFloat(correctAnswer.toFixed(2));
    }
    
    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°
    correctAnswers = [];
    wrongAnswers = [];
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å (‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡∏ñ‡πâ‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢)
    const correctAnswerStr = useThaiNumbers ? convertArabicToThaiNumbers(correctAnswer.toString()) : correctAnswer.toString();
    correctAnswers.push(correctAnswerStr);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î 3-5 ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    const wrongCount = Math.floor(Math.random() * 3) + 3; // 3-5 ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î
    const wrongSet = new Set();
    
    while (wrongSet.size < wrongCount) {
      let wrongAnswer;
      const rand = Math.random();
      
      if (rand < 0.4) {
        // ‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö 1-5
        const offset = Math.floor(Math.random() * 5) + 1;
        wrongAnswer = correctAnswer + (Math.random() > 0.5 ? offset : -offset);
      } else if (rand < 0.7) {
        // ‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö 10-30%
        const percentage = (Math.random() * 0.2 + 0.1); // 10-30%
        const offset = Math.max(1, Math.floor(Math.abs(correctAnswer) * percentage));
        wrongAnswer = correctAnswer + (Math.random() > 0.5 ? offset : -offset);
      } else {
        // ‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏Ç‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
        wrongAnswer = correctAnswer + Math.floor(Math.random() * 10) - 5;
      }
      
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      if (!Number.isInteger(wrongAnswer)) {
        wrongAnswer = parseFloat(wrongAnswer.toFixed(2));
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡∏≠‡∏∑‡πà‡∏ô (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö‡πÑ‡∏î‡πâ)
      if (wrongAnswer !== correctAnswer && !wrongSet.has(wrongAnswer)) {
        wrongSet.add(wrongAnswer);
      }
    }
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢‡∏ñ‡πâ‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢
    wrongAnswers = Array.from(wrongSet).map(n => {
      return useThaiNumbers ? convertArabicToThaiNumbers(n.toString()) : n.toString();
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    renderAnswers('correct');
    renderAnswers('wrong');
    
    const displayCorrect = useThaiNumbers ? convertArabicToThaiNumbers(correctAnswer.toString()) : correctAnswer;
    const displayWrong = wrongAnswers.join(', ');
    showCustomAlert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br><br>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å: ${displayCorrect}<br>‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î: ${displayWrong}`);
    
  } catch (error) {
    showCustomAlert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ<br><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á<br>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 2 + 3, 10 - 5, 4 * 6, 20 / 4');
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
function addAnswer(type) {
  const inputId = type === 'correct' ? 'correctAnswerInput' : 'wrongAnswerInput';
  const input = document.getElementById(inputId);
  const answer = input.value.trim();
  
  if (!answer) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö');
    return;
  }
  
  if (type === 'correct') {
    correctAnswers.push(answer);
    renderAnswers('correct');
  } else {
    wrongAnswers.push(answer);
    renderAnswers('wrong');
  }
  
  input.value = ''; // Clear input
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
function removeAnswer(type, index) {
  if (type === 'correct') {
    correctAnswers.splice(index, 1);
    renderAnswers('correct');
  } else {
    wrongAnswers.splice(index, 1);
    renderAnswers('wrong');
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
function renderAnswers(type) {
  const listId = type === 'correct' ? 'correctAnswersList' : 'wrongAnswersList';
  const answers = type === 'correct' ? correctAnswers : wrongAnswers;
  const list = document.getElementById(listId);
  
  list.innerHTML = answers.map((answer, i) => `
    <div class="choice-item">
      <span style="font-size:18px; font-weight:bold;">${answer}</span>
      <button onclick="removeAnswer('${type}', ${i})">‡∏•‡∏ö</button>
    </div>
  `).join('');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå
function addQuestion() {
  const question = document.getElementById('questionInput').value.trim();
  
  if (!question) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏•‡∏Ç');
    return;
  }
  
  if (correctAnswers.length === 0) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö');
    return;
  }
  
  if (wrongAnswers.length === 0) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö');
    return;
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏Ç‡πâ‡∏≤ array
  const questionData = {
    question: question,
    image: currentQuestionImage || null, // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    correctAnswers: [...correctAnswers],
    wrongAnswers: [...wrongAnswers]
  };
  
  allQuestions.push(questionData);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏•‡∏á MongoDB
  saveQuestionToDB(questionData, 'math');
  
  // Clear form
  document.getElementById('questionInput').value = '';
  correctAnswers = [];
  wrongAnswers = [];
  renderAnswers('correct');
  renderAnswers('wrong');
  removeQuestionImage(); // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏ó‡∏¢‡πå
  renderQuestionsList();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function renderQuestionsList() {
  const list = document.getElementById('questionsList');
  document.getElementById('questionCount').innerText = allQuestions.length;
  
  list.innerHTML = `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:8px;">` + 
    allQuestions.map((q, i) => `
      <div style="background:rgba(255,255,255,0.9); padding:8px; border-radius:6px; border:2px solid #74640a;">
        <div style="display:flex; justify-content:space-between; align-items:start; gap:5px;">
          <div style="flex:1; text-align:left;">
            <div style="margin:0 0 4px 0; color:#333; font-weight:bold; font-size:13px;">‡∏Ç‡πâ‡∏≠ ${i + 1}: ${q.question}</div>
            ${q.image ? '<div style="margin:4px 0;"><img src="' + q.image + '" style="max-width: 100%; max-height: 80px; border-radius: 4px; border: 1px solid #ddd;" /></div>' : ''}
            <div style="margin:2px 0; font-size:12px;">
              <span style="color:#4CAF50; font-weight:bold;">‚úì</span> ${q.correctAnswers.join(', ')}
            </div>
            <div style="margin:2px 0; font-size:12px;">
              <span style="color:#f44336; font-weight:bold;">‚úó</span> ${q.wrongAnswers.join(', ')}
            </div>
          </div>
          <button onclick="removeQuestion(${i})" style="background:#f44336; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">‡∏•‡∏ö</button>
        </div>
      </div>
    `).join('') + `</div>`;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå
function removeQuestion(index) {
  if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ô‡∏µ‡πâ?')) {
    allQuestions.splice(index, 1);
    renderQuestionsList();
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
function handleImageUpload(event, type) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      // Auto crop to square
      const croppedImageData = autoCropToSquare(img);
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå
      if (type === 'correct') {
        correctImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('correct');
      } else {
        wrongImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('wrong');
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function autoCropToSquare(img) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
  const maxSize = 300;
  let width = img.width;
  let height = img.height;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isMobile = window.innerWidth <= 768;

  // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
  if (!isMobile && (width > maxSize || height > maxSize)) {
    if (width > height) {
      height = (height / width) * maxSize;
      width = maxSize;
    } else {
      width = (width / height) * maxSize;
      height = maxSize;
    }
  }

  canvas.width = width;
  canvas.height = height;

  // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏•‡∏á‡∏ö‡∏ô canvas
  ctx.drawImage(img, 0, 0, width, height);

  // ‡∏ï‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;

  // ‡∏´‡∏≤‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏°‡∏∏‡∏° 4 ‡∏°‡∏∏‡∏°)
  const corners = [
    [0, 0], // ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô
    [width - 1, 0], // ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô
    [0, height - 1], // ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á
    [width - 1, height - 1] // ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á
  ];

  let bgColor = null;
  for (let corner of corners) {
    const x = corner[0];
    const y = corner[1];
    const index = (y * width + x) * 4;
    const r = data[index];
    const g = data[index + 1];
    const b = data[index + 2];

    if (r > 200 && g > 200 && b > 200) { // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
      bgColor = { r, g, b };
      break;
    }
  }

  // ‡∏ï‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á)
  if (bgColor) {
    const threshold = 40; // ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏µ
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      // ‡∏ñ‡πâ‡∏≤‡∏™‡∏µ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
      if (
        Math.abs(r - bgColor.r) < threshold &&
        Math.abs(g - bgColor.g) < threshold &&
        Math.abs(b - bgColor.b) < threshold
      ) {
        data[i + 3] = 0; // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
      }
    }

    ctx.putImageData(imageData, 0, 0);
  }

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 (‡πÉ‡∏ä‡πâ PNG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)
  return canvas.toDataURL('image/png', 0.9);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
function removeImage(type, index) {
  if (type === 'correct') {
    correctImages.splice(index, 1);
    renderImages('correct');
  } else {
    wrongImages.splice(index, 1);
    renderImages('wrong');
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
function renderImages(type) {
  const listId = type === 'correct' ? 'correctImagesList' : 'wrongImagesList';
  const images = type === 'correct' ? correctImages : wrongImages;
  const list = document.getElementById(listId);
  
  list.innerHTML = images.map((imgData, i) => `
    <div class="image-preview-item">
      <img src="${imgData}" alt="Image ${i+1}">
      <button class="remove-btn" onclick="removeImage('${type}', ${i})">√ó</button>
    </div>
  `).join('');
}

// ‡πÇ‡∏´‡∏•‡∏î config ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
const savedConfig = JSON.parse(localStorage.getItem('emojiGameConfig')||'{}');
if(savedConfig.week) document.getElementById('weekInput').value = savedConfig.week;
if(savedConfig.topic) document.getElementById('topicInput').value = savedConfig.topic;
if(savedConfig.unit) document.getElementById('unitInput').value = savedConfig.unit;
if(savedConfig.teacher) document.getElementById('teacherInput').value = savedConfig.teacher;
if(savedConfig.questions) {
  allQuestions = savedConfig.questions;
  renderQuestionsList();
}
renderAnswers('correct');
renderAnswers('wrong');

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏•‡∏á MongoDB
async function saveQuestionToDB(questionData, type) {
  const teacher = document.getElementById('teacherInput')?.value.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const classroom = document.getElementById('classroomInput')?.value.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const topic = document.getElementById('topicInput')?.value.trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  
  try {
    const response = await fetch('/api/questions/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        teacher: teacher,
        classroom: classroom,
        topic: topic,
        type: type, // 'math' ‡∏´‡∏£‡∏∑‡∏≠ 'thai'
        questionData: questionData,
        createdAt: new Date().toISOString()
      })
    });
    
    if (response.ok) {
      console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏•‡∏á MongoDB ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    } else {
      console.error('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    }
  } catch (error) {
    console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
  }
}

function saveConfig(){
  const week = document.getElementById('weekInput').value.trim();
  const topic = document.getElementById('topicInput').value.trim();
  const unit = document.getElementById('unitInput').value.trim();
  const teacher = document.getElementById('teacherInput').value.trim();
  const classroom = document.getElementById('classroomInput').value.trim();
  const userName = document.getElementById('userNameInput').value.trim();
  const gradeSelected = document.getElementById('gradeSelect')?.value;

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  if (!gradeSelected) {
    showCustomAlert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
    document.getElementById('gradeSelect')?.focus();
    return;
  }
  
  if (currentMode === 'count') {
    // ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö
    startCountGame();
    return;
  }
  
  // ‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå
  // Allow saving even with missing fields ‚Äî use defaults
  const cfgWeek = week || '-';
  const cfgTopic = topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUnit = unit || '-';
  const cfgTeacher = teacher || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUserName = userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  if (allQuestions.length === 0) console.warn('[SAVE] Saving config with 0 questions');

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (accept empty questions)
  const config = {
    week: cfgWeek,
    topic: cfgTopic,
    unit: cfgUnit,
    teacher: cfgTeacher,
    classroom: classroom || '',
    userName: cfgUserName,
    questions: allQuestions || []  // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå
  };
  localStorage.setItem('emojiGameConfig', JSON.stringify(config));

  // ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°
  window.location.href='gamemath.html';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Cloud)
async function saveActivity() {
  const week = document.getElementById('weekInput').value.trim();
  const topic = document.getElementById('topicInput').value.trim();
  const unit = document.getElementById('unitInput').value.trim();
  const teacher = document.getElementById('teacherInput').value.trim();
  const classroom = document.getElementById('classroomInput')?.value.trim() || '';
  const userName = document.getElementById('userNameInput').value.trim();

  if (!teacher) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
    return;
  }

  const cfgWeek = week || '-';
  const cfgTopic = topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUnit = unit || '-';
  const cfgTeacher = teacher;
  const cfgUserName = userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î
  if (currentMode === 'question' && allQuestions.length === 0) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
    return;
  }
  
  if (currentMode === 'count') {
    const startNum = parseInt(document.getElementById('countStartInput').value);
    const endNum = parseInt(document.getElementById('countEndInput').value);
    
    if (!startNum || !endNum || startNum < 1 || endNum < 1 || startNum >= endNum) {
      showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      return;
    }
  }

  // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
  if (window.editingCloudActivity) {
    const { teacherName, activityId } = window.editingCloudActivity;
    
    const activityConfig = currentMode === 'count' ? {
      week: cfgWeek,
      topic: cfgTopic,
      unit: cfgUnit,
      teacher: cfgTeacher,
      classroom: classroom || '',
      userName: cfgUserName,
      gameType: 'counting',
      startNumber: parseInt(document.getElementById('countStartInput').value),
      endNumber: parseInt(document.getElementById('countEndInput').value)
    } : {
      week: cfgWeek,
      topic: cfgTopic,
      unit: cfgUnit,
      teacher: cfgTeacher,
      classroom: classroom || '',
      userName: cfgUserName,
      questions: allQuestions
    };
    
    try {
      const res = await fetch(`/api/settings/math/${encodeURIComponent(teacherName)}/${activityId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: window.editingCloudActivityName || `${cfgTopic} - ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${cfgWeek}`,
          config: activityConfig
        })
      });
      if (!res.ok) throw new Error('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      showCustomAlert('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      delete window.editingCloudActivity;
      delete window.editingCloudActivityName;
      return;
    } catch (err) {
      showCustomAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      return;
    }
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
  const activityName = prompt('‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:', `${cfgTopic} - ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${cfgWeek}`);
  if (!activityName) return;

  const activityConfig = currentMode === 'count' ? {
    week: cfgWeek,
    topic: cfgTopic,
    unit: cfgUnit,
    teacher: cfgTeacher,
    classroom: classroom || '',
    userName: cfgUserName,
    gameType: 'counting',
    startNumber: parseInt(document.getElementById('countStartInput').value),
    endNumber: parseInt(document.getElementById('countEndInput').value)
  } : {
    week: cfgWeek,
    topic: cfgTopic,
    unit: cfgUnit,
    teacher: cfgTeacher,
    classroom: classroom || '',
    userName: cfgUserName,
    questions: allQuestions
  };

  try {
    const res = await fetch('/api/settings/math', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        teacherName: cfgTeacher,
        name: activityName,
        config: activityConfig
      })
    });
    if (!res.ok) throw new Error('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const data = await res.json();
    showCustomAlert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>‡∏£‡∏´‡∏±‡∏™: ${data.data?.activityId || '-'}`);
  } catch (err) {
    showCustomAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
async function loadActivity() {
  const teacherList = document.getElementById('teacherList');
  const activityList = document.getElementById('activityList');
  teacherList.innerHTML = '<p style="text-align:center;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå...</p>';
  activityList.style.display = 'none';
  document.getElementById('activityModal').style.display = 'flex';

  try {
    const res = await fetch('/api/settings/math');
    if (!res.ok) throw new Error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const result = await res.json();
    const activities = result.data || [];

    // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏π
    const teacherMap = {};
    activities.forEach(a => {
      if (!teacherMap[a.teacherName]) teacherMap[a.teacherName] = [];
      teacherMap[a.teacherName].push(a);
    });

    const teachers = Object.keys(teacherMap);
    if (teachers.length === 0) {
      teacherList.innerHTML = '<p style="text-align:center; color:#666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ö‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå</p>';
      return;
    }

    teacherList.innerHTML = `
      <h3 style="margin: 0 0 15px 0; color: #00838f;">üë©‚Äçüè´ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
        ${teachers.map(t => `
          <div onclick="showTeacherActivities('${encodeURIComponent(t)}')" 
               style="background: white; padding: 15px; border-radius: 10px; cursor: pointer; border: 3px solid #00acc1; transition: all 0.2s;"
               onmouseover="this.style.transform='scale(1.03)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';"
               onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
            <div style="font-size: 18px; font-weight: bold; color: #006064;">üë§ ${t}</div>
            <div style="font-size: 14px; color: #666; margin-top: 5px;">${teacherMap[t].length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
          </div>
        `).join('')}
      </div>
    `;

    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
    window.cloudTeacherMap = teacherMap;
  } catch (err) {
    teacherList.innerHTML = `<p style="text-align:center; color:red;">‚ùå ${err.message}</p>`;
  }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π
function showTeacherActivities(encodedTeacherName, filterType = 'all') {
  const teacherName = decodeURIComponent(encodedTeacherName);
  const allActivities = window.cloudTeacherMap[teacherName] || [];
  const teacherList = document.getElementById('teacherList');
  const activityList = document.getElementById('activityList');
  
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  const activities = filterType === 'all' ? allActivities : 
    allActivities.filter(a => {
      const gameType = a.config?.gameType || 'question';
      return gameType === filterType;
    });
  
  // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
  const countQuestion = allActivities.filter(a => !a.config?.gameType || a.config?.gameType === 'question').length;
  const countCounting = allActivities.filter(a => a.config?.gameType === 'counting').length;

  teacherList.style.display = 'none';
  activityList.innerHTML = `
    <div style="display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
      <button onclick="backToTeacherList()" style="background: #607d8b; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">&lt;</button>
      <h3 style="margin: 0; color: #00838f;">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á ${teacherName}</h3>
    </div>
    
    <!-- Filter Tabs -->
    <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
      <button onclick="showTeacherActivities('${encodedTeacherName}', 'all')" 
              style="padding: 10px 16px; border: 2px solid #00acc1; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; transition: all 0.2s;
                     ${filterType === 'all' ? 'background: #00acc1; color: white;' : 'background: white; color: #00acc1;'}">
        ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${allActivities.length})
      </button>
      <button onclick="showTeacherActivities('${encodedTeacherName}', 'question')" 
              style="padding: 10px 16px; border: 2px solid #2196F3; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; transition: all 0.2s;
                     ${filterType === 'question' ? 'background: #2196F3; color: white;' : 'background: white; color: #2196F3;'}">
        ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï (${countQuestion})
      </button>
      <button onclick="showTeacherActivities('${encodedTeacherName}', 'counting')" 
              style="padding: 10px 16px; border: 2px solid #4CAF50; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; transition: all 0.2s;
                     ${filterType === 'counting' ? 'background: #4CAF50; color: white;' : 'background: white; color: #4CAF50;'}">
        ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (${countCounting})
      </button>
    </div>
    
    ${activities.length === 0 ? `
      <div style="text-align: center; padding: 40px; color: #999;">
        <p style="font-size: 48px; margin: 0;">üì≠</p>
        <p style="font-size: 16px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>
      </div>
    ` : `
    <div style="display: grid; gap: 10px;">
      ${activities.map(a => {
        const gameType = a.config?.gameType || 'question';
        const typeBadge = gameType === 'counting' ? '‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô' : '‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏Ñ‡∏ì‡∏¥‡∏ï';
        const badgeColor = gameType === 'counting' ? '#4CAF50' : '#2196F3';
        const count = gameType === 'counting' ? 
          `${a.config?.startNumber || 1} - ${a.config?.endNumber || 10}` :
          (a.config?.questions?.length || 0) + ' ‡∏Ç‡πâ‡∏≠';
        
        return `
        <div style="background: white; padding: 15px; border-radius: 10px; border: 3px solid #00acc1;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <h4 style="margin: 0; color: #006064; font-size: 16px;">${a.name}</h4>
                <span style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">${typeBadge}</span>
              </div>
              <p style="margin: 4px 0; font-size: 13px; color: #666;">‡∏™‡∏≤‡∏£‡∏∞: ${a.config?.topic || '-'}</p>
              <p style="margin: 4px 0; font-size: 13px; color: #666;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå: ${a.config?.week || '-'}</p>
              <p style="margin: 4px 0; font-size: 13px; color: #00838f; font-weight: bold;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${count}</p>
              <p style="margin: 4px 0; font-size: 11px; color: #999;">‡∏£‡∏´‡∏±‡∏™: ${a.activityId}</p>
              <p style="margin: 4px 0; font-size: 11px; color: #888;">üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${a.createdAtThai || a.updatedAtThai || '-'}</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <button onclick="playCloudActivity('${encodeURIComponent(teacherName)}', ${a.activityId})" 
                      style="background: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô</button>
              <button onclick="editCloudActivity('${encodeURIComponent(teacherName)}', ${a.activityId})" 
                      style="background: #2196F3; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button onclick="deleteCloudActivity('${encodeURIComponent(teacherName)}', ${a.activityId})" 
                      style="background: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 13px;">üóëÔ∏è ‡∏•‡∏ö</button>
            </div>
          </div>
        </div>
        `;
      }).join('')}
    </div>
    `}
  `;
  activityList.style.display = 'block';
}

// ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π
function backToTeacherList() {
  document.getElementById('activityList').style.display = 'none';
  document.getElementById('teacherList').style.display = 'block';
}

// ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
function playCloudActivity(encodedTeacherName, activityId) {
  const teacherName = decodeURIComponent(encodedTeacherName);
  const activities = window.cloudTeacherMap[teacherName] || [];
  const activity = activities.find(a => a.activityId === activityId);
  if (!activity) { showCustomAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ'); return; }
  
  const config = activity.config || {};
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (config.gameType === 'counting') {
    localStorage.setItem('countGameConfig', JSON.stringify(config));
    window.location.href = 'gamecount.html';
  } else {
    localStorage.setItem('emojiGameConfig', JSON.stringify(config));
    window.location.href = 'gamemath.html';
  }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
function editCloudActivity(encodedTeacherName, activityId) {
  const teacherName = decodeURIComponent(encodedTeacherName);
  const activities = window.cloudTeacherMap[teacherName] || [];
  const activity = activities.find(a => a.activityId === activityId);
  if (!activity) { showCustomAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ'); return; }

  const config = activity.config || {};
  document.getElementById('weekInput').value = config.week || '';
  document.getElementById('topicInput').value = config.topic || '';
  document.getElementById('unitInput').value = config.unit || '';
  document.getElementById('teacherInput').value = config.teacher || '';
  document.getElementById('userNameInput').value = config.userName || '';

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (config.gameType === 'counting') {
    switchMode('count');
    document.getElementById('countStartInput').value = config.startNumber || 1;
    document.getElementById('countEndInput').value = config.endNumber || 10;
    updateCountInfo();
  } else {
    switchMode('question');
    allQuestions = config.questions || [];
    renderQuestionsList();
  }

  window.editingCloudActivity = { teacherName, activityId };
  window.editingCloudActivityName = activity.name;

  closeActivityModal();
  showCustomAlert(`üìù ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activity.name}"<br><br>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó`);
}

// ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
async function deleteCloudActivity(encodedTeacherName, activityId) {
  const teacherName = decodeURIComponent(encodedTeacherName);
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏£‡∏´‡∏±‡∏™ ${activityId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  try {
    const res = await fetch(`/api/settings/math/${encodeURIComponent(teacherName)}/${activityId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    showCustomAlert('‚úÖ ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    loadActivity(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î
  } catch (err) {
    showCustomAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
  }
}



// ‡∏õ‡∏¥‡∏î Modal
function closeActivityModal() {
  document.getElementById('activityModal').style.display = 'none';
}

// ============== Cloud Functions ==============

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ö‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
async function saveToCloud() {
  const week = document.getElementById('weekInput').value.trim();
  const topic = document.getElementById('topicInput').value.trim();
  const unit = document.getElementById('unitInput').value.trim();
  const teacher = document.getElementById('teacherInput').value.trim();
  const userName = document.getElementById('userNameInput').value.trim();

  if (!teacher) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
    return;
  }

  if (allQuestions.length === 0) {
    showCustomAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
    return;
  }

  const cfgWeek = week || '-';
  const cfgTopic = topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const cfgUnit = unit || '-';
  const cfgTeacher = teacher;
  const cfgUserName = userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';

  // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå
  if (window.editingCloudActivity) {
    const { teacherName, activityId } = window.editingCloudActivity;
    try {
      const res = await fetch(`/api/settings/math/${encodeURIComponent(teacherName)}/${activityId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: window.editingCloudActivityName || `${cfgTopic} - ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${cfgWeek}`,
          config: {
            week: cfgWeek,
            topic: cfgTopic,
            unit: cfgUnit,
            teacher: cfgTeacher,
            userName: cfgUserName,
            questions: allQuestions
          }
        })
      });
      if (!res.ok) throw new Error('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      showCustomAlert('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ö‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      delete window.editingCloudActivity;
      delete window.editingCloudActivityName;
      return;
    } catch (err) {
      showCustomAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
      return;
    }
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
  const activityName = prompt('‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:', `${cfgTopic} - ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå ${cfgWeek}`);
  if (!activityName) return;

  try {
    const res = await fetch('/api/settings/math', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        teacherName: cfgTeacher,
        name: activityName,
        config: {
          week: cfgWeek,
          topic: cfgTopic,
          unit: cfgUnit,
          teacher: cfgTeacher,
          userName: cfgUserName,
          questions: allQuestions
        }
      })
    });
    if (!res.ok) throw new Error('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    const data = await res.json();
    showCustomAlert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}" ‡∏ö‡∏ô‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>‡∏£‡∏´‡∏±‡∏™: ${data.activityId}`);
  } catch (err) {
    showCustomAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö
function startCountGame() {
  const startNum = parseInt(document.getElementById('countStartInput').value);
  const endNum = parseInt(document.getElementById('countEndInput').value);
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  if (!startNum || !endNum || startNum < 1 || endNum < 1) {
    showCustomAlert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0)');
    return;
  }
  
  if (startNum >= endNum) {
    showCustomAlert('‚ö†Ô∏è ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
    return;
  }
  
  if (endNum - startNum > 50) {
    showCustomAlert('‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏ô 50 ‡∏ï‡∏±‡∏ß');
    return;
  }
  
  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
  const week = document.getElementById('weekInput').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const topic = document.getElementById('topicInput').value || '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö';
  const unit = document.getElementById('unitInput').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const teacher = document.getElementById('teacherInput').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const classroom = document.getElementById('classroomInput').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  const userName = document.getElementById('userNameInput').value || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á config ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö
  const countConfig = {
    week,
    topic,
    unit,
    teacher,
    classroom,
    userName,
    startNumber: startNum,
    endNumber: endNum,
    gameType: 'counting'
  };
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config
  localStorage.setItem('countGameConfig', JSON.stringify(countConfig));
  
  // ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°
  window.location.href = 'gamecount.html';
}

</script>

<!-- Socket client (connect + heartbeat) -->
<script src="/socket.io/socket.io.js"></script>
<script src="/socket-client.js"></script>
<script>
  try { localStorage.setItem('lastVisitedPage', location.pathname + location.search + location.hash); } catch(e){}
</script>
<script>
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏° ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô + ‡∏´‡πâ‡∏≠‡∏á ‡πÄ‡∏õ‡πá‡∏ô classroom
function updateClassroomValue() {
  const grade = document.getElementById('gradeSelect')?.value || '';
  const room = document.getElementById('roomInput')?.value.trim() || '';
  const classroomInput = document.getElementById('classroomInput');
  if (classroomInput) {
    classroomInput.value = room ? `${grade}/${room}` : grade;
  }
}
// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤
document.addEventListener('DOMContentLoaded', function() {
  const gradeSelect = document.getElementById('gradeSelect');
  const roomInput = document.getElementById('roomInput');
  if (gradeSelect) gradeSelect.addEventListener('change', updateClassroomValue);
  if (roomInput) roomInput.addEventListener('input', updateClassroomValue);
});
</script>
<script>
var __localUsageId_teachermatch = null;
window.addEventListener('load', function(){
  try{
    if (window.usageTracker && typeof window.usageTracker.start === 'function') {
      __localUsageId_teachermatch = window.usageTracker.start(location.pathname || 'teachermatch.html', 'teacher-config-math');
      console.log('usage started (teachermatch)', __localUsageId_teachermatch);
    }
  }catch(e){ console.warn('usageTracker.start failed (teachermatch)', e); }
});
window.addEventListener('beforeunload', function(){
  try{
    if (window.usageTracker && typeof window.usageTracker.end === 'function') {
      window.usageTracker.end(__localUsageId_teachermatch);
    }
  }catch(e){}
});
</script>
</body>
</html>
