<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏•‡∏Ç</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/gamemath.css">
<script src="/js/prevent-image-download.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-thai-support@1.0.0/dist/jspdf-thai-support.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script type="module">
  import { showStudentInputDialog, saveStudentTestResult } from '/js/studentInput.js';
  import { saveStudentToFirebase } from '/js/mongodb-config.js';
  window.showStudentInputDialog = showStudentInputDialog;
  window.saveStudentTestResult = saveStudentTestResult;
  window.saveStudentToFirebase = saveStudentToFirebase;
</script>
<style>
body { 
  font-family: 'Roboto', sans-serif; 
  text-align: center; 
  margin: 0; 
  padding: 10px;
  overflow: hidden;
  position: relative;
  min-height: 100vh;
}

body::before {
  content: '';
  position: fixed;
  top: 0; 
  left: 0; 
  right: 0; 
  bottom: 0;
  background: linear-gradient(to bottom, #ebd09e 0%, #251f03 100%);
  z-index: -1;
}

.question-container {
  background: white;
  padding: 20px;
  border-radius: 20px;
  max-width: 800px;
  margin: 10px auto;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  position: relative;
  z-index: 5;
}

.question-text {
  font-size: clamp(1.5rem, 4vw, 2.5rem);
  font-weight: 700;
  color: #333;
  margin: 0;
}

.answer-item { 
  position: absolute;
  background: linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
  border: 6px solid #74640a;
  border-radius: 20px;
  padding: 20px;
  font-size: clamp(1.5rem, 3vw, 2rem);
  font-weight: 700;
  cursor: grab;
  user-select: none;
  touch-action: none;
  transition: transform 0.1s;
  box-shadow: 1px 1px 0 #000, -8px 6px #3b3305, 0 0 20px rgba(255,230,160,0.55);
  min-width: 100px;
  text-align: center;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
  z-index: 10;
}

.answer-item:active {
  cursor: grabbing;
}

.particle { 
  position: absolute; 
  font-size: 16px; 
  opacity: 1; 
  pointer-events: none; 
  animation: fadeOut 0.6s ease-out forwards; 
}

@keyframes fadeOut { 
  to { transform: translateY(-20px) scale(0.5); opacity: 0; } 
}

#zones { 
  display: flex; 
  justify-content: space-around; 
  margin-top: 20px;
  position: relative;
  z-index: 5;
  max-width: none;
  margin-left: auto;
  margin-right: auto;
  width: calc(99% + 40px);
  padding: 0 5px;
}

.zone { 
  width: 49%;
  height: 220px;
  border: 4px dashed #333;
  border-radius: 12px;
  line-height: 220px;
  font-size: 22px;
  color: #333;
}

/* Popup */
#scorePopup {
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  border:2px solid #333;
  padding:30px;
  font-size:24px;
  z-index:999;
  border-radius:10px;
  box-shadow:0 0 15px rgba(0,0,0,0.5);
}

/* neon-btn: center text, auto width, neon border, responsive */
  /* neon-btn: center text, auto width, neon border, responsive */
  .neon-btn {
    background: linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
    color: #000000;
    border: 6px solid #74640a;
    border-radius: 9999px;
    box-shadow: 1px 1px 0 #000, -4px 3px #3b3305, 0 0 10px rgba(255, 0, 0, 0.45); /* Changed neon color */
    font-weight: 700;
    font-size: clamp(0.9rem, 1.2vw, 1.1rem);
    text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3), 0 -1px 0 rgba(0, 0, 0, 0.1);
    position: relative;
    padding: 6px 16px;
    transform: translateZ(0);
    transition: all 0.3s ease;
    z-index: 10;
    min-height: 32px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    margin-right: auto;
    width: fit-content;
    text-align: center;
  }



#scorePopup {
  background: linear-gradient(135deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
  border: 6px solid #74640a;
  box-shadow: 0 0 40px rgba(116, 100, 10, 0.5), 0 10px 30px rgba(0,0,0,0.3);
}

#scorePopup button { font-size: 18px; padding: 6px 12px; margin-top: 10px; cursor: pointer; }

/* Feedback Overlay */
#feedbackOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 999;
  justify-content: center;
  align-items: center;
}

#feedbackMessage {
  font-size: 120px;
  font-weight: 900;
  animation: feedbackPop 0.8s ease-out;
  text-shadow: 0 0 30px currentColor;
}

@keyframes feedbackPop {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.2); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

@media (max-width: 768px) {
  #soundToggleButton {
    right: 20px !important; /* Ensure the rule is applied */
    top: 25px !important; /* Adjust top position for better alignment */

  }
}

/* Volume Control Styles - YouTube Style */
.sound-control-wrapper {
  position: fixed;
  top: 15px;
  right: 50px;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sound-toggle-btn {
  width: 50px;
  height: 50px;
  cursor: pointer;
  transition: transform 0.2s;
}

.sound-toggle-btn:hover {
  transform: scale(1.1);
}

.sound-control-wrapper.show-volume .sound-toggle-btn {
  display: none;
}

.volume-control {
  display: none;
  align-items: center;
  gap: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 15px;
  border-radius: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  opacity: 0;
  transform: translateX(10px);
}

.sound-control-wrapper.show-volume .volume-control {
  display: flex;
  opacity: 1;
  transform: translateX(0);
}

.volume-icon {
  font-size: 24px;
  cursor: pointer;
  transition: transform 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
}

.volume-icon:hover {
  transform: scale(1.1);
}

.volume-slider {
  -webkit-appearance: none;
  appearance: none;
  width: 100px;
  height: 4px;
  border-radius: 2px;
  background: #ddd;
  outline: none;
  transition: all 0.2s;
}

.volume-slider:hover {
  height: 6px;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: linear-gradient(135deg, #8b6914, #d4a574);
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.volume-slider::-webkit-slider-thumb:hover {
  transform: scale(1.3);
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
}

.volume-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: linear-gradient(135deg, #8b6914, #d4a574);
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.volume-slider::-moz-range-thumb:hover {
  transform: scale(1.3);
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
}

.volume-display {
  min-width: 40px;
  text-align: center;
  font-weight: 700;
  font-size: 14px;
  color: #333;
}

@media (max-width: 768px) {
  .sound-control-wrapper {
    right: 10px;
    top: 15px;
  }
  .sound-toggle-btn {
    width: 45px;
    height: 45px;
  }
  .volume-icon {
    font-size: 20px;
  }
  .volume-slider {
    width: 80px;
  }
  .volume-control {
    padding: 8px 12px;
  }
}
</style>
<style>
/* Global version badge: fixed bottom-right on the viewport */
.Version {
  position: fixed;
  right: 12px;
  bottom: 10px;
  font-family: 'Roboto', Helvetica, Arial, sans-serif;
  font-weight: 300;
  font-size: clamp(0.7rem, 0.9vw, 0.9rem);
  color: #8a8f93;
  background: transparent;
  opacity: 0.95;
  padding: 6px 8px;
  border-radius: 6px;
  z-index: 2147483647;
  pointer-events: none;
  box-shadow: 0 1px 0 rgba(0,0,0,0.08);
}
</style>
</head>
<body>

<!-- Feedback Overlay -->
<div id="feedbackOverlay">
  <div id="feedbackMessage"></div>
</div>
<h2 class="neon-btn">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: <span id="topicName"></span></h2>
  <p id="scoreDisplay">Score: <span id="score">0</span></p>

<div id="gameContainer">
  <div class="question-container">
    <div class="question-text" id="questionText"></div>
    <div id="questionImage" style="text-align: center; margin: 15px 0;"></div>
  </div>
  
  <div id="zones">
    <div id="correctZone" class="zone">‚úÖ</div>
  </div>
  
</div>

<!-- Popup -->
<div id="scorePopup">
  <p style="font-size:20px; font-weight:600; margin-bottom:8px; color:#3b3305;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: <span id="topicDisplay"></span></p>
  <p style="font-size:24px; font-weight:600; margin-bottom:10px; color:#3b3305;">‡∏ä‡∏∑‡πà‡∏≠: <span id="playerNameDisplay"></span></p>
  <p id="resultMessage" style="font-size:28px; font-weight:700; margin-bottom:15px;"></p>
  <p style="font-size:32px; font-weight:700; margin:20px 0; color:#74640a;">üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="finalScore" style="color:#8b6914;"></span> ‚≠ê</p>
  
  <div style="display: flex; justify-content: center; gap: 15px; margin: 25px 0;">
    <button onclick="playAgain()" title="‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" style="background: linear-gradient(135deg, #c9a668 0%, #a68944 100%); color: white; border: 4px solid #74640a; border-radius: 50%; width: 75px; height: 75px; cursor: pointer; font-size: 38px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      <span style="color: #4dd0e1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">üîÑ</span>
    </button>
    <div style="position: relative;">
      <button onclick="toggleShareMenu()" title="‡πÅ‡∏ä‡∏£‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="background: linear-gradient(135deg, #a68944 0%, #8b7530 100%); color: white; border: 4px solid #74640a; border-radius: 50%; width: 75px; height: 75px; cursor: pointer; font-size: 38px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        <span style="color: #ff6b9d; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">üìä</span>
      </button>
      <div id="shareMenu" style="display: none; position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #f8f6f0 0%, #fff8e8 100%); border-radius: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; min-width: 180px; z-index: 10000; border: 4px solid #74640a;">
        <!--<button onclick="shareScore(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #2196F3, #1E88E5); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #1976D2, #1565C0)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #2196F3, #1E88E5)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üîó</span> ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        </button>
      -->
        <button onclick="exportToPDF(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #d4a574, #8b6914); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; border-top: 2px solid rgba(255,255,255,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #c9a668, #74640a)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #d4a574, #8b6914)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üíæ</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
        </button>
      </div>
    </div>
    <button onclick="closePopup()" title="‡∏õ‡∏¥‡∏î" style="background: linear-gradient(135deg, #8b7530 0%, #6d5e26 100%); color: white; border: 4px solid #5a4d08; border-radius: 50%; width: 75px; height: 75px; cursor: pointer; font-size: 42px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.2s; font-weight: 700;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      ‚úï
    </button>
  </div>
</div>

<script>
let audioCtx, baseFreq = 200;
let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; // global sound toggle (used by audio helpers)
const sparkleChars = ['‚ú®', 'üåü', 'üí´', '‚≠ê'];
let createdAnswers = {};
let score = 0;
let gameStarted = false;
let currentQuestionIndex = 0;
let allQuestions = [];
let userAnswers = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
let playCount = 1; // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô
let gameStartTime = null; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô
let totalCorrectAnswers = 0; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å
let totalWrongAnswers = 0; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ
function generateReportHTML(data) {
  const { dateStr, timeStr, percentage, scoreVal, total, userName, topic, unit, week, teacher, classroom } = data;

  return `
    <div style="font-family: 'Arial', sans-serif; color: #333; width: 600px; padding: 20px; background: white; position: relative;">
      <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(-30deg); font-size:80px; color:rgba(0,0,0,0.05); font-weight:700; pointer-events:none; z-index:1; white-space:nowrap;">Espresso</div>
      <div style="position: absolute; top: 10px; right: 20px; font-size: 12px; color: #666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
      <div style="text-align: center; margin: 20px 0 15px 0; display:flex; align-items:center; justify-content:center; gap:18px;">
        <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:80px; width:auto;" crossorigin="anonymous" />
      </div>
      <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h1 style="margin: 5px 0; font-size: 24px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h1>
      </div>
      <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
        <p style="font-size: 13px; font-weight: bold; margin: 0 0 8px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
          <tr><td style="padding: 6px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${week || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${topic || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${unit || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacher || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${classroom || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${userName || '-'}</td></tr>
        </table>
      </div>
      <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
        <p style="font-size: 14px; margin: 0 0 10px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
        <p style="font-size: 36px; color: #000; font-weight: bold; margin: 0;">${scoreVal}/${total}</p>
      </div>
      <div style="margin-top: 30px; text-align: center;">
        <p style="margin: 0; font-size: 12px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
        <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
        <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">( _______________________ )</p>
      </div>
      <div style="font-size: 11px; color: #666; text-align: right; margin-top: 20px; line-height: 1.3;">
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
        263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
        ‡πÇ‡∏ó‡∏£: 083-654-9743 | www.kwamgunlimit.com
      </div>
    </div>
  `;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á HTML ‡πÄ‡∏õ‡πá‡∏ô PNG base64
async function generateReportImage() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    const totalQ = allQuestions.length || 1;
    const percentage = Math.round((score / totalQ) * 100);
    
    const reportData = {
      dateStr, timeStr, percentage,
      scoreVal: score,
      total: totalQ,
      userName: teacherConfig.userName,
      topic: teacherConfig.topic,
      unit: teacherConfig.unit,
      week: teacherConfig.week,
      teacher: teacherConfig.teacher,
      classroom: teacherConfig.classroom
    };
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö render
    const tempDiv = document.createElement('div');
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9998px';
    tempDiv.style.top = '0';
    tempDiv.innerHTML = generateReportHTML(reportData);
    document.body.appendChild(tempDiv);
    
    // ‡πÉ‡∏ä‡πâ html2canvas ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô canvas
    const canvas = await html2canvas(tempDiv.firstElementChild, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff'
    });
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 PNG
    const base64Image = canvas.toDataURL('image/png');
    
    // ‡∏•‡∏ö element ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    document.body.removeChild(tempDiv);
    
    return base64Image;
  } catch (e) {
    console.error('[ReportImage] Error generating image:', e);
    return null;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏á DB
async function autoSaveGameResult() {
  try {
    // ‡∏î‡∏∂‡∏á clientId ‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ cookie
    let clientId = localStorage.getItem('huaroa_client_id');
    if (!clientId) {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á clientId ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
      clientId = 'c-' + Math.random().toString(36).slice(2) + '-' + Date.now().toString(36);
      localStorage.setItem('huaroa_client_id', clientId);
    }
    
    const endTime = Date.now();
    const duration = gameStartTime ? (endTime - gameStartTime) : null;
    const totalQuestions = allQuestions.length || 1;
    const percentage = Math.round((score / totalQuestions) * 100);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PNG base64
    const reportImage = await generateReportImage();
    
    const payload = {
      clientId,
      gameType: 'gamemath',
      topic: teacherConfig.topic || null,
      unit: teacherConfig.unit || null,
      week: teacherConfig.week || null,
      teacher: teacherConfig.teacher || null,
      userName: teacherConfig.userName || null,
      score: score,
      totalQuestions: totalQuestions,
      correctAnswers: totalCorrectAnswers,
      wrongAnswers: totalWrongAnswers,
      percentage: percentage,
      duration: duration,
      config: teacherConfig,
      reportImage: reportImage // PNG base64
    };
    
    const response = await fetch('/api/game-results', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    if (result.success) {
      console.log('[AutoSave] Game result saved:', result.resultId);
    } else {
      console.warn('[AutoSave] Failed to save game result:', result.message);
    }
  } catch (e) {
    console.error('[AutoSave] Error saving game result:', e);
  }
}

// ‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å localStorage
let teacherConfig = JSON.parse(localStorage.getItem('emojiGameConfig') || '{}');
document.getElementById('topicName').innerText = teacherConfig.topic || 'Unknown';

// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
let currentStudent = null;

// ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å config ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
if (teacherConfig && teacherConfig.userName && teacherConfig.classroom) {
  currentStudent = {
    name: teacherConfig.userName,
    classroom: teacherConfig.classroom
  };
  console.log('Using student info from config:', currentStudent);
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡∏á Database
  if (window.saveStudentToFirebase) {
    window.saveStudentToFirebase({
      name: currentStudent.name,
      classroom: currentStudent.classroom,
      lastActivity: new Date().toISOString()
    }).then(() => {
      console.log('Student saved to database:', currentStudent.name);
    }).catch((saveError) => {
      console.error('Error saving student to database:', saveError);
    });
  }
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ teacherConfig
if (!teacherConfig || typeof teacherConfig !== 'object') {
  teacherConfig = {
    topic: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
    week: '-',
    unit: '-',
    teacher: '-',
    correctImages: []
  };
  console.warn('teacherConfig ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô localStorage, ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ó‡∏ô:', teacherConfig);
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö userName
if (!teacherConfig.userName) {
  teacherConfig.userName = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ teacherConfig.correctImages
if (!Array.isArray(teacherConfig.correctImages)) {
  teacherConfig.correctImages = [];
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å localStorage
const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
if (savedActivities.length > 0) {
  const latestActivity = savedActivities[savedActivities.length - 1]; // ‡πÉ‡∏ä‡πâ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  teacherConfig.correctImages = latestActivity.config.questions || [];
}

// ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å teacherConfig.correctImages
const totalQuestions = teacherConfig.correctImages.length || 0;

// ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
if (teacherConfig.questions && teacherConfig.questions.length > 0) {
  allQuestions = [...teacherConfig.questions];
  // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÇ‡∏à‡∏ó‡∏¢‡πå
  allQuestions.sort(() => Math.random() - 0.5);
}

// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
document.getElementById('gameContainer').style.display = 'block';
gameStarted = true;

// ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÇ‡∏ã‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏∞‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
const _correctZoneEl = document.getElementById('correctZone');
if (_correctZoneEl) {
  _correctZoneEl.style.border = '4px dashed #27ae60';
  _correctZoneEl.style.color = '#27ae60';
  _correctZoneEl.style.boxShadow = '0 10px 30px rgba(14, 226, 17, 0.1)';
  _correctZoneEl.style.background = 'linear-gradient(135deg, #e0ffe8 0%, #b2f7c1 100%)';
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π


// ‡πÅ‡∏™‡∏î‡∏á feedback ‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î
function showFeedback(isCorrect) {
  const overlay = document.getElementById('feedbackOverlay');
  const message = document.getElementById('feedbackMessage');

  // Play sound effect
  if (isCorrect) {
    message.innerText = '‚úÖ';
    message.style.color = '#4CAF50';
    playWinnerSound();
  } else {
    message.innerText = '‚ùå';
    message.style.color = '#f44336';
    playFailSound();
  }

  overlay.style.display = 'flex';

  setTimeout(() => {
    overlay.style.display = 'none';
  }, 800);
}

// ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (winner)
// Unified audio helper: creates/caches audio elements and plays them
const _audioCache = {};
function _getAudioElement(key, srcs = []) {
  if (_audioCache[key]) return _audioCache[key];
  const audio = document.createElement('audio');
  audio.preload = 'auto';
  // prefer first provided src, but keep list for reference
  if (srcs && srcs.length > 0) audio.src = srcs[0];
  audio.style.display = 'none';
  document.body.appendChild(audio);
  _audioCache[key] = audio;
  return audio;
}

function playAudio(key, srcs = [], volume = 0.5) {
  if (typeof soundEnabled !== 'undefined' && !soundEnabled) return;
  try {
    const audio = _getAudioElement(key, srcs);
    if (!audio.src && srcs && srcs.length > 0) audio.src = srcs[0];
    // Use currentVolume if available, otherwise use the provided volume parameter
    const finalVolume = (typeof currentVolume !== 'undefined' && !isMuted) ? currentVolume * volume : volume;
    audio.volume = finalVolume;
    audio.currentTime = 0;
    const p = audio.play();
    if (p && typeof p.then === 'function') p.catch(() => {});
  } catch (e) {
    console.warn('playAudio error', e);
  }
}

function playWinnerSound() {
  // try common paths (case variations) to be resilient
  playAudio('winner', ['/Sound/winner.mp3', '/sound/winner.mp3'], 0.5);
}

function playFailSound() {
  playAudio('fail', ['/Sound/fail.mp3', '/sound/fail.mp3'], 0.5);
}


// particle effect
function createParticle(x, y) {
  const p = document.createElement('div');
  p.className = 'particle';
  p.innerText = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
  p.style.left = `${x}px`;
  p.style.top = `${y}px`;
  p.style.transform = `scale(${Math.random() * 1.5 + 0.5})`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 600);
}

// ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏≤‡∏Å
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const s = audioCtx.createBufferSource();
    s.connect(audioCtx.destination);
    s.start();
  }
}

function playSlideTone(freqStart, freqEnd) {
  if (!audioCtx || !soundEnabled) return;
  // Check if muted or volume is 0
  const effectiveVolume = (typeof currentVolume !== 'undefined' && !isMuted) ? currentVolume : 0;
  if (effectiveVolume === 0) return;
  
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freqStart, audioCtx.currentTime);
  osc.frequency.linearRampToValueAtTime(freqEnd, audioCtx.currentTime + 0.15);
  // Apply currentVolume to the gain (0.05 is base volume)
  gain.gain.setValueAtTime(0.05 * effectiveVolume, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
function createDraggableAnswer(answerText, answerId, isCorrect, optStartX, optStartY) {
  if (createdAnswers[answerId]) return;

  const answerDiv = document.createElement('div');
  answerDiv.classList.add('answer-item');
  answerDiv.textContent = answerText;

  // If provided, use explicit start positions (from loadQuestion layout planner)
  const answerWidth = 120; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (used for fallback)
  const startX = (typeof optStartX === 'number') ? optStartX : (50 + Math.random() * (window.innerWidth - 200));
  const startY = (typeof optStartY === 'number') ? optStartY : (window.innerHeight - 250); // ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á 250px

  answerDiv.style.left = `${startX}px`;
  answerDiv.style.top = `${startY}px`;
  answerDiv.style.transform = 'none';

  let offsetX, offsetY;
  
  function dragMove(posX, posY) {
    answerDiv.style.left = `${posX}px`;
    answerDiv.style.top = `${posY}px`;
    createParticle(posX + 50, posY + 50);
    playSlideTone(baseFreq, baseFreq + 400);
    baseFreq = baseFreq >= 800 ? 200 : baseFreq + 50;
  }

  // Desktop
  answerDiv.addEventListener('mousedown', e => {
    initAudio();
    e.preventDefault();
    offsetX = e.clientX - answerDiv.offsetLeft;
    offsetY = e.clientY - answerDiv.offsetTop;
    
    function onMove(e) {
      dragMove(e.clientX - offsetX, e.clientY - offsetY);
    }
    
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      checkDrop(answerDiv, answerId, isCorrect);
    }
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Mobile
  answerDiv.addEventListener('touchstart', e => {
    initAudio();
    const t = e.touches[0];
    offsetX = t.clientX - answerDiv.offsetLeft;
    offsetY = t.clientY - answerDiv.offsetTop;
  });
  
  answerDiv.addEventListener('touchmove', e => {
    const t = e.touches[0];
    dragMove(t.clientX - offsetX, t.clientY - offsetY);
  });
  
  answerDiv.addEventListener('touchend', e => {
    checkDrop(answerDiv, answerId, isCorrect);
  });

  document.body.appendChild(answerDiv);
  createdAnswers[answerId] = answerDiv;
}

function checkDrop(answerDiv, answerId, isCorrect) {
  const rect = answerDiv.getBoundingClientRect();
  const correctZone = document.getElementById('correctZone').getBoundingClientRect();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  if (rect.left + rect.width / 2 > correctZone.left && rect.left + rect.width / 2 < correctZone.right &&
      rect.top + rect.height / 2 > correctZone.top && rect.top + rect.height / 2 < correctZone.bottom) {
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const currentQuestion = allQuestions[currentQuestionIndex];
    userAnswers[currentQuestionIndex] = answerId;
    
    if (isCorrect) {
      // ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á = ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      showFeedback(true);
      score += 1;
      totalCorrectAnswers += 1;
      document.getElementById('score').innerText = score;
      setTimeout(() => nextQuestion(), 800);
    } else {
      // ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á = ‡∏ú‡∏¥‡∏î! ‡∏™‡∏Ñ‡∏¥‡∏õ‡πÑ‡∏õ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      showFeedback(false);
      totalWrongAnswers += 1;
      setTimeout(() => nextQuestion(), 800);
    }
  }
  // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á = ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÉ‡∏´‡∏°‡πà
}

// ‡πÑ‡∏õ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
function nextQuestion() {
  // ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  Object.values(createdAnswers).forEach(div => div.remove());
  createdAnswers = {};
  
  currentQuestionIndex++;
  
  if (currentQuestionIndex >= allQuestions.length) {
    // ‡∏´‡∏°‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏•‡πâ‡∏ß - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (score === allQuestions.length) {
      endGame('üéâ ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠!', '#4CAF50');
    } else {
      endGame('‚úÖ ‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', '#FF9807');
    }
  } else {
    // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    loadQuestion(currentQuestionIndex);
  }
}

// ‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
async function endGame(message, color) {
  document.getElementById('topicDisplay').innerText = teacherConfig.topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
  document.getElementById('playerNameDisplay').innerText = teacherConfig.userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
  document.getElementById('resultMessage').innerText = message;
  document.getElementById('resultMessage').style.color = color;
  document.getElementById('finalScore').innerText = `${score}/${allQuestions.length}`;
  document.getElementById('scorePopup').style.display = 'block';
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏á DB (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
  autoSaveGameResult();
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏ö‡πÄ‡∏Å‡∏° (‡∏Å‡∏£‡∏ì‡∏µ‡∏´‡∏°‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)
function checkEndGame() {
  if (Object.keys(createdAnswers).length === 0) {
    nextQuestion();
  }
}

function closePopup() {
  document.getElementById('scorePopup').style.display = 'none';
  // ‡∏õ‡∏¥‡∏î share menu ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
  const shareMenu = document.getElementById('shareMenu');
  if (shareMenu) shareMenu.style.display = 'none';
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ä‡∏£‡πå
function toggleShareMenu() {
  const menu = document.getElementById('shareMenu');
  if (menu.style.display === 'none' || menu.style.display === '') {
    menu.style.display = 'block';
  } else {
    menu.style.display = 'none';
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
function playAgain() {
  location.reload();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
async function shareResult(config) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    const thaiFontUrl = 'https://cdn.jsdelivr.net/gh/somkiat/jspdf-thai-support/fonts/THSarabunNew-normal.ttf';
    const fontData = await fetch(thaiFontUrl).then(res => res.arrayBuffer());
    doc.addFileToVFS('THSarabunNew.ttf', fontData);
    doc.addFont('THSarabunNew.ttf', 'THSarabunNew', 'normal');
    doc.setFont('THSarabunNew');

    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');

    const percentageScore = Math.min(100, Math.round((score / (allQuestions.length || 1)) * 100));

    let grade = '';
    if (percentageScore >= 80) {
      grade = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
    } else if (percentageScore >= 60) {
      grade = '‡∏î‡∏µ';
    } else if (percentageScore >= 40) {
      grade = '‡∏û‡∏≠‡πÉ‡∏à';
    } else {
      grade = '‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞';
    }

    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };

    const pdfContent = `
      <div style="font-family: 'THSarabunNew', sans-serif; color: #333; position: relative;">
        <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(-30deg); font-size:80px; color:rgba(0,0,0,0.05); font-weight:700; pointer-events:none; z-index:1; white-space:nowrap;">Espresso</div>
        <div style="position: absolute; top: 10px; right: 20px; font-size: 12px; color: #666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
        <div style="text-align: center; margin: 20px 0 15px 0; display:flex; align-items:center; justify-content:center; gap:18px;">
          <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:80px; width:auto;" crossorigin="anonymous" />
        </div>
        <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h1 style="margin: 5px 0; font-size: 24px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h1>
        </div>
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
          <p style="font-size: 13px; font-weight: bold; margin: 0 0 8px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <tr><td style="padding: 6px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.classroom || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '-'}</td></tr>
          </table>
        </div>
        <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
          <p style="font-size: 14px; margin: 0 0 10px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 36px; color: #000; font-weight: bold; margin: 0;">${score}/${allQuestions.length || 0}</p>
        </div>
        <div style="margin-top: 30px; text-align: center;">
          <p style="margin: 0; font-size: 12px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
          <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
          <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">( _______________________ )</p>
        </div>
        <div style="font-size: 11px; color: #666; text-align: right; margin-top: 20px; line-height: 1.3;">
          ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
          263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
          ‡πÇ‡∏ó‡∏£: 083-654-9743 | www.kwamgunlimit.com
        </div>
      </div>
    `;

    const element = document.createElement('div');
    element.innerHTML = pdfContent;

    html2pdf().set(opt).from(element).save();
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF');
  }
}

function calculateScore() {
  const totalQuestions = allQuestions.length;
  const percentageScore = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
  return `${score}/${totalQuestions} (${percentageScore}%)`;
}

function saveResult() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');

    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };

    const pdfContent = document.createElement('div');
    pdfContent.innerHTML = `
      <div style="font-family: 'Arial', sans-serif; color: #333; position: relative;">
        <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(-30deg); font-size:80px; color:rgba(0,0,0,0.05); font-weight:700; pointer-events:none; z-index:1; white-space:nowrap;">Espresso</div>
        <div style="position: absolute; top: 10px; right: 20px; font-size: 12px; color: #666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
        <div style="text-align: center; margin: 20px 0 15px 0; display:flex; align-items:center; justify-content:center; gap:18px;">
          <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:80px; width:auto;" crossorigin="anonymous" />
        </div>
        <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <h1 style="margin: 5px 0; font-size: 24px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h1>
        </div>
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
          <p style="font-size: 13px; font-weight: bold; margin: 0 0 8px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <tr><td style="padding: 6px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.classroom || '-'}</td></tr>
            <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '-'}</td></tr>
          </table>
        </div>
        <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
          <p style="font-size: 14px; margin: 0 0 10px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 36px; color: #000; font-weight: bold; margin: 0;">${score}/${allQuestions.length || 0}</p>
        </div>
        <div style="margin-top: 30px; text-align: center;">
          <p style="margin: 0; font-size: 12px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
          <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
          <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">( _______________________ )</p>
        </div>
        <div style="font-size: 11px; color: #666; text-align: right; margin-top: 20px; line-height: 1.3;">
          ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
          263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
          ‡πÇ‡∏ó‡∏£: 083-654-9743 | www.kwamgunlimit.com
        </div>
      </div>
    `;

    html2pdf().set(opt).from(pdfContent).save();
  } catch (error) {
    console.error('Error saving PDF:', error);
  }
}

// Build a reusable PDF element used by both download and share flows
function buildPdfElement() {
  const date = new Date();
  const dateStr = date.toLocaleDateString('th-TH');
  const timeStr = date.toLocaleTimeString('th-TH');

  const element = document.createElement('div');
  element.innerHTML = `
    <div style="font-family: 'Arial', sans-serif; color: #333; position: relative;">
      <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(-30deg); font-size:80px; color:rgba(0,0,0,0.05); font-weight:700; pointer-events:none; z-index:1; white-space:nowrap;">Espresso</div>
      <div style="position: absolute; top: 10px; right: 20px; font-size: 12px; color: #666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
      <div style="text-align: center; margin: 20px 0 15px 0; display:flex; align-items:center; justify-content:center; gap:18px;">
        <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:80px; width:auto;" crossorigin="anonymous" />
      </div>
      <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h1 style="margin: 5px 0; font-size: 24px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h1>
      </div>
      <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
        <p style="font-size: 13px; font-weight: bold; margin: 0 0 8px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
          <tr><td style="padding: 6px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.classroom || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '-'}</td></tr>
        </table>
      </div>
      <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
        <p style="font-size: 14px; margin: 0 0 10px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
        <p style="font-size: 36px; color: #000; font-weight: bold; margin: 0;">${score}/${allQuestions.length || 0}</p>
      </div>
      <div style="margin-top: 30px; text-align: center;">
        <p style="margin: 0; font-size: 12px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
        <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
        <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">( _______________________ )</p>
      </div>
      <div style="font-size: 11px; color: #666; text-align: right; margin-top: 20px; line-height: 1.3;">
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
        263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
        ‡πÇ‡∏ó‡∏£: 083-654-9743 | www.kwamgunlimit.com
      </div>
    </div>
  `;
  return element;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
async function shareScore() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');

    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };

    // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å #finalScore ‡πÉ‡∏ô popup ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô PDF
const finalScoreElement = document.getElementById('finalScore');
if (finalScoreElement) {
  score = parseInt(finalScoreElement.innerText, 10) || 0;
}

    // ‡πÉ‡∏ä‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å teacherConfig.correctImages
const totalQuestions = teacherConfig.correctImages.length || 0;

// Build PDF element
    const element = buildPdfElement();


    // create PDF blob
    const pdfBlob = await html2pdf().set(opt).from(element).output('blob')

    // Try to share the PDF file directly via Web Share API (files)
    try {
      const file = new File([pdfBlob], opt.filename, { type: 'application/pdf' })
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: 'Smart Classroom - ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', text: `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${score}/${allQuestions.length}` })
          return
        } catch (e) {
          console.warn('navigator.share with files failed:', e)
          // continue to fallback upload
        }
      }
    } catch (e) {
      console.warn('Direct file share not available or failed:', e)
    }

    // If direct file share isn't supported, fallback to upload+link flow
    // convert blob to dataURL
    const blobToDataURL = blob => new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = () => resolve(reader.result)
      reader.onerror = reject
      reader.readAsDataURL(blob)
    })
    const dataUrl = await blobToDataURL(pdfBlob)

    // upload to server (use absolute origin to avoid accidental localhost targets)
    console.debug('[SHARE] Uploading PDF to server...', { origin: location.origin })
    let uploadRes
    try {
      uploadRes = await fetch(`${location.origin}/uploadBase64`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: opt.filename, dataUrl })
      })
    } catch (e) {
      console.error('[SHARE] Network error while uploading PDF:', e)
      html2pdf().set(opt).from(element).save()
      return alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô')
    }

    let uploadJson = null
    if (!uploadRes.ok) {
      // Try to read server response for debugging
      let textBody = ''
      try { textBody = await uploadRes.text() } catch (e) { textBody = '<unreadable response>' }
      console.error('[SHARE] Upload failed', uploadRes.status, uploadRes.statusText, textBody)
      html2pdf().set(opt).from(element).save()
      return alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ' + uploadRes.status + ') ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô')
    }

    try {
      uploadJson = await uploadRes.json()
    } catch (e) {
      console.error('[SHARE] Failed to parse upload JSON response:', e)
      html2pdf().set(opt).from(element).save()
      return alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô')
    }

    if (!uploadJson || !uploadJson.success) {
      console.error('[SHARE] Upload endpoint returned failure:', uploadJson)
      html2pdf().set(opt).from(element).save()
      return alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡∏ô')
    }

    const publicUrl = uploadJson.url
    const shareText = `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${score}/${allQuestions.length}`

    // Fallback: show a small share modal with platform links and copy/download
    const encodedUrl = encodeURIComponent(publicUrl)
    const encodedText = encodeURIComponent(shareText)
    const platforms = [
      { id: 'line', label: 'LINE', url: `https://social-plugins.line.me/lineit/share?url=${encodedUrl}` },
      { id: 'whatsapp', label: 'WhatsApp', url: `https://api.whatsapp.com/send?text=${encodedText}%20${encodedUrl}` },
      { id: 'facebook', label: 'Facebook', url: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}` },
      { id: 'telegram', label: 'Telegram', url: `https://t.me/share/url?url=${encodedUrl}&text=${encodedText}` }
    ]

    // build modal
    let modal = document.getElementById('shareModal')
    if (modal) modal.remove()
    modal = document.createElement('div')
    modal.id = 'shareModal'
    modal.style = 'position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:20000;'
    const box = document.createElement('div')
    box.style = 'background:#fff;padding:18px;border-radius:12px;min-width:260px;max-width:90%;text-align:center;'
    const title = document.createElement('div')
    title.innerText = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏≠‡∏õ‡πÅ‡∏ä‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå'
    title.style = 'font-weight:700;margin-bottom:12px;'
    box.appendChild(title)

    platforms.forEach(p => {
      const b = document.createElement('button')
      b.innerText = p.label
      b.style = 'display:block;width:100%;margin:6px 0;padding:10px;border-radius:8px;background:#f0f0f0;border:none;cursor:pointer;font-weight:700'
      b.onclick = () => { window.open(p.url, '_blank'); }
      box.appendChild(b)
    })

    const copyBtn = document.createElement('button')
    copyBtn.innerText = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå'
    copyBtn.style = 'display:block;width:100%;margin:6px 0;padding:10px;border-radius:8px;background:#e0f7fa;border:none;cursor:pointer;font-weight:700'
    copyBtn.onclick = async () => { try { await navigator.clipboard.writeText(publicUrl); alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'); } catch (e) { alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); } }
    box.appendChild(copyBtn)

    const downloadBtn = document.createElement('button')
    downloadBtn.innerText = '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF'
    downloadBtn.style = 'display:block;width:100%;margin:6px 0;padding:10px;border-radius:8px;background:#fff3e0;border:none;cursor:pointer;font-weight:700'
    downloadBtn.onclick = () => { html2pdf().set(opt).from(element).save() }
    box.appendChild(downloadBtn)

    const closeBtn = document.createElement('button')
    closeBtn.innerText = '‡∏õ‡∏¥‡∏î'
    closeBtn.style = 'margin-top:10px;padding:8px 12px;border-radius:8px;'
    closeBtn.onclick = () => modal.remove()
    box.appendChild(closeBtn)

    modal.appendChild(box)
    document.body.appendChild(modal)

  } catch (error) {
    console.error('Error sharing PDF:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏ü‡∏•‡πå')
  }
}

function playAgain() {
  // ‡∏£‡∏µ‡πÄ‡∏ã‡∏ï‡πÄ‡∏Å‡∏°
  Object.values(createdAnswers).forEach(div => div.remove());
  createdAnswers = {};
  score = 0;
  currentQuestionIndex = 0;
  playCount++; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  document.getElementById('score').innerText = score;
  document.getElementById('scorePopup').style.display = 'none';
  
  // ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà
  initGame();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
async function generatePDFBase64() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    
    const pdfContent = document.createElement('div');
    pdfContent.innerHTML = `
      <div style="font-family: 'Arial', sans-serif; color: #333; padding: 15px;">
        <div style="position:absolute; left:50%; top:55%; transform:translate(-50%,-50%) rotate(45deg); font-size:160px; color:rgba(0,0,0,0.05); font-weight:400; pointer-events:none; z-index:9999; white-space:nowrap;">Espresso</div>
        <div style="position: absolute; top: 20px; right: 30px; font-size: 11px; color: #333;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
        <div style="text-align: center; margin: 35px 0 12px 0; display:flex; align-items:center; justify-content:center; gap:18px; flex-wrap:wrap;">
          <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:95px; width:auto; max-width:28%; margin-bottom:8px; display:block;" />
        </div>
        <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 18px; border-radius: 8px; margin-bottom: 18px;">
          <h1 style="margin: 5px 0; font-size: 28px;">Espresso</h1>
          <p style="margin: 5px 0; font-size: 16px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</p>
        </div>
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 14px; margin-bottom: 18px;">
          <p style="font-size: 13px; font-weight: bold; margin: 0 0 10px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <tr>
              <td style="padding: 7px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td>
              <td style="padding: 7px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            </tr>
            <tr>
              <td style="padding: 7px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</td>
              <td style="padding: 7px; border-bottom: 1px solid #eee;">${teacherConfig.classroom || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            </tr>
            <tr>
              <td style="padding: 7px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡πÇ‡∏à‡∏ó‡∏¢‡πå:</td>
              <td style="padding: 7px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            </tr>
            <tr>
              <td style="padding: 7px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</td>
              <td style="padding: 7px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
            </tr>
          </table>
        </div>
        <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 18px; margin-bottom: 18px; text-align: center;">
          <p style="font-size: 15px; margin: 0 0 12px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 26px; color: #000000; font-weight: bold;">${score}/${allQuestions.length}</p>
        </div>
        <div style="margin-top: 35px; text-align: center;">
          <p style="margin: 0; font-size: 12px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
          <p style="margin: 7px 0 0 0; font-size: 12px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
          <p style="margin: 7px 0 0 0; font-size: 12px; color: #333;">( _______________________ )</p>
        </div>
        <div style="margin-top: 50px; margin-right: 10px; text-align: right;">
          <p style="font-size: 11px; color: #333; line-height: 1.4; margin: 0;">
            ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
            263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
            ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà<br>
            ‡πÇ‡∏ó‡∏£ : 083-654-9743<br>
            ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå : www.kwamgunlimit.com
          </p>
        </div>
      </div>
    `;
    
    const opt = {
      margin: [10, 10, 10, 10],
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64
    const pdf = await html2pdf().set(opt).from(pdfContent).outputPdf('datauristring');
    return pdf; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ base64 string
  } catch (error) {
    console.error('Error generating PDF base64:', error);
    return null;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF (‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î)
function exportToPDF() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };
    const pdfContent = document.createElement('div');
    // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å localStorage (emojiGameConfig.userName)
    let userName = '-';
    try {
      const config = JSON.parse(localStorage.getItem('emojiGameConfig') || '{}');
      if (config.userName) userName = config.userName;
    } catch (e) {}

    pdfContent.innerHTML = `
      <div style="font-family: 'Arial', sans-serif; color: #333;">
         <div style="position:absolute; left:50%; top:60%; transform:translate(-50%,-50%) rotate(45deg); font-size:200px; color:rgba(0,0,0,0.07); font-weight:400; pointer-events:none; z-index:9999; white-space:nowrap;">Espresso</div>
      <div style="position: absolute; top: 1px; right: 12px; font-size: 12px; color: #333;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
      <div style="text-align: center; margin: 40px 0 12px 0; display:flex; align-items:center; justify-content:center; gap:18px; flex-wrap:wrap;">
                <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:110px; width:auto; max-width:30%; margin-bottom:10px; display:block;" />
      </div>
         <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h1 style="margin: 5px 0; font-size: 32px;">Espresso</h1>
        <p style="margin: 5px 0; font-size: 18px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</p>
      </div>
       <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <p style="font-size: 14px; font-weight: bold; margin: 0 0 10px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
  
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td>
            </tr>
          </table>
        </div>
      <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <p style="font-size: 16px; margin: 0 0 15px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 28px; color: #000000; font-weight: bold;">${score}/${teacherConfig.correctImages?.length || 0}</p>
        </div>

        <div style="margin-top: 65px; text-align: center;">
        <p style="margin: 0; font-size: 13px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: #333;">( _______________________ )</p>
      </div>
       <div id="companyContactWrapper" style="font-size: 14px; color: #333; text-align: right; line-height:1.1; margin-top: 80px;">
      <div style="display: inline-block; text-align: right;">
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
        263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
        ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà<br>
        ‡πÇ‡∏ó‡∏£ : 083-654-9743<br>
        ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå : www.kwangunlimit.com
      </div>
      </div>
    `;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô PDF
    const activityInfoTable = pdfContent.querySelector('table');
    const userNameRow = document.createElement('tr');
    userNameRow.innerHTML = `
      <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td>
      <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '-'}</td>
    `;

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    activityInfoTable.appendChild(userNameRow);

    html2pdf().set(opt).from(pdfContent).save();
  } catch (error) {
    console.error('Error saving PDF:', error);
  }
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô emojiGameConfig
const emojiGameConfig = JSON.parse(localStorage.getItem('emojiGameConfig') || '{}');
if (!emojiGameConfig.questions || emojiGameConfig.questions.length === 0) {
  console.warn('emojiGameConfig ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°');
  alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
} else {
  teacherConfig.correctImages = emojiGameConfig.questions;
}

// ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå
function loadQuestion(index) {
  if (!allQuestions || allQuestions.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    window.location.href = 'teachermatch.html';
    return;
  }

  const question = allQuestions[index];
  createdAnswers = {};
  
  // ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå
  document.getElementById('questionText').innerText = question.question;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  const imageContainer = document.getElementById('questionImage');
  const questionContainer = document.querySelector('.question-container');
  if (question.image) {
    imageContainer.innerHTML = `<img src="${question.image}" style="max-width: 50%; max-height: 120px; width: auto; height: auto; object-fit: contain; display: block; margin: 5px auto; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);" />`;
    // ‡∏•‡∏î padding ‡∏Ç‡∏≠‡∏á container ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏£‡∏π‡∏õ
    if (questionContainer) {
      questionContainer.style.padding = '15px';
      questionContainer.style.margin = '5px auto';
    }
  } else {
    imageContainer.innerHTML = '';
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ padding ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
    if (questionContainer) {
      questionContainer.style.padding = '20px';
      questionContainer.style.margin = '10px auto';
    }
  }

  // ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö
  const allAnswers = [];
  
  question.correctAnswers.forEach((answer, i) => {
    allAnswers.push({ text: answer, id: `correct-${i}`, isCorrect: true });
  });
  
  question.wrongAnswers.forEach((answer, i) => {
    allAnswers.push({ text: answer, id: `wrong-${i}`, isCorrect: false });
  });
  
  // ‡∏™‡∏∏‡πà‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
  allAnswers.sort(() => Math.random() - 0.5);

  // Layout planner: compute non-overlapping start positions for all answers
  const answerWidth = 120;
  const answerHeight = 220; // increased height to provide more vertical space between rows
  const hSpacing = 64; // increased horizontal spacing (doubled) to avoid overlap
  const vSpacing = 40; // vertical spacing between rows (doubled)
  const total = allAnswers.length;

  // available width with small horizontal margins
  const margin = 24;
  const availableWidth = Math.max(200, window.innerWidth - margin * 2);

  // how many columns can fit
  const maxCols = Math.max(1, Math.floor((availableWidth + hSpacing) / (answerWidth + hSpacing)));
  const cols = Math.min(total, maxCols);
  const rows = Math.ceil(total / cols);

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
  const zonesElement = document.getElementById('zones');
  let bottomY;
  
  if (zonesElement) {
    const zoneRect = zonesElement.getBoundingClientRect();
    // ‡∏ß‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏≠‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß 20px ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏£‡∏≠‡∏ö‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
    bottomY = zoneRect.bottom + 20;
  } else {
    // fallback: ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    bottomY = window.innerHeight - 200;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠ ‡πÇ‡∏î‡∏¢‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠
  allAnswers.forEach((answer, i) => {
    const row = Math.floor(i / cols);
    const col = i % cols;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ
    const colsInThisRow = (row === rows - 1) ? (total % cols || cols) : cols;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
    const rowWidth = colsInThisRow * answerWidth + (colsInThisRow - 1) * hSpacing;
    const baseX = Math.max(margin, (window.innerWidth - rowWidth) / 2);
    
    const x = baseX + col * (answerWidth + hSpacing);
    const y = bottomY - row * 10; // ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢
    createDraggableAnswer(answer.text, answer.id, answer.isCorrect, x, y);
  });
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏°)
function initGame() {
  if (!allQuestions || allQuestions.length === 0) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    window.location.href = 'teachermatch.html';
    return;
  }

  score = 0;
  currentQuestionIndex = 0;
  totalCorrectAnswers = 0;
  totalWrongAnswers = 0;
  document.getElementById('score').innerText = score;
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô
  gameStartTime = Date.now();
  
  // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÅ‡∏£‡∏Å
  loadQuestion(0);
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
initGame();

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô teacherConfig
if (!teacherConfig.correctImages || teacherConfig.correctImages.length === 0) {
  console.warn('teacherConfig.correctImages ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°');
  alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
}

if (score === undefined || score === null) {
  console.warn('score ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤');
  alert('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°');
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô teacherConfig
if (teacherConfig.correctImages.length !== allQuestions.length) {
  console.warn('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô teacherConfig.correctImages ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö allQuestions');
  alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
}
</script>

<!-- Removed the existing PDF generation logic and included the reusable script -->
<script src="js/pdfGenerator.js"></script>

<!-- Example usage of the reusable shareResult function -->
<script>
function generatePDF() {
  const config = {
    topic: document.getElementById('topicName').innerText,
    playerName: teacherConfig.playerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠',
    scoreText: document.getElementById('finalScore').innerText,
    resultMessage: document.getElementById('resultMessage').innerText
  };

  shareResult(config);
}
</script>
<!-- Socket client (connect + heartbeat) -->
<script src="/socket.io/socket.io.js"></script>
<script src="/socket-client.js"></script>

<!-- Sound toggle functionality -->
<script>
function toggleSound() {
  soundEnabled = !soundEnabled;
  isMuted = !soundEnabled; // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  localStorage.setItem('soundEnabled', soundEnabled ? 'true' : 'false');
  const soundButton = document.getElementById('soundToggleButton');
  if (soundButton) {
    soundButton.src = soundEnabled ? '/picture/open.png' : '/picture/close.png';
  }

  // Control all sounds including Web Audio API
  if (!soundEnabled) {
    if (audioCtx) audioCtx.suspend(); // Suspend AudioContext
    // Also mute HTML5 audio
    document.querySelectorAll('audio').forEach(audio => audio.volume = 0);
  } else {
    if (audioCtx) {
      audioCtx.resume(); // Resume AudioContext
    } else {
      initAudio(); // Initialize AudioContext if not already created
    }
    // Restore HTML5 audio volume
    const vol = (typeof currentVolume !== 'undefined' && !isMuted) ? currentVolume : 1.0;
    document.querySelectorAll('audio').forEach(audio => audio.volume = vol);
  }
  updateVolumeDisplay(); // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏ô‡∏ö‡∏≤‡∏£‡πå
}

function toggleVolumeBar() {
  const wrapper = document.getElementById('soundControlWrapper');
  if (wrapper) {
    wrapper.classList.toggle('show-volume');
  }
}

// Close volume bar when clicking outside
document.addEventListener('click', function(event) {
  const wrapper = document.getElementById('soundControlWrapper');
  if (wrapper && !wrapper.contains(event.target)) {
    wrapper.classList.remove('show-volume');
  }
});

// Prevent closing when clicking inside wrapper
document.addEventListener('DOMContentLoaded', function() {
  const wrapper = document.getElementById('soundControlWrapper');
  if (wrapper) {
    wrapper.addEventListener('click', function(event) {
      event.stopPropagation();
    });
  }
});
</script>

<!-- Sound Control with Volume -->
<div class="sound-control-wrapper" id="soundControlWrapper">
  <img class="sound-toggle-btn" id="soundToggleButton" onclick="toggleVolumeBar()" src="/picture/open.png" alt="Toggle Sound">
  
  <div class="volume-control">
    <div class="volume-icon" onclick="toggleMute()" id="volumeIcon">üîä</div>
    <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider" oninput="updateVolume(this.value)">
    <div class="volume-display" id="volumeDisplay">100%</div>
  </div>
</div>

<script>
// Volume Control Functions
let currentVolume = parseFloat(localStorage.getItem('gameVolume') || '1.0');
let isMuted = false;
let previousVolume = currentVolume;

function updateVolumeDisplay() {
  const percentage = Math.round(currentVolume * 100);
  const volumeDisplay = document.getElementById('volumeDisplay');
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeIcon = document.getElementById('volumeIcon');
  
  // ‡πÅ‡∏™‡∏î‡∏á 0% ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á slider ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  const displayPercentage = (isMuted || !soundEnabled) ? 0 : percentage;
  
  if (volumeDisplay) volumeDisplay.textContent = displayPercentage + '%';
  if (volumeSlider) volumeSlider.value = displayPercentage;
  localStorage.setItem('gameVolume', currentVolume.toString());
  
  // Update slider background gradient
  if (volumeSlider) {
    volumeSlider.style.background = `linear-gradient(to right, #8b6914 0%, #d4a574 ${displayPercentage}%, #ddd ${displayPercentage}%, #ddd 100%)`;
  }
  
  // Update volume icon
  if (volumeIcon) {
    if (displayPercentage === 0 || isMuted || !soundEnabled) {
      volumeIcon.innerHTML = '<img src="/picture/close.png" style="width: 24px; height: 24px; filter: brightness(0);">';
    } else if (displayPercentage < 50) {
      volumeIcon.innerHTML = '<img src="/picture/open.png" style="width: 24px; height: 24px; filter: brightness(0);">';
    } else {
      volumeIcon.innerHTML = '<img src="/picture/open.png" style="width: 24px; height: 24px; filter: brightness(0);">';
    }
  }
  
  // Update all audio elements
  document.querySelectorAll('audio').forEach(audio => {
    audio.volume = isMuted ? 0 : currentVolume;
  });
  
  // Update speech synthesis volume if supported
  if (window.speechSynthesis && window.currentSpeech) {
    window.currentSpeech.volume = isMuted ? 0 : currentVolume;
  }
}

function updateVolume(value) {
  currentVolume = value / 100;
  isMuted = false;
  updateVolumeDisplay();
}

function toggleMute() {
  if (isMuted) {
    isMuted = false;
    soundEnabled = true;
    currentVolume = previousVolume;
  } else {
    isMuted = true;
    soundEnabled = false;
    previousVolume = currentVolume;
  }
  
  localStorage.setItem('soundEnabled', soundEnabled ? 'true' : 'false');
  
  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏Å
  const soundButton = document.getElementById('soundToggleButton');
  if (soundButton) {
    soundButton.src = soundEnabled ? '/picture/open.png' : '/picture/close.png';
  }
  
  // Control AudioContext
  if (!soundEnabled && audioCtx) {
    audioCtx.suspend();
  } else if (soundEnabled && audioCtx) {
    audioCtx.resume();
  }
  
  updateVolumeDisplay();
}

// Initialize volume on page load
window.addEventListener('load', function() {
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
  const btn = document.getElementById('soundToggleButton');
  if (btn) btn.src = soundEnabled ? '/picture/open.png' : '/picture/close.png';
  isMuted = !soundEnabled;
  updateVolumeDisplay();
});
</script>

<script>
  try {
    localStorage.setItem('lastVisitedPage', location.pathname + location.search + location.hash);
  } catch (e) { /* ignore */ }
</script>
<script>
var __localUsageId_gamemath = null;
window.addEventListener('load', function(){
  try{
    if (window.usageTracker && typeof window.usageTracker.start === 'function') {
      const activityName = (function(){
        try { return JSON.parse(localStorage.getItem('emojiGameConfig')||'{}').topic || 'gamemath'; } catch(e){ return 'gamemath'; }
      })();
      __localUsageId_gamemath = window.usageTracker.start(location.pathname || 'gamemath.html', activityName);
      console.log('usage started (gamemath)', __localUsageId_gamemath);
    }
  }catch(e){ console.warn('usageTracker.start failed (gamemath)', e); }
});
window.addEventListener('beforeunload', function(){
  try{
    if (window.usageTracker && typeof window.usageTracker.end === 'function') {
      window.usageTracker.end(__localUsageId_gamemath);
    }
  }catch(e){}
});
</script>

  <div class="Version">V.11225</div>

</body>
</html>
