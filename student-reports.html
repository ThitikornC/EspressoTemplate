<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö - Espresso</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Roboto', sans-serif;
  background: linear-gradient(180deg, #ebd09e 0%, #251f03 100%);
  min-height: 100vh;
  padding: 20px;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 40px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.header {
  text-align: center;
  margin-bottom: 40px;
  padding-bottom: 20px;
  border-bottom: 3px solid #74640a;
}

.header h1 {
  font-size: 42px;
  color: #74640a;
  margin-bottom: 10px;
  font-weight: 700;
}

.header p {
  font-size: 18px;
  color: #666;
}

.filters {
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-group {
  flex: 1;
  min-width: 250px;
}

.filter-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #333;
  font-size: 16px;
}

.filter-group select,
.filter-group input {
  width: 100%;
  padding: 12px;
  border: 3px solid #74640a;
  border-radius: 12px;
  font-size: 16px;
  font-family: 'Roboto', sans-serif;
  background: white;
}

.btn-refresh {
  padding: 12px 30px;
  background: linear-gradient(180deg, #f8f6f0 0%, #fff8e8 100%);
  color: #000;
  border: 4px solid #74640a;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Roboto', sans-serif;
  transition: all 0.3s;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  align-self: flex-end;
}

.btn-refresh:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #f8f6f0 0%, #fff8e8 100%);
  border: 3px solid #74640a;
  border-radius: 15px;
  padding: 25px;
  text-align: center;
}

.stat-card h3 {
  font-size: 18px;
  color: #666;
  margin-bottom: 10px;
  font-weight: 500;
}

.stat-card .stat-value {
  font-size: 36px;
  color: #74640a;
  font-weight: 700;
}

.students-list {
  margin-top: 30px;
}

.student-card {
  background: white;
  border: 3px solid #74640a;
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 20px;
  transition: all 0.3s;
  cursor: pointer;
}

.student-card:hover {
  box-shadow: 0 6px 20px rgba(116, 100, 10, 0.3);
  transform: translateY(-2px);
}

.student-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.student-name {
  font-size: 24px;
  font-weight: 700;
  color: #74640a;
}

.student-classroom {
  font-size: 18px;
  color: #666;
  background: #f5f0e5;
  padding: 8px 16px;
  border-radius: 20px;
}

.results-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.result-item {
  text-align: center;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 10px;
}

.result-label {
  font-size: 14px;
  color: #666;
  margin-bottom: 5px;
}

.result-value {
  font-size: 20px;
  font-weight: 700;
  color: #74640a;
}

.test-history {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 2px solid #eee;
  display: none;
}

.test-history.expanded {
  display: block;
}

.test-item {
  background: #f8f9fa;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.test-info {
  flex: 1;
}

.test-topic {
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
}

.test-date {
  font-size: 14px;
  color: #999;
}

.test-score {
  font-size: 24px;
  font-weight: 700;
  color: #27ae60;
  min-width: 80px;
  text-align: right;
}

.no-data {
  text-align: center;
  padding: 60px 20px;
  color: #999;
  font-size: 18px;
}

.loading {
  text-align: center;
  padding: 40px;
  font-size: 20px;
  color: #74640a;
}

.btn-back {
  display: inline-block;
  padding: 12px 30px;
  background: linear-gradient(180deg, #e0e0e0 0%, #c0c0c0 100%);
  color: #333;
  border: 4px solid #999;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  text-decoration: none;
  font-family: 'Roboto', sans-serif;
  transition: all 0.3s;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  margin-bottom: 20px;
}

.btn-back:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.classroom-section {
  margin-bottom: 40px;
  background: white;
  border: 4px solid #74640a;
  border-radius: 20px;
  padding: 30px;
}

.classroom-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 3px solid #eee;
}

.classroom-title {
  font-size: 28px;
  font-weight: 700;
  color: #74640a;
}

.classroom-count {
  font-size: 18px;
  color: #666;
  background: #f5f0e5;
  padding: 8px 20px;
  border-radius: 20px;
}

.subject-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.subject-tab {
  padding: 12px 24px;
  background: #f5f0e5;
  border: 3px solid #c9a668;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  transition: all 0.3s;
}

.subject-tab:hover {
  background: #ebd09e;
  transform: translateY(-2px);
}

.subject-tab.active {
  background: linear-gradient(180deg, #f8f6f0 0%, #fff8e8 100%);
  border-color: #74640a;
  color: #74640a;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.subject-content {
  display: none;
}

.subject-content.active {
  display: block;
}

.question-details {
  background: #f8f9fa;
  border-radius: 10px;
  padding: 15px;
  margin-top: 10px;
}

.question-item {
  padding: 10px;
  margin-bottom: 8px;
  background: white;
  border-radius: 8px;
  border-left: 4px solid #74640a;
}

.question-text {
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
}

.question-answer {
  font-size: 14px;
  color: #666;
}

.answer-correct {
  color: #27ae60;
  font-weight: 600;
}

.answer-wrong {
  color: #e74c3c;
  font-weight: 600;
}

.btn-export-pdf {
  padding: 10px 20px;
  background: linear-gradient(180deg, #f8f6f0 0%, #fff8e8 100%);
  color: #000;
  border: 3px solid #74640a;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Roboto', sans-serif;
  transition: all 0.3s;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
}

.btn-export-pdf:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
}

.auto-save-indicator {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 12px 24px;
  background: #27ae60;
  color: white;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  display: none;
  z-index: 1000;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.test-item-detailed {
  background: white;
  border: 2px solid #eee;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 15px;
}

.test-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #f0f0f0;
}

</style>
</head>
<body>

<div class="container">
  <a href="menu.html" class="btn-back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
  
  <div class="header">
    <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h1>
    <p>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="classroomFilter">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
      <select id="classroomFilter">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="searchInput">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠:</label>
      <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö...">
    </div>
    
    <button class="btn-refresh" onclick="loadStudentReports()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    <button class="btn-export-pdf" onclick="exportAllReportsToPDF()">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
      <div class="stat-value" id="totalStudents">-</div>
    </div>
    <div class="stat-card">
      <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
      <div class="stat-value" id="totalClassrooms">-</div>
    </div>
    <div class="stat-card">
      <h3>‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
      <div class="stat-value" id="totalTests">-</div>
    </div>
    <div class="stat-card">
      <h3>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
      <div class="stat-value" id="averageScore">-</div>
    </div>
  </div>

  <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  <div id="studentsList" class="students-list" style="display: none;"></div>
  <div id="noData" class="no-data" style="display: none;">
    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö<br>
    <small>‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</small>
  </div>
  
  <div id="autoSaveIndicator" class="auto-save-indicator">
    ‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
  </div>
</div>

<script type="module">
import { getAllStudents, getStudentResults, getAllClassrooms } from '/js/mongodb-config.js';

let allStudents = [];
let allResults = [];
let groupedData = {};

const activityNames = {
  gamemath: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
  gamethai: '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢',
  gamepicture: '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û',
  gamecount: '‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
  gamewrite: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô'
};

window.loadStudentReports = async function() {
  const loading = document.getElementById('loading');
  const studentsList = document.getElementById('studentsList');
  const noData = document.getElementById('noData');
  
  loading.style.display = 'block';
  studentsList.style.display = 'none';
  noData.style.display = 'none';
  
  try {
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Database
    allStudents = await getAllStudents();
    const classrooms = await getAllClassrooms();
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
    allResults = [];
    for (const student of allStudents) {
      const results = await getStudentResults(student.name, student.classroom);
      allResults.push(...results.map(r => ({
        ...r,
        studentName: student.name,
        classroom: student.classroom
      })));
    }
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤
    groupDataByClassroomAndSubject();
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï filters
    updateClassroomFilter(classrooms);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    displayStudentReports();
    updateStatistics();
    
    // Auto-save ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
    autoSaveReports();
    
    loading.style.display = 'none';
  } catch (error) {
    console.error('Error loading student reports:', error);
    loading.innerHTML = '<span style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
  }
};

function groupDataByClassroomAndSubject() {
  groupedData = {};
  
  allStudents.forEach(student => {
    const classroom = student.classroom || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏±‡πâ‡∏ô';
    
    if (!groupedData[classroom]) {
      groupedData[classroom] = {
        students: [],
        subjects: {}
      };
    }
    
    // ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const studentResults = allResults.filter(r => 
      r.studentName === student.name && r.classroom === student.classroom
    );
    
    groupedData[classroom].students.push({
      ...student,
      results: studentResults
    });
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ä‡∏≤
    studentResults.forEach(result => {
      const subject = result.activityType || 'other';
      
      if (!groupedData[classroom].subjects[subject]) {
        groupedData[classroom].subjects[subject] = [];
      }
      
      groupedData[classroom].subjects[subject].push(result);
    });
  });
}

function updateClassroomFilter(classrooms) {
  const filter = document.getElementById('classroomFilter');
  filter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>';
  classrooms.forEach(classroom => {
    const option = document.createElement('option');
    option.value = classroom;
    option.textContent = classroom;
    filter.appendChild(option);
  });
}

function displayStudentReports() {
  const studentsList = document.getElementById('studentsList');
  const noData = document.getElementById('noData');
  const classroomFilter = document.getElementById('classroomFilter').value;
  const searchText = document.getElementById('searchInput').value.toLowerCase();
  
  let filteredClassrooms = Object.keys(groupedData);
  
  if (classroomFilter) {
    filteredClassrooms = filteredClassrooms.filter(c => c === classroomFilter);
  }
  
  if (filteredClassrooms.length === 0) {
    studentsList.style.display = 'none';
    noData.style.display = 'block';
    return;
  }
  
  studentsList.innerHTML = '';
  studentsList.style.display = 'block';
  noData.style.display = 'none';
  
  filteredClassrooms.forEach(classroom => {
    const classroomSection = createClassroomSection(classroom, searchText);
    if (classroomSection) {
      studentsList.appendChild(classroomSection);
    }
  });
}

function createClassroomSection(classroom, searchText) {
  const data = groupedData[classroom];
  
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  let filteredStudents = data.students;
  if (searchText) {
    filteredStudents = filteredStudents.filter(s => 
      s.name.toLowerCase().includes(searchText)
    );
  }
  
  if (filteredStudents.length === 0) return null;
  
  const section = document.createElement('div');
  section.className = 'classroom-section';
  section.id = `classroom-${classroom}`;
  
  const subjects = Object.keys(data.subjects);
  const defaultSubject = subjects[0] || 'all';
  
  section.innerHTML = `
    <div class="classroom-header">
      <div class="classroom-title">üè´ ${classroom}</div>
      <div class="classroom-count">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${filteredStudents.length} ‡∏Ñ‡∏ô</div>
    </div>
    
    <div class="subject-tabs">
      <div class="subject-tab active" data-subject="all" onclick="switchSubject('${classroom}', 'all')">
        üìö ‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤
      </div>
      ${subjects.map(subject => `
        <div class="subject-tab" data-subject="${subject}" onclick="switchSubject('${classroom}', '${subject}')">
          ${getSubjectIcon(subject)} ${activityNames[subject] || subject}
        </div>
      `).join('')}
    </div>
    
    <div class="subject-content active" data-subject="all">
      ${createStudentsList(filteredStudents, 'all')}
    </div>
    
    ${subjects.map(subject => `
      <div class="subject-content" data-subject="${subject}">
        ${createStudentsList(filteredStudents, subject)}
      </div>
    `).join('')}
  `;
  
  return section;
}

function getSubjectIcon(subject) {
  const icons = {
    gamemath: 'üî¢',
    gamethai: 'üìñ',
    gamepicture: 'üñºÔ∏è',
    gamecount: 'üî¢',
    gamewrite: '‚úçÔ∏è'
  };
  return icons[subject] || 'üìù';
}

function createStudentsList(students, subject) {
  return students.map(student => {
    const results = subject === 'all' 
      ? student.results 
      : student.results.filter(r => r.activityType === subject);
    
    if (results.length === 0 && subject !== 'all') return '';
    
    return createStudentCard(student, results);
  }).filter(html => html).join('');
}

function createStudentCard(student, results) {
  const totalTests = results.length;
  const totalScore = results.reduce((sum, r) => sum + (r.score || 0), 0);
  const totalPossible = results.reduce((sum, r) => sum + (r.totalQuestions || 0), 0);
  const averagePercentage = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;
  
  return `
    <div class="student-card">
      <div class="student-header">
        <div class="student-name">üë§ ${student.name}</div>
        ${student.classroom ? `<div class="student-classroom">${student.classroom}</div>` : ''}
      </div>
      
      <div class="results-summary">
        <div class="result-item">
          <div class="result-label">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥</div>
          <div class="result-value">${totalTests}</div>
        </div>
        <div class="result-item">
          <div class="result-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
          <div class="result-value">${totalScore}/${totalPossible}</div>
        </div>
        <div class="result-item">
          <div class="result-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
          <div class="result-value">${averagePercentage}%</div>
        </div>
        <div class="result-item">
          <div class="result-label">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div class="result-value" style="font-size: 14px;">
            ${results.length > 0 ? new Date(results[results.length - 1].timestamp).toLocaleDateString('th-TH') : '-'}
          </div>
        </div>
      </div>
      
      ${createDetailedTestHistory(results)}
    </div>
  `;
}

function createDetailedTestHistory(results) {
  if (results.length === 0) {
    return '<div style="text-align: center; color: #999; padding: 20px; margin-top: 15px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>';
  }
  
  return `
    <div style="margin-top: 20px;">
      <h4 style="margin-bottom: 15px; color: #74640a; font-size: 18px;">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h4>
      ${results.map((result, index) => createDetailedTestItem(result, index + 1)).join('')}
    </div>
  `;
}

function createDetailedTestItem(result, index) {
  const date = new Date(result.timestamp);
  const percentage = result.totalQuestions > 0 
    ? Math.round((result.score / result.totalQuestions) * 100)
    : 0;
  
  const gradeColor = percentage >= 80 ? '#27ae60' : percentage >= 50 ? '#f39c12' : '#e74c3c';
  const uniqueId = `test-${result.id || Math.random().toString(36).substr(2, 9)}`;
  
  return `
    <div class="test-item-detailed">
      <div class="test-item-header">
        <div>
          <div style="font-weight: 700; color: #74640a; font-size: 18px; margin-bottom: 5px;">
            ${index}. ${activityNames[result.activityType] || result.activityType}
          </div>
          <div style="font-size: 14px; color: #999;">
            üìÖ ${date.toLocaleDateString('th-TH', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 28px; font-weight: 700; color: ${gradeColor};">
            ${result.score}/${result.totalQuestions}
          </div>
          <div style="font-size: 14px; color: #666;">(${percentage}%)</div>
        </div>
      </div>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 10px;">
        <div style="font-weight: 600; color: #333; margin-bottom: 10px;">
          üìã ‡πÇ‡∏à‡∏ó‡∏¢‡πå: ${result.topic || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
        </div>
        
        ${result.pdfBase64 ? `
          <div style="margin-bottom: 15px;">
            <button onclick="downloadPDFFromBase64('${result.pdfBase64}', '${result.topic || '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'}_${date.toLocaleDateString('th-TH').replace(/\//g, '-')}.pdf')" 
              style="padding: 10px 20px; background: linear-gradient(180deg, #f8f6f0 0%, #fff8e8 100%); color: #000; 
              border: 3px solid #74640a; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; 
              font-family: 'Roboto', sans-serif; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);">
              üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF
            </button>
          </div>
        ` : ''}
        
        ${result.questions && result.questions.length > 0 ? `
          <div class="question-details">
            <div style="font-weight: 600; margin-bottom: 10px; color: #74640a;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:</div>
            ${result.questions.map((q, i) => `
              <div class="question-item">
                <div class="question-text">‡∏Ç‡πâ‡∏≠ ${i + 1}: ${q.question || q.text || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°'}</div>
                <div class="question-answer">
                  ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <span class="${q.isCorrect ? 'answer-correct' : 'answer-wrong'}">
                    ${q.userAnswer || '-'} ${q.isCorrect ? '‚úì ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' : '‚úó ‡∏ú‡∏¥‡∏î (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ' + (q.correctAnswer || '-') + ')'}
                  </span>
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
        
        ${result.timeSpent ? `
          <div style="margin-top: 10px; color: #666; font-size: 14px;">
            ‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: ${Math.floor(result.timeSpent / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ ${result.timeSpent % 60} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

window.switchSubject = function(classroom, subject) {
  const section = document.getElementById(`classroom-${classroom}`);
  if (!section) return;
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï tabs
  section.querySelectorAll('.subject-tab').forEach(tab => {
    if (tab.dataset.subject === subject) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï content
  section.querySelectorAll('.subject-content').forEach(content => {
    if (content.dataset.subject === subject) {
      content.classList.add('active');
    } else {
      content.classList.remove('active');
    }
  });
};

function updateStatistics() {
  const totalStudents = allStudents.length;
  const classrooms = new Set(allStudents.map(s => s.classroom).filter(c => c)).size;
  const totalTests = allResults.length;
  
  const totalScore = allResults.reduce((sum, r) => sum + (r.score || 0), 0);
  const totalPossible = allResults.reduce((sum, r) => sum + (r.totalQuestions || 0), 0);
  const averagePercentage = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;
  
  document.getElementById('totalStudents').textContent = totalStudents;
  document.getElementById('totalClassrooms').textContent = classrooms;
  document.getElementById('totalTests').textContent = totalTests;
  document.getElementById('averageScore').textContent = averagePercentage + '%';
}

function autoSaveReports() {
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á localStorage
  const reportData = {
    timestamp: new Date().toISOString(),
    classrooms: groupedData,
    totalStudents: allStudents.length,
    totalTests: allResults.length
  };
  
  localStorage.setItem('student_reports_backup', JSON.stringify(reportData));
  
  // ‡πÅ‡∏™‡∏î‡∏á indicator
  const indicator = document.getElementById('autoSaveIndicator');
  indicator.style.display = 'block';
  setTimeout(() => {
    indicator.style.display = 'none';
  }, 3000);
}

window.exportAllReportsToPDF = async function() {
  const classroomFilter = document.getElementById('classroomFilter').value;
  let classroomsToExport = classroomFilter ? [classroomFilter] : Object.keys(groupedData);
  
  for (const classroom of classroomsToExport) {
    await exportClassroomToPDF(classroom);
    // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á export ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
};

async function exportClassroomToPDF(classroom) {
  const data = groupedData[classroom];
  if (!data) return;
  
  const date = new Date();
  const dateStr = date.toLocaleDateString('th-TH', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  const timeStr = date.toLocaleTimeString('th-TH', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  const element = document.createElement('div');
  element.innerHTML = `
    <div style="font-family: 'Arial', sans-serif; color: #333; padding: 20px;">
      <div style="position:absolute; left:50%; top:55%; transform:translate(-50%,-50%) rotate(45deg); font-size:180px; color:rgba(0,0,0,0.04); font-weight:400; pointer-events:none; z-index:9999; white-space:nowrap;">Espresso</div>
      
      <div style="text-align: center; margin-bottom: 20px;">
        <h1 style="font-size: 32px; color: #74640a; margin-bottom: 10px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h1>
        <p style="font-size: 16px; color: #666;">‡∏ä‡∏±‡πâ‡∏ô: ${classroom}</p>
        <p style="font-size: 14px; color: #999;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #74640a; margin-bottom: 10px;">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${data.students.length} ‡∏Ñ‡∏ô</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤:</td>
            <td style="padding: 8px; border: 1px solid #ddd;">${Object.keys(data.subjects).length} ‡∏ß‡∏¥‡∏ä‡∏≤</td>
          </tr>
        </table>
      </div>
      
      <h3 style="color: #74640a; margin-bottom: 10px;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h3>
      ${data.students.map((student, index) => `
        <div style="margin-bottom: 20px; padding: 15px; border: 2px solid #74640a; border-radius: 10px; page-break-inside: avoid;">
          <h4 style="color: #74640a; margin-bottom: 10px;">${index + 1}. ${student.name}</h4>
          ${student.results.length > 0 ? `
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
              <thead>
                <tr style="background: #f5f0e5;">
                  <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">‡∏ß‡∏¥‡∏ä‡∏≤</th>
                  <th style="padding: 6px; border: 1px solid #ddd; text-align: left;">‡πÇ‡∏à‡∏ó‡∏¢‡πå</th>
                  <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                  <th style="padding: 6px; border: 1px solid #ddd; text-align: center;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                </tr>
              </thead>
              <tbody>
                ${student.results.map(r => {
                  const testDate = new Date(r.timestamp);
                  const percentage = r.totalQuestions > 0 ? Math.round((r.score / r.totalQuestions) * 100) : 0;
                  return `
                    <tr>
                      <td style="padding: 6px; border: 1px solid #ddd;">${activityNames[r.activityType] || r.activityType}</td>
                      <td style="padding: 6px; border: 1px solid #ddd;">${r.topic || '-'}</td>
                      <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${r.score}/${r.totalQuestions} (${percentage}%)</td>
                      <td style="padding: 6px; border: 1px solid #ddd; text-align: center; font-size: 11px;">${testDate.toLocaleDateString('th-TH')}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          ` : '<p style="color: #999; text-align: center; padding: 10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>'}
        </div>
      `).join('')}
      
      <div style="margin-top: 30px; text-align: right; font-size: 12px; color: #666;">
        <p>‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î</p>
        <p>263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000</p>
        <p>‡πÇ‡∏ó‡∏£: 083-654-9743 | www.kwamgunlimit.com</p>
      </div>
    </div>
  `;
  
  const opt = {
    margin: 10,
    filename: `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö_${classroom}_${date.toLocaleDateString('th-TH').replace(/\//g, '-')}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  
  await html2pdf().set(opt).from(element).save();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF ‡∏à‡∏≤‡∏Å base64
window.downloadPDFFromBase64 = function(base64String, filename) {
  try {
    // ‡∏•‡∏ö prefix 'data:application/pdf;base64,' ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    const base64Data = base64String.replace(/^data:application\/pdf;base64,/, '');
    
    // ‡πÅ‡∏õ‡∏•‡∏á base64 ‡πÄ‡∏õ‡πá‡∏ô binary
    const binary = atob(base64Data);
    const array = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      array[i] = binary.charCodeAt(i);
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Blob ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
    const blob = new Blob([array], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    console.log('PDF downloaded successfully:', filename);
  } catch (error) {
    console.error('Error downloading PDF:', error);
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF');
  }
};

// Event listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö filters
document.getElementById('classroomFilter').addEventListener('change', displayStudentReports);
document.getElementById('searchInput').addEventListener('input', displayStudentReports);

// Auto-save ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
setInterval(autoSaveReports, 5 * 60 * 1000);

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
window.loadStudentReports();
</script>

</body>
</html>
