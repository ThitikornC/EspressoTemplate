<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/gamepicture.css">
<script src="/js/prevent-image-download.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script type="module">
  import { showStudentInputDialog, saveStudentTestResult } from '/js/studentInput.js';
  window.showStudentInputDialog = showStudentInputDialog;
  window.saveStudentTestResult = saveStudentTestResult;
</script>
<script>
let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á

function toggleSound() {
  soundEnabled = !soundEnabled;
  isMuted = !soundEnabled;
  localStorage.setItem('soundEnabled', soundEnabled ? 'true' : 'false');
  const soundButton = document.getElementById('soundToggleButton');
  if (soundButton) {
    soundButton.src = soundEnabled ? '/picture/open.png' : '/picture/close.png';
  }
  updateVolumeDisplay();
}

function toggleVolumeBar() {
  const wrapper = document.getElementById('soundControlWrapper');
  if (wrapper) {
    wrapper.classList.toggle('show-volume');
  }
}

// Close volume bar when clicking outside
document.addEventListener('click', function(event) {
  const wrapper = document.getElementById('soundControlWrapper');
  if (wrapper && !wrapper.contains(event.target)) {
    wrapper.classList.remove('show-volume');
  }
});

// Prevent closing when clicking inside wrapper
document.addEventListener('DOMContentLoaded', function() {
  const wrapper = document.getElementById('soundControlWrapper');
  if (wrapper) {
    wrapper.addEventListener('click', function(event) {
      event.stopPropagation();
    });
  }
});

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏µ‡πÉ‡∏à‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå winner.mp3
function playSuccessSound() {
  if (!soundEnabled) return; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô
  try {
    let audio = document.getElementById('winner-audio');
    if (!audio) {
      audio = document.createElement('audio');
      audio.id = 'winner-audio';
      audio.src = '/Sound/winner.mp3';
      audio.preload = 'auto';
      document.body.appendChild(audio);
    }
    audio.volume = currentVolume || 1.0; // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
    audio.currentTime = 0;
    audio.play();
  } catch (e) {}
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå fail.mp3
function playFailSound() {
  if (!soundEnabled) return; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô
  try {
    let audio = document.getElementById('fail-audio');
    if (!audio) {
      audio = document.createElement('audio');
      audio.id = 'fail-audio';
      audio.src = '/Sound/fail.mp3';
      audio.preload = 'auto';
      document.body.appendChild(audio);
    }
    audio.volume = currentVolume || 1.0; // ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
    audio.currentTime = 0;
    audio.play();
  } catch (e) {}
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å
function playDraggingSound() {
  if (!soundEnabled || !audioCtx) return; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞ AudioContext

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = 'sine';
  osc.frequency.setValueAtTime(baseFreq, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);

  baseFreq = baseFreq >= 800 ? 200 : baseFreq + 50; // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô initAudio ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô AudioContext
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const s = audioCtx.createBufferSource();
    s.connect(audioCtx.destination);
    s.start();
  }
}

</script>
<style>
  /* Override zone styling: larger touch targets and colored dashed borders */
  #zones { display:flex; gap:16px; justify-content:center; align-items:center; }
  #zones .zone {
    width: 40%;
    height: 260px; /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏à‡∏≤‡∏Å 380px */
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 72px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    transition: transform 0.12s ease, box-shadow 0.12s ease;
    position: relative;
  }
  #zones .zone:active { transform: scale(0.98); }
  .zone-label {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 18px;
    font-weight: 700;
    color: inherit;
  }
  /* Correct / Wrong zone styling (static glow, no animation) */
  #correctZone { 
    border: 4px dashed #27ae60; 
    color: #27ae60; 
    box-shadow: 0 10px 30px rgba(14, 226, 17, 0.1); 
    background: linear-gradient(135deg, #e0ffe8 0%, #b2f7c1 100%);
  }
  #wrongZone { 
    border: 4px dashed #e74c3c; 
    color: #e74c3c; 
    box-shadow: 0 10px 30px rgba(231,76,60,0.10); 
    background: linear-gradient(135deg, #ffe0e0 0%, #f7b2b2 100%);
  }

  /* neon-btn: center text, auto width, neon border, responsive */
  /* neon-btn: center text, auto width, neon border, responsive */
  .neon-btn {
    background: linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
    color: #000000;
    border: 6px solid #74640a;
    border-radius: 9999px;
    box-shadow: 1px 1px 0 #000, -4px 3px #3b3305, 0 0 10px rgba(255, 0, 0, 0.45);
    font-weight: 700;
    font-size: clamp(0.9rem, 1.2vw, 1.1rem);
    text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3), 0 -1px 0 rgba(0, 0, 0, 0.1);
    position: relative;
    padding: 6px 16px;
    transform: translateZ(0);
    transition: all 0.3s ease;
    z-index: 10;
    min-height: 32px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
    margin-right: auto;
    width: fit-content;
    text-align: center;
  }

  #scorePopup {
    background: linear-gradient(135deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
    border: 6px solid #74640a;
    box-shadow: 0 0 40px rgba(116, 100, 10, 0.5), 0 10px 30px rgba(0,0,0,0.3);
  }

  /* Adjust image size for larger display */
  #zones .zone img {
    max-width: 100%;
    max-height: 98%;
    object-fit: contain;
  }
  @media (max-width: 768px) {
  #soundToggleButton {
    right: 20px !important; /* Ensure the rule is applied */
    top: 25px !important; /* Adjust top position for better alignment */

  }
}

/* Volume Control Styles - YouTube Style */
.sound-control-wrapper {
  position: fixed;
  top: 15px;
  right: 50px;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 10px;
}

.sound-toggle-btn {
  width: 50px;
  height: 50px;
  cursor: pointer;
  transition: transform 0.2s;
}

.sound-toggle-btn:hover {
  transform: scale(1.1);
}

.sound-control-wrapper.show-volume .sound-toggle-btn {
  display: none;
}

.volume-control {
  display: none;
  align-items: center;
  gap: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 15px;
  border-radius: 25px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  opacity: 0;
  transform: translateX(10px);
}

.sound-control-wrapper.show-volume .volume-control {
  display: flex;
  opacity: 1;
  transform: translateX(0);
}

.volume-icon {
  font-size: 24px;
  cursor: pointer;
  transition: transform 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
}

.volume-icon:hover {
  transform: scale(1.1);
}

.volume-slider {
  -webkit-appearance: none;
  appearance: none;
  width: 100px;
  height: 4px;
  border-radius: 2px;
  background: #ddd;
  outline: none;
  transition: all 0.2s;
}

.volume-slider:hover {
  height: 6px;
}

.volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.volume-slider::-webkit-slider-thumb:hover {
  transform: scale(1.3);
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
}

.volume-slider::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.volume-slider::-moz-range-thumb:hover {
  transform: scale(1.3);
  box-shadow: 0 3px 10px rgba(0,0,0,0.4);
}

.volume-display {
  min-width: 40px;
  text-align: center;
  font-weight: 700;
  font-size: 14px;
  color: #333;
}

@media (max-width: 768px) {
  .sound-control-wrapper {
    right: 20px;
    top: 10px;
  }
  .sound-toggle-btn {
    width: 40px;
    height: 40px;
  }
  .volume-icon {
    font-size: 20px;
  }
  .volume-slider {
    width: 80px;
  }
  .volume-control {
    padding: 8px 12px;
  }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<h2 class="neon-btn">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: <span id="topicName"></span></h2>
<p id="scoreDisplay" style="display:none; font-size:26px; font-weight:700; color:#333; margin:18px 0 6px 0;">Score: <span id="score" style="font-size:34px; color:#27ae60;">0</span></p>



<div id="zones" style="display:none;">
  <div id="correctZone" class="zone"><div class="zone-label"></div>‚úîÔ∏è</div>
  <div id="wrongZone" class="zone"><div class="zone-label"></div>‚ùå</div>
</div>

<!-- Popup -->
<div id="scorePopup">
  <p style="font-size:20px; font-weight:600; margin-bottom:8px; color:#3b3305;">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: <span id="topicDisplay"></span></p>
  <p id="resultMessage" style="font-size:28px; font-weight:700; margin-bottom:15px;"></p>
  <p style="font-size:32px; font-weight:700; margin:20px 0; color:#74640a;">üèÜ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: <span id="finalScore" style="color:#8b6914;">0/0</span> ‚≠ê</p>
  
  <div style="display: flex; justify-content: center; gap: 15px; margin: 25px 0;">
    <button onclick="playAgain()" title="‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" style="background: linear-gradient(135deg, #c9a668 0%, #a68944 100%); color: white; border: 4px solid #74640a; border-radius: 50%; width: 75px; height: 75px; cursor: pointer; font-size: 38px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      <span style="color: #4dd0e1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">üîÑ</span>
    </button>
    <div style="position: relative;">
      <button onclick="toggleShareMenu()" title="‡πÅ‡∏ä‡∏£‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="background: linear-gradient(135deg, #a68944 0%, #8b7530 100%); color: white; border: 4px solid #74640a; border-radius: 50%; width: 75px; height: 75px; cursor: pointer; font-size: 38px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        <span style="color: #ff6b9d; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));">üìä</span>
      </button>
      <div id="shareMenu" style="display: none; position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #f8f6f0 0%, #fff8e8 100%); border-radius: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; min-width: 180px; z-index: 10000; border: 4px solid #74640a;">
        <button onclick="saveResult(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #d4a574, #8b6914); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; border-top: 2px solid rgba(255,255,255,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #c9a668, #74640a)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #d4a574, #8b6914)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üíæ</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
        </button>
      </div>
    </div>
    <button onclick="closePopup()" title="‡∏õ‡∏¥‡∏î" style="background: linear-gradient(135deg, #8b7530 0%, #6d5e26 100%); color: white; border: 4px solid #5a4d08; border-radius: 50%; width: 75px; height: 75px; cursor: pointer; font-size: 42px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.2s; font-weight: 700;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      ‚úï
    </button>
  </div>
</div>
  <p style="font-size:20px; font-weight:600; margin-bottom:8px; color:#555;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: <span id="topicDisplay"></span></p>
  <p style="font-size:24px; font-weight:600; margin-bottom:10px; color:#666;">‡∏ä‡∏∑‡πà‡∏≠: <span id="playerNameDisplay"></span></p>
  <p id="resultMessage" style="font-size:28px; font-weight:700; margin-bottom:15px;"></p>
  <p style="font-size:32px; font-weight:700; margin:20px 0;">üéâ Your Score: <span id="finalScore"></span> üéâ</p>
  
  <div style="display: flex; justify-content: center; gap: 15px; margin: 25px 0;">
    <button onclick="playAgain()" title="‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      üîÑ
    </button>
    <div style="position: relative;">
      <button onclick="toggleShareMenu()" title="‡πÅ‡∏ä‡∏£‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        üîó
      </button>
      <div id="shareMenu" style="display: none; position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%); border-radius: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; min-width: 180px; z-index: 10000; border: 3px solid #2196F3;">
        <!--<button onclick="shareResult(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #2196F3, #1E88E5); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #1976D2, #1565C0)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #2196F3, #1E88E5)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üîó</span> ‡πÅ‡∏ä‡∏£‡πå
        </button>-->
        <button onclick="saveResult(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; border-top: 2px solid rgba(255,255,255,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #F57C00, #E65100)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #FF9800, #F57C00)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üì•</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        </button>
      </div>
    </div>
    <button onclick="closePopup()" title="‡∏õ‡∏¥‡∏î" style="background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      ‚úñ
    </button>
  </div>
</div>

<!-- Added a modal for selecting saved activities -->
<div id="activityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <h2 style="margin: 0 0 20px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h2>
    <div id="activityList"></div>
    <button onclick="closeActivityModal()" style="margin-top: 20px; padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
let audioCtx, baseFreq = 200;
const sparkleChars = ['‚ú®', 'üåü', 'üí´', '‚≠ê'];
let createdImages = {};
let score = 0;
let gameStarted = false;
// usage tracking id for this page session
let __localUsageId = null;
let gameStartTime = null; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ
function generateReportHTML(data) {
  const { dateStr, timeStr, percentage, scoreVal, total, userName, topic, unit, week, teacher } = data;
  
  let grade = '';
  if (percentage >= 80) grade = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
  else if (percentage >= 60) grade = '‡∏î‡∏µ';
  else if (percentage >= 40) grade = '‡∏û‡∏≠‡πÉ‡∏à';
  else grade = '‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';

  return `
    <div style="font-family: 'Arial', sans-serif; color: #333; width: 600px; padding: 20px; background: white;">
      <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(-30deg); font-size:80px; color:rgba(0,0,0,0.05); font-weight:700; pointer-events:none; z-index:1; white-space:nowrap;">Espresso</div>
      <div style="position: absolute; top: 10px; right: 20px; font-size: 12px; color: #666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
      <div style="text-align: center; margin: 20px 0 15px 0; display:flex; align-items:center; justify-content:center; gap:18px;">
        <img src="/picture/Huaroa.jpg" alt="Logo Huaroa" style="height:80px; width:auto;" crossorigin="anonymous" />
        <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:80px; width:auto;" crossorigin="anonymous" />
      </div>
      <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h1 style="margin: 5px 0; font-size: 24px;">Espresso</h1>
        <p style="margin: 5px 0; font-size: 14px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ</p>
      </div>
      <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
        <p style="font-size: 13px; font-weight: bold; margin: 0 0 8px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
          <tr><td style="padding: 6px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${week || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${topic || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${unit || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${teacher || '-'}</td></tr>
          <tr><td style="padding: 6px; font-weight: bold; border-bottom: 1px solid #eee;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td><td style="padding: 6px; border-bottom: 1px solid #eee;">${userName || '-'}</td></tr>
        </table>
      </div>
      <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 15px; margin-bottom: 15px; text-align: center;">
        <p style="font-size: 14px; margin: 0 0 10px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
        <p style="font-size: 36px; color: #000; font-weight: bold; margin: 0;">${scoreVal}/${total}</p>
      </div>
      <div style="margin-top: 30px; text-align: center;">
        <p style="margin: 0; font-size: 12px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
        <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
        <p style="margin: 6px 0 0 0; font-size: 12px; color: #333;">( _______________________ )</p>
      </div>
      <div style="font-size: 11px; color: #666; text-align: right; margin-top: 20px; line-height: 1.3;">
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
        263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
        ‡πÇ‡∏ó‡∏£: 083-654-9743 | www.kwamgunlimit.com
      </div>
    </div>
  `;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á HTML ‡πÄ‡∏õ‡πá‡∏ô PNG base64
async function generateReportImage() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    const totalQ = teacherConfig.correctImages?.length || 1;
    const percentage = Math.min(100, Math.round((score / totalQ) * 100));
    
    const reportData = {
      dateStr, timeStr, percentage,
      scoreVal: score,
      total: totalQ,
      userName: teacherConfig.userName,
      topic: teacherConfig.mainTopic || teacherConfig.topic,
      unit: teacherConfig.unit,
      week: teacherConfig.week,
      teacher: teacherConfig.teacher
    };
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö render
    const tempDiv = document.createElement('div');
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    tempDiv.style.top = '0';
    tempDiv.innerHTML = generateReportHTML(reportData);
    document.body.appendChild(tempDiv);
    
    // ‡πÉ‡∏ä‡πâ html2canvas ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô canvas
    const canvas = await html2canvas(tempDiv.firstElementChild, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff'
    });
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô base64 PNG
    const base64Image = canvas.toDataURL('image/png');
    
    // ‡∏•‡∏ö element ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    document.body.removeChild(tempDiv);
    
    return base64Image;
  } catch (e) {
    console.error('[ReportImage] Error generating image:', e);
    return null;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏á DB
async function autoSaveGameResult() {
  try {
    // ‡∏î‡∏∂‡∏á clientId ‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ cookie
    let clientId = localStorage.getItem('huaroa_client_id');
    if (!clientId) {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á clientId ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
      clientId = 'c-' + Math.random().toString(36).slice(2) + '-' + Date.now().toString(36);
      localStorage.setItem('huaroa_client_id', clientId);
    }
    
    const endTime = Date.now();
    const duration = gameStartTime ? (endTime - gameStartTime) : null;
    const totalImages = (teacherConfig.correctImages?.length || 0) + (teacherConfig.wrongImages?.length || 0);
    const percentage = totalImages > 0 ? Math.round((score / (teacherConfig.correctImages?.length || 1)) * 100) : 0;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PNG base64
    const reportImage = await generateReportImage();
    
    const payload = {
      clientId,
      gameType: 'gamepicture',
      topic: teacherConfig.mainTopic || teacherConfig.topic || null,
      unit: teacherConfig.unit || null,
      week: teacherConfig.week || null,
      teacher: teacherConfig.teacher || null,
      userName: teacherConfig.userName || null,
      score: score,
      totalQuestions: teacherConfig.correctImages?.length || 0,
      correctAnswers: score,
      wrongAnswers: 0, // gamepicture ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ú‡∏¥‡∏î
      percentage: Math.min(100, percentage),
      duration: duration,
      config: teacherConfig,
      reportImage: reportImage // PNG base64
    };
    
    const response = await fetch('/api/game-results', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    if (result.success) {
      console.log('[AutoSave] Game result saved:', result.resultId);
    } else {
      console.warn('[AutoSave] Failed to save game result:', result.message);
    }
  } catch (e) {
    console.error('[AutoSave] Error saving game result:', e);
  }
}

// ‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å localStorage
let teacherConfig = JSON.parse(localStorage.getItem('emojiGameConfig') || '{}');
let currentStudent = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
const activityName = teacherConfig.mainTopic || teacherConfig.topic || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
document.getElementById('topicName').innerText = activityName;
document.getElementById('topicDisplay').innerText = activityName;

// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
document.getElementById('zones').style.display = 'flex';
document.getElementById('scoreDisplay').style.display = 'block';
gameStarted = true;


// particle effect
function createParticle(x, y) {
  const p = document.createElement('div');
  p.className = 'particle';
  p.innerText = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
  p.style.left = `${x}px`;
  p.style.top = `${y}px`;
  p.style.transform = `scale(${Math.random() * 1.5 + 0.5})`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 600);
}

// Refine the PDF generation logic to align with demo.html and teacherdemo.html

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
async function shareResult() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    const percentageScore = Math.min(100, Math.round((score / (teacherConfig.correctImages?.length || 1)) * 100));

    let grade = '';
    if (percentageScore >= 80) {
      grade = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
    } else if (percentageScore >= 60) {
      grade = '‡∏î‡∏µ';
    } else if (percentageScore >= 40) {
      grade = '‡∏û‡∏≠‡πÉ‡∏à';
    } else {
      grade = '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
    }

    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };

    // Updated the PDF content to include the userName
    const pdfContent = `
      <div style="font-family: 'Arial', sans-serif; color: #333;">
        <div style="text-align: center; margin-bottom: 12px;">
          <img src='picture/Huaroa.jpg' alt='Logo' style='height: 120px; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto;' />
        </div>
        <div style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h1 style="margin: 5px 0; font-size: 24px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</h1>
          <p style="margin: 5px 0; font-size: 14px;">Smart Classroom Learning System</p>
          <p style="margin: 5px 0; font-size: 12px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</p>
        </div>
              <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="font-size: 14px; font-weight: bold; margin: 0 0 10px 0; color: #667eea;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td>
            </tr>
          </table>
        </div>
        <div style="background: #f8f9fa; border: 3px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <p style="font-size: 16px; margin: 0 0 15px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 28px; color: #27ae60; font-weight: bold;">${score}/${teacherConfig.correctImages?.length || 0}</p>
        </div>
        <div style="margin-top: 50px; text-align: center;">
          <p style="margin: 0; font-size: 13px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
          <p style="margin: 8px 0 0 0; font-size: 13px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
          <p style="margin: 5px 0 0 0; font-size: 13px; color: #333;">( _______________________ )</p>
        </div>
      </div>
    `;

    const element = document.createElement('div');
    element.innerHTML = pdfContent;

    html2pdf().set(opt).from(element).output('blob').then(blob => {
      const file = new File([blob], opt.filename, { type: 'application/pdf' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
          files: [file],
          title: 'Smart Classroom - ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
          text: `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${score}/${teacherConfig.correctImages?.length || 0}`
        }).catch(err => console.log('Error sharing:', err));
      } else {
        html2pdf().set(opt).from(element).save();
      }
    });
  } catch (error) {
    console.error('Error sharing PDF:', error);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
function saveResult() {
  try {
    const date = new Date();
    // Define dateStr and timeStr within the saveResult function
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };

    const pdfContent = document.createElement('div');
    pdfContent.innerHTML = `
      <div style="font-family: 'Arial', sans-serif; color: #333;">
         <div style="position:absolute; left:50%; top:60%; transform:translate(-50%,-50%) rotate(45deg); font-size:200px; color:rgba(0,0,0,0.07); font-weight:400; pointer-events:none; z-index:9999; white-space:nowrap;">Espresso</div>
      <div style="position: absolute; top: 1px; right: 12px; font-size: 12px; color: #333;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
      <div style="text-align: center; margin: 40px 0 12px 0; display:flex; align-items:center; justify-content:center; gap:18px; flex-wrap:wrap;">
                <img src="/picture/Huaroa.jpg" alt="Logo Huaroa" style="height:110px; width:auto; max-width:40%; margin-bottom:10px; display:block;" />
                <img src="/picture/kwang_logo3.png" alt="Kwang Logo" style="height:110px; width:auto; max-width:30%; margin-bottom:10px; display:block;" />
      </div>
         <div style="text-align: center; background: linear-gradient(135deg, #ebd09e 0%, #251f03 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h1 style="margin: 5px 0; font-size: 32px;">Espresso</h1>
        <p style="margin: 5px 0; font-size: 18px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</p>
      </div>
       <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <p style="font-size: 14px; font-weight: bold; margin: 0 0 10px 0; color: #251f03;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td>
            </tr>  
             <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.userName || '-'}</td>
            </tr>
          </table>
        </div>
      <div style="background: #f8f9fa; border: 3px solid #251f03; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <p style="font-size: 16px; margin: 0 0 15px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 28px; color: #000000; font-weight: bold;">${score}/${teacherConfig.correctImages?.length || 0}</p>
        </div>
        <div style="margin-top: 70px; text-align: center;">
        <p style="margin: 0; font-size: 13px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: #333;">( _______________________ )</p>
      </div>
       <div id="companyContactWrapper" style="font-size: 14px; color: #333; text-align: right; line-height:1.1; margin-top: 50px;">
      <div style="display: inline-block; text-align: right;">
        ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà ‡∏à‡∏≥‡∏Å‡∏±‡∏î<br>
        263/1 ‡∏ï.‡∏´‡∏±‡∏ß‡∏£‡∏≠ ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å 65000<br>
        ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà<br>
        ‡πÇ‡∏ó‡∏£ : 083-654-9743<br>
        ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå : www.kwangunlimit.com
      </div>
      </div>
    `;

    html2pdf().set(opt).from(pdfContent).save();
  } catch (error) {
    console.error('Error saving PDF:', error);
  }
}

// Validate and log teacherConfig data before generating the PDF
console.log('Teacher Config:', teacherConfig);

if (!teacherConfig.topic || !teacherConfig.unit || !teacherConfig.testCount || !teacherConfig.week || !teacherConfig.teacher) {
  console.warn('Some fields in teacherConfig are missing. Please ensure all fields are provided.');
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏°)
function initGame() {
  if (!teacherConfig.correctImages || !teacherConfig.wrongImages) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    window.location.href = 'teacher.html';
    return;
  }

  createdImages = {};
  score = 0;
  document.getElementById('score').innerText = score;
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô
  gameStartTime = Date.now();

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡πá‡∏™‡∏∏‡πà‡∏° 5 ‡∏£‡∏π‡∏õ)
  const maxImages = 10;
  
  // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  let correctImagesPool = [...teacherConfig.correctImages];
  let selectedCorrectImages = correctImagesPool.sort(() => Math.random() - 0.5).slice(0, Math.min(maxImages, correctImagesPool.length));
  
  // set current round image count BEFORE creating elements so sizing logic knows total
  // we'll compute after selecting both correct and wrong sets

  // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î
  let wrongImagesPool = [...teacherConfig.wrongImages];
  let selectedWrongImages = wrongImagesPool.sort(() => Math.random() - 0.5).slice(0, Math.min(maxImages, wrongImagesPool.length));
  
  // expose current round count so createDraggableImage can size correctly
  window.currentRoundImageCount = selectedCorrectImages.length + selectedWrongImages.length;
  window.imagesPerRowPref = Math.min(6, Math.max(1, Math.ceil(Math.sqrt(window.currentRoundImageCount))));

  selectedCorrectImages.forEach((imgData, index) => {
    createDraggableImage(imgData, `correct-${index}`, true);
  });

  selectedWrongImages.forEach((imgData, index) => {
    createDraggableImage(imgData, `wrong-${index}`, false);
  });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏µ‡πÉ‡∏à‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå winner.mp3
function playSuccessSound() {
  if (!soundEnabled) return; // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô
  try {
    let audio = document.getElementById('winner-audio');
    if (!audio) {
      audio = document.createElement('audio');
      audio.id = 'winner-audio';
      audio.src = '/Sound/winner.mp3';
      audio.preload = 'auto';
      document.body.appendChild(audio);
    }
    audio.currentTime = 0;
    audio.play();
  } catch (e) {}
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
function createDraggableImage(imgData, imageId, isCorrect) {
  if (createdImages[imageId]) return;

  const imageDiv = document.createElement('div');
  imageDiv.classList.add('image-item');
  imageDiv.style.position = 'absolute';
  imageDiv.style.pointerEvents = 'auto';
  imageDiv.innerHTML = `<img src="${imgData}" alt="Image" style="width:100%;height:100%;object-fit:cover;border-radius:8px;display:block;">`;

  // ‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ñ‡∏ß‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‡πÇ‡∏î‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏ô‡∏£‡∏≠‡∏ö
  const totalImages = document.querySelectorAll('.image-item').length;
  const roundCount = window.currentRoundImageCount || (totalImages + 1);
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
  const maxColsBasedOnWidth = Math.max(1, Math.min(6, Math.floor(window.innerWidth / 160)));
  let imagesPerRow = roundCount <= 4 ? Math.min(roundCount, maxColsBasedOnWidth) : Math.min(maxColsBasedOnWidth, Math.max(4, maxColsBasedOnWidth));
  imagesPerRow = Math.max(1, Math.min(imagesPerRow, roundCount));
  const gap = Math.max(14, Math.floor(window.innerWidth * 0.02));

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  const availableWidth = Math.max(480, window.innerWidth - 100);
  let baseImgW = Math.floor((availableWidth - (imagesPerRow + 1) * gap) / imagesPerRow);
  // ‡∏õ‡∏£‡∏±‡∏ö caps ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°: ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  baseImgW = Math.max(80, Math.min(260, baseImgW));
  // ‡∏ñ‡πâ‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡∏ß‡πà‡∏≤ 4 ‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏ï‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà reasonable max
  const estimatedImgW = roundCount > 4 ? Math.min(320, Math.floor(baseImgW * 1.08)) : baseImgW;
  const estimatedImgH = estimatedImgW;

  // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  const row = Math.floor(totalImages / imagesPerRow);
  // index within this row (0-based) ‚Äî safer than modulo if imagesPerRow was adjusted
  const indexInRow = totalImages - row * imagesPerRow;
  const col = Math.max(0, indexInRow);
  // For centering, compute how many columns are in this particular row (last row may be partial)
  const colsThisRow = Math.min(imagesPerRow, Math.max(1, roundCount - row * imagesPerRow));
  const rowWidth = colsThisRow * estimatedImgW + (colsThisRow - 1) * gap;
  const centerX = Math.max(Math.floor((window.innerWidth - rowWidth) / 2), 12);
  const startX = centerX + col * (estimatedImgW + gap);

  const totalRows = Math.ceil((totalImages + 1) / imagesPerRow);
  const imagesAreaHeight = totalRows * estimatedImgH + (totalRows - 1) * gap;
  // compute a vertical baseline but ensure images start below the zones area to avoid overlap
  const tentativeCenterY = Math.max((window.innerHeight - imagesAreaHeight) / 2 + 80, 0);
  let baseY = tentativeCenterY;
  try {
    const zonesEl = document.getElementById('zones');
    if (zonesEl) {
      const zr = zonesEl.getBoundingClientRect();
      // leave a margin below zones
      const minBelowZones = Math.max(24, Math.floor(window.innerHeight * 0.03));
      baseY = Math.max(tentativeCenterY, zr.bottom + minBelowZones);
    }
  } catch (e) {
    baseY = tentativeCenterY;
  }
  const startY = baseY + row * (estimatedImgH + gap);

  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ transform scale
  imageDiv.style.left = `${startX}px`;
  imageDiv.style.top = `${startY}px`;
  imageDiv.style.width = estimatedImgW + 'px';
  imageDiv.style.height = estimatedImgH + 'px';
  // remove CSS max caps so inline sizes are enforced
  imageDiv.style.maxWidth = 'none';
  imageDiv.style.maxHeight = 'none';
  // Force no rotation/transform so images are upright
  imageDiv.style.transform = 'none';
  imageDiv.style.transformOrigin = 'center center';
  imageDiv.style.willChange = 'left, top';

  let offsetX, offsetY;
  function dragMove(posX, posY) {
    imageDiv.style.left = `${posX}px`;
    imageDiv.style.top = `${posY}px`;
    createParticle(posX + 50, posY + 50);
    playDraggingSound(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å
    baseFreq = baseFreq >= 800 ? 200 : baseFreq + 50;
  }

  // Desktop
  imageDiv.addEventListener('mousedown', e => {
    initAudio(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô AudioContext
    e.preventDefault();
    offsetX = e.clientX - imageDiv.offsetLeft;
    offsetY = e.clientY - imageDiv.offsetTop;

    function onMove(e) {
      dragMove(e.clientX - offsetX, e.clientY - offsetY);
    }

    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      checkDrop();
    }

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Mobile
  imageDiv.addEventListener('touchstart', e => {
    initAudio(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô AudioContext
    const t = e.touches[0];
    offsetX = t.clientX - imageDiv.offsetLeft;
    offsetY = t.clientY - imageDiv.offsetTop;
  });
  imageDiv.addEventListener('touchmove', e => {
    const t = e.touches[0];
    dragMove(t.clientX - offsetX, t.clientY - offsetY);
  });
  imageDiv.addEventListener('touchend', e => {
    checkDrop();
  });

  // Updated the `checkDrop` function to prevent score increment for wrong images placed in the wrong zone
  function checkDrop() {
    const rect = imageDiv.getBoundingClientRect();
    const correctZone = document.getElementById('correctZone').getBoundingClientRect();
    const wrongZone = document.getElementById('wrongZone').getBoundingClientRect();

    if (rect.left + rect.width / 2 > correctZone.left && rect.left + rect.width / 2 < correctZone.right &&
        rect.top + rect.height / 2 > correctZone.top && rect.top + rect.height / 2 < correctZone.bottom) {
      if (isCorrect) {
        score += 1;
        playSuccessSound(); // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏µ‡πÉ‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å
      } else {
        score -= 1;
        playFailSound(); // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏¥‡∏î
      }
      document.getElementById('score').innerText = score;
      imageDiv.remove();
      delete createdImages[imageId];
      checkEndGame();
    } else if (rect.left + rect.width / 2 > wrongZone.left && rect.left + rect.width / 2 < wrongZone.right &&
               rect.top + rect.height / 2 > wrongZone.top && rect.top + rect.height / 2 < wrongZone.bottom) {
      if (isCorrect) {
        score -= 1;
        playFailSound(); // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏¥‡∏î
      } else {
        // ‡∏£‡∏π‡∏õ‡∏ú‡∏¥‡∏î‡∏ß‡∏≤‡∏á‡∏ú‡∏¥‡∏î zone (‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á winner ‡∏î‡πâ‡∏ß‡∏¢
        playSuccessSound();
      }
      document.getElementById('score').innerText = score;
      imageDiv.remove();
      delete createdImages[imageId];
      checkEndGame();
    }
  }

  document.body.appendChild(imageDiv);
  createdImages[imageId] = true;
}

// Function to check if the game has ended and show the popup
function checkEndGame() {
  const remainingImages = Object.keys(createdImages).length;
  if (remainingImages === 0) {
    const popup = document.getElementById('scorePopup');
    const finalScore = document.getElementById('finalScore');
    const resultMessage = document.getElementById('resultMessage');

    // Update the popup content
    finalScore.innerText = score;
    resultMessage.innerText = score > 0 ? 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å üéâ' : 'üò¢ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞ üò¢';

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏Å‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏•‡∏á DB
    autoSaveGameResult();
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡∏á Firebase
    if (currentStudent && window.saveStudentTestResult) {
      window.saveStudentTestResult(currentStudent, {
        activityType: 'gamepicture',
        topic: teacherConfig.mainTopic || teacherConfig.topic || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
        score: score,
        totalQuestions: teacherConfig.correctImages?.length || 0,
        correctAnswers: score,
        timeSpent: 0
      }).then(() => {
        console.log('Test result saved to Firebase');
      }).catch(error => {
        console.error('Error saving test result:', error);
      });
    }

    // Try to end usage for this page/section (if usageTracker available)
    try {
      if (window.usageTracker && typeof window.usageTracker.end === 'function') {
        window.usageTracker.end(__localUsageId, location.pathname, 'gamepicture');
      }
    } catch (e) {
      console.warn('usageTracker.end failed', e);
    }

    // Show the popup
    popup.style.display = 'block';
  }
}

// Function to close the popup
function closePopup() {
  const popup = document.getElementById('scorePopup');
  popup.style.display = 'none';
}

// Function to restart the game
function playAgain() {
  const popup = document.getElementById('scorePopup');
  popup.style.display = 'none';
  initGame();
}

// Function to toggle the share menu
function toggleShareMenu() {
  const shareMenu = document.getElementById('shareMenu');
  shareMenu.style.display = shareMenu.style.display === 'none' ? 'block' : 'none';
}

// Updated the activity modal and selection logic for direct navigation
function loadSavedActivities() {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activityList = document.getElementById('activityList');

  if (savedActivities.length === 0) {
    activityList.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
    return;
  }

  activityList.innerHTML = savedActivities.map(activity => `
    <div style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px;">
      <h3 style="cursor: pointer; color: #3498db; text-decoration: underline;" onclick="playActivity(${activity.id})">${activity.name}</h3>
      <p>‡∏™‡∏≤‡∏£‡∏∞: ${activity.topic}</p>
      <p>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà: ${activity.config.week}</p>
    </div>
  `).join('');

  document.getElementById('activityModal').style.display = 'flex';
}

function selectActivity(activityId) {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activity = savedActivities.find(a => a.id === activityId);

  if (!activity) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
    return;
  }

  // Save the selected activity configuration and navigate to the test page
  localStorage.setItem('emojiGameConfig', JSON.stringify(activity.config));
  window.location.reload();
}

// Added functions for activity modal
// Function to load saved activities
function loadSavedActivities() {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activityList = document.getElementById('activityList');

  if (savedActivities.length === 0) {
    activityList.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
    return;
  }

  // Updated the activity list to make activity names clickable for direct play
  activityList.innerHTML = savedActivities.map(activity => `
    <div style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px;">
      <h3 style="cursor: pointer; color: #3498db; text-decoration: underline;" onclick="playActivity(${activity.id})">${activity.name}</h3>
      <p>‡∏™‡∏≤‡∏£‡∏∞: ${activity.topic}</p>
      <p>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà: ${activity.config.week}</p>
    </div>
  `).join('');

  document.getElementById('activityModal').style.display = 'flex';
}

// Updated the `selectActivity` function to directly navigate to the game page
function selectActivity(activityId) {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activity = savedActivities.find(a => a.id === activityId);

  if (!activity) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
    return;
  }

  // Save the selected activity configuration and navigate to the game page
  localStorage.setItem('emojiGameConfig', JSON.stringify(activity.config));
  window.location.href = 'gamepicture.html';
}

// Function to close the activity modal
function closeActivityModal() {
  document.getElementById('activityModal').style.display = 'none';
}

// Start/play activity immediately from the saved activity card
function playActivity(activityId) {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activity = savedActivities.find(a => a.id === activityId);
  if (!activity) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ'); return; }

  // Save config and navigate/reload to start the game
  localStorage.setItem('emojiGameConfig', JSON.stringify(activity.config));
  // If we're already on gamepicture.html, reload to pick up the new config
  const current = window.location.pathname.split('/').pop();
  if (current === 'gamepicture.html' || current === '') {
    window.location.reload();
  } else {
    window.location.href = 'gamepicture.html';
  }
}

// Automatically load and start the game on page load
window.onload = async function() {
  const config = localStorage.getItem('emojiGameConfig');
  if (!config) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô');
    window.location.href = 'teacherpicture.html';
    return;
  }

  teacherConfig = JSON.parse(config);
  const activityName = teacherConfig.mainTopic || teacherConfig.topic || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
  document.getElementById('topicName').innerText = activityName;
  document.getElementById('topicDisplay').innerText = activityName;

  // ‡πÅ‡∏™‡∏î‡∏á dialog ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
  try {
    // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å config ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
    if (teacherConfig.userName && teacherConfig.classroom) {
      currentStudent = {
        name: teacherConfig.userName,
        classroom: teacherConfig.classroom
      };
      console.log('Using student info from config:', currentStudent);
    }
  } catch (error) {
    console.error('Error showing student input dialog:', error);
  }

  // Start the game automatically
  initGame();
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ usageTracker) ‚Äî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô window.onload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ /socket-client.js ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß
  try {
    if (window.usageTracker && typeof window.usageTracker.start === 'function') {
      __localUsageId = window.usageTracker.start(location.pathname || 'gamepicture.html', activityName);
      console.log('usage started', __localUsageId);
    }
  } catch (e) {
    console.warn('usageTracker.start failed', e);
  }

  // ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á end event
  window.addEventListener('beforeunload', function() {
    try {
      if (window.usageTracker && typeof window.usageTracker.end === 'function') {
        window.usageTracker.end(__localUsageId, location.pathname, 'gamepicture');
      }
    } catch (e) {
      // ignore
    }
  });
};
</script>
<!-- Socket client (connect + heartbeat) -->
<script src="/socket.io/socket.io.js"></script>
<script src="/socket-client.js"></script>

<!-- Sound Control with Volume -->
<div class="sound-control-wrapper" id="soundControlWrapper">
  <img class="sound-toggle-btn" id="soundToggleButton" onclick="toggleVolumeBar()" src="/picture/open.png" alt="Toggle Sound">
  
  <div class="volume-control">
    <div class="volume-icon" onclick="toggleMute()" id="volumeIcon"><img src="/picture/open.png" style="width: 24px; height: 24px; filter: brightness(0);"></div>
    <input type="range" min="0" max="100" value="100" class="volume-slider" id="volumeSlider" oninput="updateVolume(this.value)">
    <div class="volume-display" id="volumeDisplay">100%</div>
  </div>
</div>

<script>
// Volume Control Functions
let currentVolume = parseFloat(localStorage.getItem('gameVolume') || '1.0');
let isMuted = false;
let previousVolume = currentVolume;

function updateVolumeDisplay() {
  const percentage = Math.round(currentVolume * 100);
  document.getElementById('volumeDisplay').textContent = percentage + '%';
  const slider = document.getElementById('volumeSlider');
  if (slider) slider.value = percentage;
  localStorage.setItem('gameVolume', currentVolume.toString());
  
  // ‡πÅ‡∏™‡∏î‡∏á 0% ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á slider ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  const displayPercentage = (isMuted || !soundEnabled) ? 0 : percentage;
  
  document.getElementById('volumeDisplay').textContent = displayPercentage + '%';
  if (slider) slider.value = displayPercentage;
  
  // Update slider background gradient
  if (slider) {
    slider.style.background = `linear-gradient(to right, #8b6914 0%, #d4a574 ${displayPercentage}%, #ddd ${displayPercentage}%, #ddd 100%)`;
  }
  
  // Update volume icon
  const icon = document.getElementById('volumeIcon');
  if (icon) {
    if (displayPercentage === 0 || isMuted || !soundEnabled) {
      icon.innerHTML = '<img src="/picture/close.png" style="width: 24px; height: 24px; filter: brightness(0);">';
    } else if (displayPercentage < 50) {
      icon.innerHTML = '<img src="/picture/open.png" style="width: 24px; height: 24px; filter: brightness(0);">';
    } else {
      icon.innerHTML = '<img src="/picture/open.png" style="width: 24px; height: 24px; filter: brightness(0);">';
    }
  }
  
  // Update all audio elements
  document.querySelectorAll('audio').forEach(audio => {
    audio.volume = isMuted ? 0 : currentVolume;
  });
}

function updateVolume(value) {
  currentVolume = value / 100;
  isMuted = false;
  updateVolumeDisplay();
}

function toggleMute() {
  if (isMuted) {
    isMuted = false;
    soundEnabled = true;
    currentVolume = previousVolume;
  } else {
    isMuted = true;
    soundEnabled = false;
    previousVolume = currentVolume;
  }
  
  localStorage.setItem('soundEnabled', soundEnabled ? 'true' : 'false');
  
  const soundButton = document.getElementById('soundToggleButton');
  if (soundButton) {
    soundButton.src = soundEnabled ? '/picture/open.png' : '/picture/close.png';
  }
  
  updateVolumeDisplay();
}

// Initialize volume on page load
window.addEventListener('load', function() {
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î
  const btn = document.getElementById('soundToggleButton');
  if (btn) btn.src = soundEnabled ? '/picture/open.png' : '/picture/close.png';
  isMuted = !soundEnabled;
  updateVolumeDisplay();
});
</script>

<script>
  try {
    localStorage.setItem('lastVisitedPage', location.pathname + location.search + location.hash);
  } catch (e) { }
</script>
</body>
</html>