<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand-brown: #74640a; --brand-brown-dark: #3b3305; --brand-bg-start: #efe6d0; --brand-bg-end: #e9dcc0; }
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(180deg, var(--brand-bg-start) 0%, var(--brand-bg-end) 100%); }
        /* Brand overrides */
        .header-bg { background-color: var(--brand-brown) !important; color: #fff !important; }
        .brand-btn { background-color: var(--brand-brown) !important; border-color: var(--brand-brown) !important; color: #fff !important; }
        .brand-btn:hover { background-color: #5f4f07 !important; }
        /* Sidebar styles */
        .side-item { transition: all 0.12s; }
        .side-item:hover { background-color: rgba(116,100,10,0.06); }
        .side-item.selected { background-color: rgba(116,100,10,0.08); border-left: 4px solid var(--brand-brown-dark); }
        .brand-avatar { width:2.5rem; height:2.5rem; border-radius:9999px; background-color: rgba(116,100,10,0.06); display:inline-flex; align-items:center; justify-content:center; color:var(--brand-brown); font-weight:700; }
        .brand-addbtn { margin-left:0.5rem; font-size:0.75rem; background-color: rgba(116,100,10,0.06); color: var(--brand-brown); padding:0.25rem 0.5rem; border-radius:9999px; }
        .brand-addbtn:hover { background-color: rgba(116,100,10,0.12); }
        /* Prominent add button used in sidebar items */
        .prominent-addbtn { padding: 6px 12px; border-radius: 9999px; font-weight: 700; font-size: 0.95rem; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        input[type="file"]::-webkit-file-upload-button { background-color: rgba(116,100,10,0.06); color: var(--brand-brown); border: none; padding: 6px 10px; border-radius: 9999px; }
        input[type="file"]::file-selector-button { background-color: rgba(116,100,10,0.06); color: var(--brand-brown); border: none; padding: 6px 10px; border-radius: 9999px; }
        .text-brand { color: var(--brand-brown) !important; }
        
        /* Status Pills */
        .status-pill { padding: 4px 12px; border-radius: 9999px; font-weight: 600; font-size: 0.85rem; display: inline-flex; align-items: center; justify-content: center; min-width: 100px; white-space: nowrap; }
        .status-red { background-color: #ffe4e6; color: #e11d48; } 
        .status-orange { background-color: #ffedd5; color: #c2410c; }
        .status-yellow { background-color: #fef9c3; color: #a16207; } 
        .status-green { background-color: #dcfce7; color: #15803d; }
        
        canvas{width:100% !important; height:auto !important; display:block}
        #globalSidebarToggle, #mobileToggleBtn { width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; }
        @media (min-width:640px) { #globalSidebarToggle, #mobileToggleBtn { width:36px; height:36px; font-size:16px; } }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-auto flex flex-col lg:flex-row">

    <button id="globalSidebarToggle" onclick="toggleSidebarMobile()" class="lg:hidden fixed top-4 left-4 z-40 p-2 bg-white/90 backdrop-blur-sm rounded-full shadow-md text-gray-700">‚ò∞</button>

    <aside class="w-full lg:w-[350px] bg-white border-r border-gray-200 flex flex-col h-full z-20 shadow-lg lg:shadow-none">
        <div class="p-5 border-b bg-white flex justify-between items-center sticky top-0">
            <div class="flex items-center gap-2">
                <button id="mobileToggleBtn" onclick="toggleSidebarMobile()" class="lg:hidden p-2 rounded-full bg-transparent hover:bg-transparent text-gray-600">‚ò∞</button>
                <h2 class="font-bold text-l text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2>
            </div>
            <button onclick="openAddModalForClass(currentRoom)" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-full shadow transition-all flex items-center gap-1 brand-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg> ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
        </div>
        <div class="p-3 bg-gray-50 border-b space-y-2"></div>
        <div id="childrenList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50"></div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-auto relative">
        <div id="contentSection" class="flex-1 overflow-y-auto p-4 lg:p-8 pb-20 hidden">
            <div id="captureAreaDashboard" class="max-w-5xl mx-auto space-y-8 w-full px-2 sm:px-0">
                
                <!-- School/Class Dashboard Summary Table -->
                <div id="schoolDashboard" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hidden">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ <span id="summaryTitle">‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á</span>
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-center">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 font-bold">
                                    <th class="p-3 text-left rounded-tl-lg">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                    <th class="p-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏ô)</th>
                                    <th class="p-3 text-green-700">‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô</th>
                                    <th class="p-3 text-red-600">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô/‡∏≠‡πâ‡∏ß‡∏ô</th>
                                    <th class="p-3 text-orange-600 rounded-tr-lg">‡∏ú‡∏≠‡∏°/‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏°</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody" class="divide-y divide-gray-100">
                                <!-- Data rows will be injected here -->
                            </tbody>
                            <tfoot class="bg-gray-50 font-bold text-gray-800">
                                <tr>
                                    <td class="p-3 text-left">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
                                    <td class="p-3" id="sumTotal">0</td>
                                    <td class="p-3 text-green-700" id="sumNormal">0</td>
                                    <td class="p-3 text-red-600" id="sumOver">0</td>
                                    <td class="p-3 text-orange-600" id="sumUnder">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Individual Card Section -->
                <div class="flex justify-center">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 w-full max-w-md text-center border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 rounded-bl-full -mr-10 -mt-10 opacity-50 pointer-events-none" style="background-color: rgba(116,100,10,0.06);"></div>
                        <h2 class="text-xl font-bold text-gray-800 mb-1" id="studentNameDisplay">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</h2>
                        <p class="text-gray-400 text-sm mb-6"><span id="studentClassDisplay">-</span> | <span id="cardDate">-</span></p>
                        <div class="flex flex-col items-center mb-6">
                            <div class="w-28 h-28 bg-gray-100 rounded-full flex items-center justify-center text-5xl mb-4 shadow-inner border-4 border-white relative">
                                <img id="cardThumb" src="" class="w-full h-full object-cover rounded-full hidden">
                                <span id="cardThumbPlaceholder">üë∂</span>
                            </div>
                            <div class="text-gray-500 font-medium" id="cardAgeText">‡∏≠‡∏≤‡∏¢‡∏∏ - ‡∏õ‡∏µ - ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>
                        <div class="flex gap-4 mb-8">
                            <div class="flex-1 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                                <div class="text-gray-400 text-sm mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
                                <div class="text-2xl font-bold text-gray-800"><span id="cardWeight">-</span> <span class="text-sm font-normal text-gray-500">‡∏Å‡∏Å.</span></div>
                            </div>
                            <div class="flex-1 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                                <div class="text-gray-400 text-sm mb-1">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</div>
                                <div class="text-2xl font-bold text-gray-800"><span id="cardHeight">-</span> <span class="text-sm font-normal text-gray-500">‡∏ã‡∏°.</span></div>
                            </div>
                        </div>
                        <div class="space-y-4 text-left">
                            <div class="flex items-center justify-between border-b border-gray-50 pb-2">
                                <span class="text-gray-600 font-medium">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</span>
                                <span id="badgeWH" class="status-pill status-red">‡∏£‡∏≠‡∏ú‡∏•</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-gray-50 pb-2">
                                <span class="text-gray-600 font-medium">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                <span id="badgeHA" class="status-pill status-green">‡∏£‡∏≠‡∏ú‡∏•</span>
                            </div>
                            <div id="badgeContainerWA" class="flex items-center justify-between border-b border-gray-50 pb-2">
                                <span class="text-gray-600 font-medium">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                <span id="badgeWA" class="status-pill status-red">‡∏£‡∏≠‡∏ú‡∏•</span>
                            </div>
                        </div>
                        <div class="mt-8 text-xs text-gray-300">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ‡∏Å‡∏£‡∏°‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢ (0-19 ‡∏õ‡∏µ)</div>
                        <div class="mt-6 flex gap-2 justify-center">
                            <button onclick="openAddModal()" class="text-brand text-sm hover:underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            <span class="text-gray-300">|</span>
                            <button onclick="exportToCSV()" class="text-green-500 text-sm hover:underline">Export CSV</button>
                            <button onclick="exportToPNG()" class="text-purple-600 text-sm hover:underline">Export PNG</button>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <!-- WA Chart (Hidden for 6-19y) -->
                    <div id="containerWA" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 id="labelWA" class="font-bold text-gray-700 mb-4 text-sm flex items-center"><span class="w-2 h-5 bg-blue-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (0-5 ‡∏õ‡∏µ)</h3>
                        <div class="h-[220px] sm:h-[300px]"><canvas id="chartWA"></canvas></div>
                        <div class="mt-3 text-xs text-gray-600">
                            <div id="legendWA" class="flex flex-col gap-1 text-xs sm:text-sm">
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#DDA0DD"></span><span>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#008000"></span><span>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#10b981"></span><span>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#98FB98"></span><span>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f97316"></span><span>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span></div>
                            </div>
                        </div>
                    </div>
                    <!-- HA Chart -->
                    <div id="containerHA" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 id="labelHA" class="font-bold text-gray-700 mb-4 text-sm flex items-center"><span class="w-2 h-5 bg-teal-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</h3>
                        <div class="h-[220px] sm:h-[300px]"><canvas id="chartHA"></canvas></div>
                        <div class="mt-3 text-xs text-gray-600">
                            <div id="legendHA" class="grid grid-cols-2 gap-1 text-xs sm:text-sm">
                                <!-- Dynamic Legend -->
                            </div>
                        </div>
                    </div>
                    <!-- WH Chart -->
                    <div id="containerWH" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 xl:col-span-2">
                        <h3 id="labelWH" class="font-bold text-gray-700 mb-4 text-sm flex items-center"><span class="w-2 h-5 bg-purple-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</h3>
                        <div class="h-[260px] sm:h-[350px]"><canvas id="chartWH"></canvas></div>
                        <div class="mt-3 text-xs text-gray-600">
                            <div id="legendWH" class="grid grid-cols-3 gap-2 text-xs sm:text-sm text-center sm:text-left">
                                <!-- Dynamic Legend -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-50"><h3 class="font-bold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-50 text-gray-500 font-medium">
                                <tr>
                                    <th class="px-6 py-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-4">‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                    <th class="px-6 py-4 text-right">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
                                    <th class="px-6 py-4 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</th>
                                    <th class="px-6 py-4 text-center">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                    <th class="px-6 py-4 text-center">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                    <th class="px-6 py-4 text-center">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</th>
                                    <th class="px-4 py-4 text-center w-12">&nbsp;</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center text-4xl mb-4 text-gray-300">üìä</div>
            <p class="text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
        </div>
    </main>

    <!-- Modal code remains similar ... -->
    <div id="addModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all">
        <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden transform scale-100">
            <div class="bg-blue-600 p-5 relative flex justify-center items-center text-white header-bg">
                <h3 class="font-bold text-lg">‡∏™‡∏°‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏ó‡∏£‡∏Ñ</h3>
                <button onclick="closeAddModal()" class="absolute right-3 top-3 opacity-70 hover:opacity-100 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-600 mb-1">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</label>
                    <div class="flex items-center gap-3">
                        <input type="file" id="inputPhoto" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <img id="inputPhotoPreview" src="" alt="preview" style="display:none; width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb;" />
                    </div>
                </div>
                <div class="flex gap-3">
                    <label class="cursor-pointer w-1/2"><input type="radio" name="gender" value="boy" class="peer hidden" checked onchange="updateModalTheme()"><div class="py-3 rounded-2xl border-2 border-gray-100 peer-checked:border-blue-500 peer-checked:bg-blue-50 text-gray-400 peer-checked:text-blue-600 font-bold text-center">üë¶ ‡∏ä‡∏≤‡∏¢</div></label>
                    <label class="cursor-pointer w-1/2"><input type="radio" name="gender" value="girl" class="peer hidden" onchange="updateModalTheme()"><div class="py-3 rounded-2xl border-2 border-gray-100 peer-checked:border-pink-500 peer-checked:bg-pink-50 text-gray-400 peer-checked:text-pink-600 font-bold text-center">üëß ‡∏´‡∏ç‡∏¥‡∏á</div></label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.1/1)</label>
                    <input type="text" id="inputClassroom" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-gray-700" list="classroomOptions" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á..." />
                    <datalist id="classroomOptions"></datalist>
                </div>
                <div><label class="block text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="inputName" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-gray-700" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠..." /></div>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-sm font-medium text-gray-600 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label><input type="number" id="inputYear" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center" placeholder="0" /></div>
                    <div class="flex-1"><label class="block text-sm font-medium text-gray-600 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label><input type="number" id="inputMonth" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center" placeholder="0" /></div>
                </div>
                <div class="flex gap-3">
                    <div class="flex-1"><label class="block text-sm font-medium text-gray-600 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label><input type="number" id="inputWeight" step="0.1" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center text-blue-600 text-lg" placeholder="0.0" /></div>
                    <div class="flex-1"><label class="block text-sm font-medium text-gray-600 mb-1">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input type="number" id="inputHeight" step="0.1" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center text-blue-600 text-lg" placeholder="0.0" /></div>
                </div>
                <button onclick="saveRecord()" id="saveBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-200 transition-all mt-2 brand-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
            </div>
        </div>

            <!-- Result modal (show evaluation before saving) -->
            <div id="resultModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
                <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl transform transition-all">
                    <div id="captureArea" class="bg-gradient-to-br from-white to-gray-50 p-6 relative">
                        <div class="absolute top-0 right-0 w-24 h-24 rounded-bl-full opacity-50 -mr-4 -mt-4 z-0" style="background-color: rgba(116,100,10,0.12);"></div>
                        <div class="text-center relative z-10">
                            <h3 class="text-xl font-bold text-gray-800 mb-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h3>
                            <p class="text-xs text-gray-500" id="resDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -</p>
                        </div>
                        <div class="mt-4 flex flex-col items-center relative z-10">
                            <div class="w-28 h-28 rounded-full border-4 border-white shadow-md overflow-hidden bg-gray-200 mb-4">
                                <img id="resPhoto" src="" class="w-full h-full object-cover hidden">
                                <span id="resPhotoPlaceholder" class="w-full h-full flex items-center justify-center text-2xl">üë∂</span>
                            </div>
                            <h2 class="text-2xl font-bold text-blue-600" id="resName">‡∏ô‡πâ‡∏≠‡∏á...</h2>
                            <p class="text-sm text-gray-600" id="resAge">‡∏≠‡∏≤‡∏¢‡∏∏ - ‡∏õ‡∏µ - ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-4 relative z-10">
                            <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm text-center">
                                <div class="text-xs text-gray-500">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
                                <div class="text-lg font-bold text-gray-800"><span id="resWeight">-</span> <span class="text-xs font-normal">‡∏Å‡∏Å.</span></div>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm text-center">
                                <div class="text-xs text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</div>
                                <div class="text-lg font-bold text-gray-800"><span id="resHeight">-</span> <span class="text-xs font-normal">‡∏ã‡∏°.</span></div>
                            </div>
                        </div>
                        <div class="mt-5 space-y-2 relative z-10">
                            <div class="flex flex-col p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</span>
                                    <span id="resStatWH" class="status-pill status-green">-</span>
                                </div>
                            </div>
                            <div class="flex flex-col p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                    <span id="resStatHA" class="status-pill status-green">-</span>
                                </div>
                            </div>
                            <div class="flex flex-col p-3 bg-white rounded-lg border border-gray-100 shadow-sm">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-gray-600">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                    <span id="resStatWA" class="status-pill status-green">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-center"><p class="text-[10px] text-gray-400">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ‡∏Å‡∏£‡∏°‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢ (2564)</p></div>
                    </div>
                    <div class="bg-gray-50 p-4 border-t flex gap-3">
                        <button onclick="editResult()" class="flex-1 py-2 rounded-lg border border-gray-300 text-gray-600 font-medium text-sm hover:bg-gray-100">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="saveAndGoDashboard()" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-medium text-sm hover:bg-blue-700 flex justify-center items-center shadow-md brand-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </div>
            </div>
    </div>

    <script>
        // --- 1. DATA (Re-sampled from PDFs) ---
        // Boys H/A (6-19y): 5 lines (-2, -1.5, Med, +1.5, +2)
        // Girls H/A (6-19y): 5 lines
        // Boys W/H (6-19y): 6 lines (-2, -1.5, Med, +1.5, +2, +3)
        // Girls W/H (6-19y): 6 lines
        const growthData = {
            boy: {
                group_0_5: {
                    // (Keep existing 0-5 data)
                    w_h: [{x:65,y:[6.6,6.9,7.5,8.3,8.9,9.8]},{x:75,y:[8.2,8.7,9.6,10.8,11.6,13.0]},{x:85,y:[10.0,10.7,11.8,13.4,14.5,16.4]},{x:95,y:[12.1,12.9,14.3,16.4,17.7,20.1]},{x:105,y:[14.4,15.5,17.3,19.9,21.5,24.5]},{x:115,y:[17.2,18.5,20.9,24.2,26.1,29.9]},{x:120,y:[18.8,20.2,23.0,26.7,28.8,33.0]}],
                    w_a: [{x:0,y:[2.4,2.6,3.3,4.2,4.5]},{x:12,y:[7.7,8.2,9.6,11.2,11.9]},{x:24,y:[9.7,10.3,12.2,14.4,15.3]},{x:36,y:[11.3,12.0,14.3,17.0,18.3]},{x:48,y:[12.7,13.6,16.3,19.4,21.2]},{x:60,y:[14.1,15.1,18.3,21.9,24.2]},{x:72,y:[15.5,16.6,20.2,24.5,27.0]}],
                    h_a: [{x:0,y:[46,47,50,53,54]},{x:12,y:[71,72,76,79,81]},{x:24,y:[81,82,87,92,93]},{x:36,y:[88,90,96,101,103]},{x:48,y:[95,96,103,109,111]},{x:60,y:[100,102,110,116,119]},{x:72,y:[105,107,116,123,125]}]
                },
                group_6_19: {
                    // Ref: M-6-19_2.pdf (W/H), Graph 6-19 (H/A)
                    // More detailed sampling to fix middle curve issues
                    w_h: [
                        {x:90, y:[11.0, 11.8, 13.0, 14.8, 16.0, 18.2]},
                        {x:95, y:[12.1, 12.9, 14.3, 16.4, 17.7, 20.1]},
                        {x:100, y:[13.2, 14.1, 15.7, 18.0, 19.5, 22.2]},
                        {x:105, y:[14.4, 15.5, 17.3, 19.9, 21.5, 24.5]},
                        {x:110, y:[15.8, 16.9, 19.0, 22.0, 23.7, 27.0]},
                        {x:115, y:[17.2, 18.5, 20.9, 24.2, 26.1, 29.9]},
                        {x:120, y:[18.8, 20.2, 23.0, 26.7, 28.8, 33.0]},
                        {x:125, y:[20.5, 22.1, 25.3, 29.5, 31.8, 36.5]},
                        {x:130, y:[22.5, 24.3, 28.0, 32.7, 35.3, 40.6]},
                        {x:135, y:[24.8, 26.8, 30.9, 36.2, 39.2, 45.1]},
                        {x:140, y:[27.3, 29.7, 34.3, 40.2, 43.6, 50.4]},
                        {x:145, y:[30.0, 32.5, 37.5, 44.5, 48.0, 56.0]},
                        {x:150, y:[32.5, 35.5, 41.0, 48.5, 53.0, 61.5]},
                        {x:155, y:[35.5, 38.5, 45.0, 53.5, 58.0, 67.0]},
                        {x:160, y:[40.0, 43.5, 52.0, 62.0, 68.0, 80.0]},
                        {x:165, y:[41.5, 45.5, 53.0, 62.5, 68.0, 79.0]},
                        {x:170, y:[45.0, 49.0, 57.0, 67.0, 73.0, 85.0]},
                        {x:175, y:[48.0, 52.5, 61.0, 72.0, 78.0, 91.0]},
                        {x:180, y:[51.0, 56.0, 65.0, 77.0, 83.0, 97.0]},
                        {x:185, y:[54.0, 59.0, 69.0, 81.0, 88.0, 103.0]}
                    ],
                    h_a: [
                        {x:6, y:[106, 108, 113, 118, 121]},
                        {x:7, y:[111, 114, 119, 124, 127]},
                        {x:8, y:[116, 119, 124, 130, 133]},
                        {x:9, y:[121, 124, 129, 135, 138]},
                        {x:10, y:[126, 130, 135, 141, 144]},
                        {x:11, y:[131, 135, 141, 147, 150]},
                        {x:12, y:[136, 141, 147, 154, 157]},
                        {x:13, y:[142, 148, 155, 162, 166]},
                        {x:14, y:[148, 154, 161, 169, 172]},
                        {x:15, y:[154, 159, 166, 174, 178]},
                        {x:16, y:[157, 162, 170, 177, 182]},
                        {x:17, y:[159, 164, 171, 179, 184]},
                        {x:18, y:[160, 165, 172, 180, 185]},
                        {x:19, y:[161, 166, 173, 181, 186]}
                    ]
                }
            },
            girl: {
                group_0_5: {
                    w_h: [{x:65,y:[6.3,6.5,7.2,8.1,8.7,9.6]},{x:75,y:[7.8,8.2,9.1,10.3,11.1,12.5]},{x:85,y:[9.6,10.1,11.4,12.9,13.9,15.7]},{x:95,y:[11.7,12.4,14.1,16.1,17.4,19.8]},{x:105,y:[14.2,15.1,17.4,20.1,21.7,24.9]},{x:115,y:[17.3,18.4,21.4,25.0,27.1,31.1]},{x:120,y:[19.1,20.4,23.8,27.9,30.3,34.8]}],
                    w_a: [{x:0,y:[2.3,2.5,3.2,4.0,4.3]},{x:12,y:[7.0,7.5,8.9,10.6,11.4]},{x:24,y:[9.0,9.6,11.5,13.7,14.8]},{x:36,y:[10.7,11.4,13.9,16.7,18.1]},{x:48,y:[12.2,13.1,16.1,19.5,21.2]},{x:60,y:[13.6,14.6,18.2,22.3,24.4]},{x:72,y:[15.0,16.1,20.5,25.5,28.0]}],
                    h_a: [{x:0,y:[45,46,49,52,53]},{x:12,y:[69,70,74,78,79]},{x:24,y:[80,81,86,91,92]},{x:36,y:[87,89,95,101,102]},{x:48,y:[94,95,103,109,111]},{x:60,y:[99,101,109,117,119]},{x:72,y:[105,106,116,123,125]}]
                },
                group_6_19: {
                    // Ref: W-6-19_2.pdf (W/H), Girls H/A PDF
                    // More detailed sampling
                    w_h: [
                        {x:90, y:[10.2, 11.0, 12.5, 14.2, 15.5, 17.5]},
                        {x:100, y:[12.5, 13.5, 15.2, 17.8, 19.2, 22.0]},
                        {x:110, y:[15.5, 16.5, 19.0, 22.2, 24.0, 27.5]},
                        {x:120, y:[19.0, 20.2, 23.5, 27.5, 30.2, 34.5]},
                        {x:130, y:[23.0, 25.0, 29.5, 35.0, 38.0, 44.0]},
                        {x:140, y:[28.5, 31.0, 37.0, 44.5, 49.0, 56.5]},
                        {x:145, y:[31.5, 34.5, 41.5, 49.5, 54.5, 63.5]},
                        {x:150, y:[35.0, 38.0, 46.0, 55.0, 61.0, 71.0]},
                        {x:155, y:[38.5, 42.0, 50.5, 61.0, 67.5, 79.0]},
                        {x:160, y:[42.0, 45.5, 55.0, 67.0, 74.5, 87.0]},
                        {x:165, y:[45.5, 49.5, 59.5, 73.0, 81.0, 95.0]},
                        {x:170, y:[49.0, 53.0, 64.0, 78.5, 87.5, 102.5]},
                        {x:175, y:[52.0, 56.0, 68.0, 83.0, 92.5, 108.0]}
                    ],
                    h_a: [
                        {x:6, y:[103, 105, 111, 116, 119]},
                        {x:7, y:[108, 111, 117, 122, 125]},
                        {x:8, y:[113, 116, 122, 128, 131]},
                        {x:9, y:[119, 122, 128, 134, 137]},
                        {x:10, y:[125, 129, 136, 142, 146]},
                        {x:11, y:[131, 135, 143, 150, 153]},
                        {x:12, y:[137, 141, 149, 156, 159]},
                        {x:13, y:[142, 146, 153, 160, 163]},
                        {x:14, y:[145, 149, 156, 162, 165]},
                        {x:15, y:[147, 150, 157, 163, 166]},
                        {x:16, y:[147, 151, 158, 164, 167]},
                        {x:17, y:[148, 151, 158, 164, 167]},
                        {x:18, y:[148, 151, 159, 165, 168]},
                        {x:19, y:[148, 151, 159, 165, 168]}
                    ]
                }
            }
        };

        function getLinearInterpolation(dataset, inputX) {
            if (inputX <= dataset[0].x) return dataset[0].y;
            if (inputX >= dataset[dataset.length-1].x) return dataset[dataset.length-1].y;
            for (let i = 0; i < dataset.length - 1; i++) {
                if (inputX >= dataset[i].x && inputX <= dataset[i+1].x) {
                    const t = (inputX - dataset[i].x) / (dataset[i+1].x - dataset[i].x);
                    const yArr = [];
                    const len = dataset[i].y.length;
                    for(let j=0; j<len; j++) yArr.push(dataset[i].y[j] * (1 - t) + dataset[i+1].y[j] * t);
                    return yArr;
                }
            }
            return dataset[0].y;
        }

        

        function evaluateStatus(val, ref, type) {
            if (!ref || !Array.isArray(ref) || ref.length === 0) return { t: '-', c: 'bg-gray-100' };
            const len = ref.length;

            if (type === 'HA' && len === 5) {
                if (val > ref[4]) return { t: "‡∏™‡∏π‡∏á", c: "status-green bg-green-100 text-green-700" };
                if (val > ref[3]) return { t: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á", c: "status-green" };
                if (val >= ref[1]) return { t: "‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå", c: "status-green" };
                if (val >= ref[0]) return { t: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢", c: "status-orange" };
                return { t: "‡πÄ‡∏ï‡∏µ‡πâ‡∏¢", c: "status-red" };
            }

            if (type === 'WH' && len === 6) {
                if (val > ref[5]) return { t: "‡∏≠‡πâ‡∏ß‡∏ô", c: "status-red" };
                if (val > ref[4]) return { t: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô", c: "status-orange" };
                if (val > ref[3]) return { t: "‡∏ó‡πâ‡∏ß‡∏°", c: "status-yellow" };
                if (val >= ref[1]) return { t: "‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô", c: "status-green" };
                if (val >= ref[0]) return { t: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏°", c: "status-orange" };
                return { t: "‡∏ú‡∏≠‡∏°", c: "status-red" };
            }

            // Weight-for-Age: provide five-category labels as requested
            if (type === 'WA' && len >= 5) {
                // Use top, upper, median, lower, bottom thresholds
                const top = ref[len-1];
                const upper = ref[len-2];
                const median = ref[Math.floor((len - 1) / 2)];
                const lower = ref[1];
                if (val > top) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å", c: "status-red" };
                if (val > upper) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å", c: "status-orange" };
                if (val >= median) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì", c: "status-green" };
                if (val >= lower) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢", c: "status-orange" };
                return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", c: "status-red" };
            }

            const median = ref[Math.floor((len - 1) / 2)];
            if (val > ref[len-1]) return { t: "‡∏™‡∏π‡∏á/‡∏°‡∏≤‡∏Å", c: "status-red" };
            if (val >= median) return { t: "‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå", c: "status-green" };
            return { t: "‡∏ô‡πâ‡∏≠‡∏¢", c: "status-red" };
        }

        // Prefix readable status text with ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å or ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á where appropriate
        // Note: For WH (weight-for-height) we do NOT prefix with "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å" ‚Äî leave text as-is.
        function formatStatusText(txt, type) {
            if (!txt || txt === '-') return txt;
            // If already prefixed (e.g., '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ô‡∏≠‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå' or '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ...') leave as-is
            if (txt.startsWith('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å') || txt.startsWith('‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á')) return txt;
            if (type === 'HA') return `‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á ${txt}`;
            if (type === 'WA') return `‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ${txt}`;
            // WH or any other type: do not prefix
            return txt;
        }

        // --- APP LOGIC ---
        let allRecords = [];
        let pendingRecord = null; // temporary record shown in result modal before saving
        let currentSelectedName = null;
        let currentRoom = null; // null = show rooms list, otherwise show names in that room
        let chartInstances = {};

        async function fetchRecords() {
            // Try server endpoints in order:
            // 1) relative `/api/bmi-records` (works when served by the Node server)
            // 2) if page was opened via file://, try localhost:3000 as a common development server
            const candidates = ['/api/bmi-records'];
            try {
                if (window.location && window.location.protocol === 'file:') candidates.push('http://localhost:3000/api/bmi-records');
                else if (window.location && window.location.origin) candidates.push(window.location.origin + '/api/bmi-records');
            } catch (e) {}

            for (const url of candidates) {
                try {
                    console.debug('[bmi] fetchRecords trying', url);
                    const res = await fetch(url, { cache: 'no-store' });
                    if (res && res.ok) {
                        const json = await res.json();
                        return json.records || [];
                    }
                } catch (e) {
                    console.debug('[bmi] fetchRecords failed for', url, e && e.message);
                    // try next candidate
                }
            }

            // Fallback to localStorage-only when server not available
            return localStorage.getItem('bmiRecords') ? JSON.parse(localStorage.getItem('bmiRecords')) : [];
        }

        function groupByName(records) {
            const map = new Map();
            records.forEach(r => {
                const name = (r.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim();
                if (!map.has(name)) map.set(name, []);
                map.get(name).push(r);
            });
            return map;
        }

        function formatDate(d) {
            try { return new Date(d).toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'2-digit'}); } catch (e) { return d; }
        }

        // Format age display as "X ‡∏õ‡∏µ Y ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" (falls back to months when years = 0)
        function formatAge(rec) {
            if (!rec) return '-';
            const totalM = (typeof rec.ageTotalM === 'number') ? rec.ageTotalM : ((rec.ageY||0)*12 + (rec.ageM_Input||0));
            const y = Math.floor(totalM / 12);
            const m = totalM % 12;
            if (y > 0) return `${y} ‡∏õ‡∏µ ${m} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            return `${m} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
        }

        async function initApp() {
            allRecords = await fetchRecords();
            try { console.debug('[bmi] initApp loaded records count=', Array.isArray(allRecords)?allRecords.length:0); } catch(e) {}
            // Add a small debug badge to show records count on the page
            try {
                let dbg = document.getElementById('recordsCountDebug');
                if (!dbg) {
                    dbg = document.createElement('div'); dbg.id = 'recordsCountDebug';
                    dbg.style.position = 'fixed'; dbg.style.bottom = '12px'; dbg.style.right = '12px'; dbg.style.padding = '6px 10px'; dbg.style.background = 'rgba(0,0,0,0.6)'; dbg.style.color = '#fff'; dbg.style.borderRadius = '8px'; dbg.style.fontSize = '13px'; dbg.style.zIndex = 99999;
                    document.body.appendChild(dbg);
                }
                dbg.innerText = `records: ${Array.isArray(allRecords)?allRecords.length:0}`;
            } catch(e) {}
            renderSidebar();
            updateDashboard();
        }

        // Return latest record per student filtered by classroom (className may be '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' for empty)
        function getLatestPerStudentInClass(className) {
            const grouped = groupByName(allRecords);
            const out = [];
            grouped.forEach(list => {
                const latest = list.sort((a,b) => new Date(b.date) - new Date(a.date))[0];
                if (className === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                    if (!latest.classroom || String(latest.classroom).trim() === '') out.push(latest);
                } else {
                    if (latest.classroom === className) out.push(latest);
                }
            });
            return out.sort((a,b) => a.name.localeCompare(b.name));
        }

        // Calculate class-level stats (reuse logic from before)
        function calculateStatsForClass(className) {
            const studentsInClass = getLatestPerStudentInClass(className);
            let t=0, n=0, o=0, u=0;
            studentsInClass.forEach(r => {
                t++;
                const refs = getRefsFor(r.gender||'boy', r.ageTotalM, r.h);
                let st = {t:'-'};
                if (refs.refWH) st = evaluateStatus(r.w, refs.refWH, 'WH');
                if(st.t.includes('‡∏≠‡πâ‡∏ß‡∏ô') || st.t.includes('‡∏ó‡πâ‡∏ß‡∏°') || st.t.includes('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô')) o++;
                else if(st.t.includes('‡∏ú‡∏≠‡∏°')) u++;
                else if(st.t.includes('‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô') || st.t.includes('‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå') || st.t.includes('‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå')) n++;
            });
            return { t, n, o, u, students: studentsInClass };
        }

        function renderSidebar(filter = '', room = null) {
            const listEl = document.getElementById('childrenList');
            listEl.innerHTML = '';
            currentRoom = room || null;
            // If user explicitly opened a room, clear any previously selected child
            if (room) currentSelectedName = null;

            // Group records by classroom
            const roomsMap = new Map();
            allRecords.forEach(r => {
                const roomName = (r.classroom || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').toString().trim() || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (!roomsMap.has(roomName)) roomsMap.set(roomName, []);
                roomsMap.get(roomName).push(r);
            });

            // If no specific room selected, show list of rooms
            if (!currentRoom) {
                if (roomsMap.size === 0) {
                    listEl.innerHTML = '<div class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                    return;
                }

                const roomNames = Array.from(roomsMap.keys()).sort();
                roomNames.forEach(roomName => {
                    const records = roomsMap.get(roomName) || [];
                    const div = document.createElement('div');
                    div.className = 'p-3 mb-2 cursor-pointer flex items-center gap-3 border border-gray-100 rounded-md bg-white side-item hover:shadow-sm hover:bg-gray-50 transition';
                    div.onclick = () => renderSidebar(filter, roomName);
                    div.tabIndex = 0;
                    div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); renderSidebar(filter, roomName); } };
                    const displayRoom = (roomName === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') ? roomName : `‡∏´‡πâ‡∏≠‡∏á ${roomName}`;
                    div.innerHTML = `
                        <div class="w-full text-center">
                            <div class="font-medium text-gray-800 text-sm">${displayRoom}</div>
                            <div class="text-xs text-gray-500 mt-1">${records.length} ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
                        </div>
                    `;
                    listEl.appendChild(div);
                });

                return;
            }
            // Show names for the selected room
            const items = (roomsMap.get(currentRoom) || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (items.length === 0) {
                listEl.innerHTML = '<div class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }

            // If no child is currently selected (or selected child not in this room), show aggregated class summary
            const selectedInThisRoom = currentSelectedName && items.some(r => (r.name||'').trim() === currentSelectedName);
            if (!currentSelectedName || !selectedInThisRoom) {
                showClassroomSummary(currentRoom);
                // continue and render the names list in the sidebar
            }

            // Back button to rooms list
            const backDiv = document.createElement('div');
            backDiv.className = 'p-2 mb-2 cursor-pointer flex items-center gap-3 text-sm text-gray-600 side-item';
            backDiv.onclick = () => renderSidebar(filter, null);
            backDiv.tabIndex = 0;
            backDiv.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); renderSidebar(filter, null); } };
            backDiv.innerHTML = `<div class="flex items-center gap-2"><span class="text-lg" aria-hidden="true">&lt;</span></div>`;
            backDiv.setAttribute('title','‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö');
            backDiv.setAttribute('aria-label','‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö');
            listEl.appendChild(backDiv);

            const names = Array.from(new Set(items.map(r => (r.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim()))).filter(n => n.includes(filter));
            if (names.length === 0) {
                listEl.innerHTML = '<div class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }

            names.forEach(name => {
                const childItems = items.filter(r => (r.name||'').trim() === name).sort((a,b) => new Date(b.date) - new Date(a.date));
                const latest = childItems[0];
                const div = document.createElement('div');
                div.className = `p-4 cursor-pointer flex items-center gap-3 border-b border-gray-100 side-item ${currentSelectedName === name ? 'selected' : ''}`;
                div.onclick = () => selectChild(name);

                const imgSrc = latest.photo || '';
                const imgHtml = imgSrc ? `<img src="${imgSrc}" class="w-10 h-10 rounded-full object-cover">` : `<div class="brand-avatar">${name[0] || '‚Äì'}</div>`;

                div.innerHTML = `
                    <div class="flex items-center w-full gap-3">
                        <div class="flex-shrink-0">${imgHtml}</div>
                        <div class="flex-1 text-center">
                            <div class="font-medium text-gray-800">${name}</div>
                            <div class="text-xs text-gray-500 mt-1">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(latest.date).toLocaleDateString('th-TH')}</div>
                        </div>
                        <div class="flex-shrink-0 right-area"></div>
                    </div>
                `;

                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'brand-btn prominent-addbtn';
                addBtn.style.padding = '6px 12px';
                addBtn.innerText = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°';
                addBtn.onclick = function(ev) { ev.stopPropagation(); openAddModalFor(name); };

                const rightArea = div.querySelector('.right-area');
                if (rightArea) rightArea.appendChild(addBtn); else div.appendChild(addBtn);
                listEl.appendChild(div);
            });
            updateDashboard();
        }

        function updateDashboard() {
            // Classroom filter removed; always show all classrooms here
            const filterClass = null;
            const dashEl = document.getElementById('schoolDashboard');
            const summaryTitle = document.getElementById('summaryTitle');
            const summaryTableBody = document.getElementById('summaryTableBody');

            // If a room is selected in the sidebar and no individual is selected,
            // render the classroom summary view and avoid overwriting it below.
            if (currentRoom && !currentSelectedName) {
                showClassroomSummary(currentRoom);
                return;
            }
            
            // Get unique classrooms for the rows (include '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' when classroom is empty)
            let classroomsSet = new Set();
            let hasUnknown = false;
            allRecords.forEach(r => {
                if (r.classroom && String(r.classroom).toString().trim() !== '') classroomsSet.add(String(r.classroom).trim());
                else hasUnknown = true;
            });
            let classrooms = Array.from(classroomsSet).sort();
            if (hasUnknown) classrooms.unshift('‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');

            // No classroom filter UI: show all classrooms
            let rowsToShow = classrooms;

            summaryTableBody.innerHTML = '';
            
            let totalSum = 0;
            let normalSum = 0;
            let overSum = 0;
            let underSum = 0;

            if (allRecords.length === 0) {
                dashEl.classList.add('hidden');
                return;
            }
            dashEl.classList.remove('hidden');
            summaryTitle.innerText = "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";

            // Use global calculateStatsForClass to compute stats per class

            // Generate rows
            rowsToShow.forEach(cls => {
                const stats = calculateStatsForClass(cls);
                totalSum += stats.t;
                normalSum += stats.n;
                overSum += stats.o;
                underSum += stats.u;

                const tr = document.createElement('tr');
                const displayCls = (cls === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') ? cls : `‡∏´‡πâ‡∏≠‡∏á ${cls}`;
                tr.innerHTML = `
                    <td class="p-3 text-left font-medium text-gray-700">${displayCls}</td>
                    <td class="p-3">${stats.t}</td>
                    <td class="p-3 text-green-700 bg-green-50/50">${stats.n} (${stats.t ? ((stats.n/stats.t)*100).toFixed(0) : 0}%)</td>
                    <td class="p-3 text-red-600 bg-red-50/50">${stats.o} (${stats.t ? ((stats.o/stats.t)*100).toFixed(0) : 0}%)</td>
                    <td class="p-3 text-orange-600 bg-orange-50/50">${stats.u} (${stats.t ? ((stats.u/stats.t)*100).toFixed(0) : 0}%)</td>
                `;
                summaryTableBody.appendChild(tr);
            });

            // Update footer totals
            document.getElementById('sumTotal').innerText = totalSum;
            document.getElementById('sumNormal').innerText = `${normalSum} (${totalSum ? ((normalSum/totalSum)*100).toFixed(0) : 0}%)`;
            document.getElementById('sumOver').innerText = `${overSum} (${totalSum ? ((overSum/totalSum)*100).toFixed(0) : 0}%)`;
            document.getElementById('sumUnder').innerText = `${underSum} (${totalSum ? ((underSum/totalSum)*100).toFixed(0) : 0}%)`;
        }

        function getRefsFor(gender, ageTotalM, height) {
            const g = growthData[gender] || growthData['boy'];
            const use0_5 = (ageTotalM <= 72); 
            const group = use0_5 ? g.group_0_5 : g.group_6_19;

            let refWA = null, refHA = null, refWH = null;

            if (use0_5) {
                if (group.w_a) refWA = getLinearInterpolation(group.w_a, ageTotalM);
                if (group.h_a) refHA = getLinearInterpolation(group.h_a, ageTotalM);
                if (group.w_h) refWH = getLinearInterpolation(group.w_h, height);
            } else {
                // Cap age at 19y (228m) for older individuals
                const cappedAgeM = Math.min(ageTotalM, 228); 
                const ageY = cappedAgeM / 12; 
                if (group.h_a) refHA = getLinearInterpolation(group.h_a, ageY);
                if (group.w_h) refWH = getLinearInterpolation(group.w_h, height);
            }
            return { refWA, refHA, refWH };
        }

        function selectChild(name) {
            currentSelectedName = name;
            // Highlight selected (re-render but preserve current room and filter)
            const items = document.querySelectorAll('.side-item');
            items.forEach(i => i.classList.remove('selected'));
            renderSidebar('', currentRoom);

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('contentSection').style.display = 'block';

            const itemsArr = allRecords.filter(r => r.name === name).sort((a,b) => a.ageTotalM - b.ageTotalM);
            const latest = itemsArr[itemsArr.length - 1]; 

            const gender = latest.gender || 'boy';
            const refs = getRefsFor(gender, latest.ageTotalM, latest.h);

            let stWH = {t:'‡∏£‡∏≠‡∏ú‡∏•', c:'bg-gray-100'};
            if (refs.refWH) stWH = evaluateStatus(latest.w, refs.refWH, 'WH');
            else stWH = {t:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ô‡∏≠‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå', c:'bg-gray-100 text-gray-500'};

            const stHA = refs.refHA ? evaluateStatus(latest.h, refs.refHA, 'HA') : {t:'-', c:'bg-gray-100'};
            const stWA = refs.refWA ? evaluateStatus(latest.w, refs.refWA, 'WA') : {t:'-', c:'bg-gray-100'};

            document.getElementById('studentNameDisplay').innerText = latest.name;
            document.getElementById('studentClassDisplay').innerText = latest.classroom ? `‡∏´‡πâ‡∏≠‡∏á ${latest.classroom}` : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡πâ‡∏≠‡∏á';
            document.getElementById('cardDate').innerText = new Date(latest.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: '2-digit' });
            document.getElementById('cardAgeText').innerText = `‡∏≠‡∏≤‡∏¢‡∏∏ ${latest.ageY} ‡∏õ‡∏µ ${latest.ageM_Input} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            
            const imgEl = document.getElementById('cardThumb');
            const phEl = document.getElementById('cardThumbPlaceholder');
            if(latest.photo){ imgEl.src = latest.photo; imgEl.classList.remove('hidden'); phEl.classList.add('hidden'); }
            else { imgEl.classList.add('hidden'); phEl.classList.remove('hidden'); }

            document.getElementById('cardWeight').innerText = latest.w;
            document.getElementById('cardHeight').innerText = latest.h;

            const bWH = document.getElementById('badgeWH'); bWH.innerText = formatStatusText(stWH.t, 'WH'); bWH.className = `status-pill ${stWH.c}`;
            const bHA = document.getElementById('badgeHA'); bHA.innerText = formatStatusText(stHA.t, 'HA'); bHA.className = `status-pill ${stHA.c}`;
            const bWA = document.getElementById('badgeWA'); bWA.innerText = formatStatusText(stWA.t, 'WA'); bWA.className = `status-pill ${stWA.c}`;

            const isOlder = latest.ageTotalM > 72;
            const badgeContainerWA = document.getElementById('badgeContainerWA');
            if(badgeContainerWA) badgeContainerWA.style.display = isOlder ? 'none' : 'flex';

            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
                [...itemsArr].reverse().forEach(row => {
                const rowRefs = getRefsFor(row.gender||gender, row.ageTotalM, row.h);
                const rWA = rowRefs.refWA ? formatStatusText(evaluateStatus(row.w, rowRefs.refWA, 'WA').t, 'WA') : '-';
                const rHA = rowRefs.refHA ? formatStatusText(evaluateStatus(row.h, rowRefs.refHA, 'HA').t, 'HA') : '-';
                const rWH = rowRefs.refWH ? formatStatusText(evaluateStatus(row.w, rowRefs.refWH, 'WH').t, 'WH') : '-';
                const tr = document.createElement('tr');
                tr.className = "bg-white hover:bg-gray-50";
                tr.innerHTML = `<td class="px-6 py-4">${formatDate(row.date)}</td><td class="px-6 py-4">${formatAge(row)}</td><td class="px-6 py-4 text-right font-bold">${row.w}</td><td class="px-6 py-4 text-right font-bold">${row.h}</td><td class="px-6 py-4 text-center">${isOlder ? '-' : rWA}</td><td class="px-6 py-4 text-center">${rHA}</td><td class="px-6 py-4 text-center">${rWH}</td><td class=\"px-4 py-4 text-center\"><button type=\"button\" class=\"text-red-500 hover:text-red-700 text-sm\" title=\"‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\" onclick=\"(function(e){e.stopPropagation(); deleteRecord(${row.id});})(event)\">‡∏•‡∏ö</button></td>`;
                tbody.appendChild(tr);
            });

            // Ensure normal dashboard sections are visible (hide any classDetail)
            try {
                const capture = document.getElementById('captureAreaDashboard');
                if (capture) {
                    Array.from(capture.children).forEach(ch => ch.style.display = '');
                    const cd = document.getElementById('classDetail'); if (cd) cd.style.display = 'none';
                }
            } catch(e) {}

            updateCharts(itemsArr, gender);
            try { if (window.innerWidth < 1024) { document.querySelector('aside').classList.add('hidden'); document.getElementById('contentSection').scrollIntoView(); } } catch(e) {}
        }

        // Render a classroom summary (totals + student list) into main content
        function showClassroomSummary(className) {
            console.log('[bmi] showClassroomSummary', className);
            const dashEl = document.getElementById('schoolDashboard');
            const summaryTitle = document.getElementById('summaryTitle');
            const summaryTableBody = document.getElementById('summaryTableBody');
            const stats = calculateStatsForClass(className);
            summaryTitle.innerText = `‡∏´‡πâ‡∏≠‡∏á ${className}`;
            // replace summary table with single-row summary for this room
            summaryTableBody.innerHTML = '';
                const tr = document.createElement('tr');
                const displayClassName = (className === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') ? className : `‡∏´‡πâ‡∏≠‡∏á ${className}`;
                tr.innerHTML = `
                <td class="p-3 text-left font-medium text-gray-700">${displayClassName}</td>
                <td class="p-3">${stats.t}</td>
                <td class="p-3 text-green-700 bg-green-50/50">${stats.n} (${stats.t ? ((stats.n/stats.t)*100).toFixed(0) : 0}%)</td>
                <td class="p-3 text-red-600 bg-red-50/50">${stats.o} (${stats.t ? ((stats.o/stats.t)*100).toFixed(0) : 0}%)</td>
                <td class="p-3 text-orange-600 bg-orange-50/50">${stats.u} (${stats.t ? ((stats.u/stats.t)*100).toFixed(0) : 0}%)</td>
            `;
            summaryTableBody.appendChild(tr);

            // Build detailed printable-style table (like provided sample)
            let detail = document.getElementById('classDetail');
            if (!detail) {
                detail = document.createElement('div');
                detail.id = 'classDetail';
                detail.className = 'bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mt-4 overflow-x-auto';
                const container = document.getElementById('captureAreaDashboard');
                if (container) container.appendChild(detail);
            }

            const students = stats.students || [];
            // Build quick summary counts by sex for the printable header table
            const summary = { male: {total:0, normal:0, over:0, under:0}, female: {total:0, normal:0, over:0, under:0} };
            students.forEach(s => {
                const sex = (s.gender === 'girl') ? 'female' : 'male';
                summary[sex].total++;
                const refs = getRefsFor(s.gender||'boy', s.ageTotalM, s.h);
                let st = {t:'-'};
                if (refs.refWH) st = evaluateStatus(s.w, refs.refWH, 'WH');
                if (st.t.includes('‡∏≠‡πâ‡∏ß‡∏ô') || st.t.includes('‡∏ó‡πâ‡∏ß‡∏°') || st.t.includes('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô')) summary[sex].over++;
                else if (st.t.includes('‡∏ú‡∏≠‡∏°')) summary[sex].under++;
                else if (st.t.includes('‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô') || st.t.includes('‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå') || st.t.includes('‡∏™‡∏π‡∏á')) summary[sex].normal++;
            });
            const totalAll = (summary.male.total + summary.female.total) || 0;
            // Build detailed category counts for WH, HA, WA
            const WH_CATS = [
                '- ‡∏≠‡πâ‡∏ß‡∏ô (>+3 SD.)',
                '- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô (>+2 SD. ‡∏ñ‡∏∂‡∏á +3 SD.)',
                '- ‡∏ó‡πâ‡∏ß‡∏° (>+1.5 SD. ‡∏ñ‡∏∂‡∏á +2 SD.)',
                '- ‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô (-1.5 SD. ‡∏ñ‡∏∂‡∏á +1.5 SD.)',
                '- ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏° (-2 SD. ‡∏ñ‡∏∂‡∏á -1.5 SD.)',
                '- ‡∏ú‡∏≠‡∏° (<-2 SD.)'
            ];
            const HA_CATS = [
                '- ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (>+2 SD.)',
                '- ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á (>+1.5 SD. ‡∏ñ‡∏∂‡∏á +2 SD.)',
                '- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå (-1.5 SD. ‡∏ñ‡∏∂‡∏á +1.5 SD.)',
                '- ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢ (-2 SD. ‡∏ñ‡∏∂‡∏á -1.5 SD.)',
                '- ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢ (<-2 SD.)'
            ];
            const WA_CATS = [
                '- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (>+2 SD.)',
                '- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å (>+1.5 SD. ‡∏ñ‡∏∂‡∏á +2 SD.)',
                '- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå (-1.5 SD. ‡∏ñ‡∏∂‡∏á +1.5 SD.)',
                '- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (-2 SD. ‡∏ñ‡∏∂‡∏á -1.5 SD.)',
                '- ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (<-2 SD.)'
            ];
            function mkCounter(cats){ const o={}; cats.forEach(c=>o[c]={male:0,female:0,total:0}); return o; }
            // Find the canonical category label (from cats array) that contains the short status text
            function findCatFor(cats, statusText){
                if(!statusText || statusText === '-') return null;
                for(const c of cats){ if(c.indexOf(statusText) !== -1) return c; }
                return null;
            }
            const countsWH = mkCounter(WH_CATS);
            const countsHA = mkCounter(HA_CATS);
            const countsWA = mkCounter(WA_CATS);
            let missingWH = 0, missingHA = 0, missingWA = 0;
            students.forEach(s=>{
                const refs = getRefsFor(s.gender||'boy', s.ageTotalM, s.h);
                const sex = (s.gender==='girl') ? 'female' : 'male';
                // WH
                if (refs.refWH) {
                    const short = evaluateStatus(s.w, refs.refWH, 'WH').t;
                    const cat = findCatFor(WH_CATS, short);
                    if (cat) { countsWH[cat][sex]++; countsWH[cat].total++; }
                    else { missingWH++; }
                } else missingWH++;
                // HA
                if (refs.refHA) {
                    const short = evaluateStatus(s.h, refs.refHA, 'HA').t;
                    const cat = findCatFor(HA_CATS, short);
                    if (cat) { countsHA[cat][sex]++; countsHA[cat].total++; }
                    else { missingHA++; }
                } else missingHA++;
                // WA
                if (refs.refWA) {
                    const short = evaluateStatus(s.w, refs.refWA, 'WA').t;
                    const cat = findCatFor(WA_CATS, short);
                    if (cat) { countsWA[cat][sex]++; countsWA[cat].total++; }
                    else { missingWA++; }
                } else missingWA++;
            });

            // Helper to render a section table
            function renderSection(title, cats, counts){
                // Use fixed table layout and explicit column widths so all sections align identically
                let h = `<div class="mb-4"><div class="font-bold text-sm text-gray-700 mb-1">${title}</div><table class="w-full text-sm border-collapse text-center" style="table-layout:fixed"><colgroup><col style="width:40%"><col style="width:12%"><col style="width:12%"><col style="width:12%"><col style="width:12%"><col style="width:12%"></colgroup><thead><tr class="bg-gray-100 font-bold"><th class="p-2 border text-left">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="p-2 border">‡∏ä‡∏≤‡∏¢ (‡∏Ñ‡∏ô)</th><th class="p-2 border">‡∏´‡∏ç‡∏¥‡∏á (‡∏Ñ‡∏ô)</th><th class="p-2 border">‡∏£‡∏ß‡∏° (‡∏Ñ‡∏ô)</th><th class="p-2 border">‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ (%)</th><th class="p-2 border">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏° (%)</th></tr></thead><tbody>`;
                cats.forEach(cat=>{
                    const c = counts[cat] || {male:0,female:0,total:0};
                    const pctDistribution = totalAll ? ((c.total/totalAll)*100).toFixed(2) : '0.00';
                    // coverage should use only children with data (exclude missing)
                    const missingForThis = (counts === countsWH) ? missingWH : (counts === countsHA) ? missingHA : missingWA;
                    const coverageDenom = Math.max(0, totalAll - missingForThis);
                    const pctCoverage = coverageDenom ? ((c.total/coverageDenom)*100).toFixed(2) : '0.00';
                    h += `<tr><td class="p-2 border text-left">${cat}</td><td class="p-2 border">${c.male}</td><td class="p-2 border">${c.female}</td><td class="p-2 border">${c.total}</td><td class="p-2 border">${pctDistribution}%</td><td class="p-2 border">${pctCoverage}%</td></tr>`;
                });
                // totals row (include missing in totalAll for percent)
                const sumMale = cats.reduce((s,k)=>s + ((counts[k]||{male:0}).male),0);
                const sumFemale = cats.reduce((s,k)=>s + ((counts[k]||{female:0}).female),0);
                const sumTotal = cats.reduce((s,k)=>s + ((counts[k]||{total:0}).total),0);
                const missingForThis = (counts === countsWH) ? missingWH : (counts === countsHA) ? missingHA : missingWA;
                const coverageDenom = Math.max(0, totalAll - missingForThis);
                h += `<tr class="font-bold bg-gray-50"><td class="p-2 border text-left">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td class="p-2 border">${sumMale}</td><td class="p-2 border">${sumFemale}</td><td class="p-2 border">${sumTotal}</td><td class="p-2 border">${totalAll? '100.00' : '0.00'}%</td><td class="p-2 border">${coverageDenom? '100.00' : '0.00'}%</td></tr>`;
                // row: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö
                const missing = (counts === countsWH) ? missingWH : (counts === countsHA) ? missingHA : missingWA;
                // For the 'missing' row, coverage (%) is not applicable (we calculate coverage among those who submitted), show 0.00%
                h += `<tr><td class="p-2 border text-left">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</td><td class="p-2 border">-</td><td class="p-2 border">-</td><td class="p-2 border">${missing}</td><td class="p-2 border">${totalAll? ((missing/totalAll)*100).toFixed(2) : '0.00'}%</td><td class="p-2 border">0.00%</td></tr>`;
                // row: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                h += `<tr class="font-bold bg-white"><td class="p-2 border text-left">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td class="p-2 border">${summary.male.total}</td><td class="p-2 border">${summary.female.total}</td><td class="p-2 border">${totalAll}</td><td class="p-2 border">100.00%</td><td class="p-2 border">100.00%</td></tr>`;
                h += `</tbody></table></div>`;
                return h;
            }

            const detailedHtml = `<div class="mb-4">${renderSection('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (WA)', WA_CATS, countsWA)}${renderSection('‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (HA)', HA_CATS, countsHA)}${renderSection('‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (WH)', WH_CATS, countsWH)}</div>`;
            // Header table matching sample
            let html = `
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm text-gray-700 font-semibold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ: ‡∏´‡πâ‡∏≠‡∏á ${className} ‚Äî ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${students.length} ‡∏Ñ‡∏ô</div>
                        <div class="flex items-center gap-2">
                            <button onclick="printClassReport('${className}')" class="px-3 py-1 rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200 text-sm">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        </div>
                </div>
                <table class="w-full text-sm border-collapse text-center">
                    <thead>
                        <tr class="bg-gray-100 text-gray-700 font-bold">
                            <th class="p-2 border">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th class="p-2 border">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th class="p-2 border">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th class="p-2 border">‡πÄ‡∏û‡∏®</th>
                            <th class="p-2 border">‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th class="p-2 border">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
                            <th class="p-2 border">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</th>
                            <th class="p-2 border">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th class="p-2 border">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th class="p-2 border">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</th>
                        </tr>
                    </thead>
                    <tbody>`;
                        
                        // Student list will appear first; detailed summary sections go below with spacing

            students.forEach((s, idx) => {
                const refs = getRefsFor(s.gender||'boy', s.ageTotalM, s.h);
                const stWA = refs.refWA ? formatStatusText(evaluateStatus(s.w, refs.refWA, 'WA').t, 'WA') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const stHA = refs.refHA ? formatStatusText(evaluateStatus(s.h, refs.refHA, 'HA').t, 'HA') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const stWH = refs.refWH ? formatStatusText(evaluateStatus(s.w, refs.refWH, 'WH').t, 'WH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const sexLabel = (s.gender === 'girl') ? '‡∏ç' : '‡∏ä';
                const ageDisplay = formatAge(s);
                html += `
                        <tr>
                            <td class="p-2 border text-center">${idx+1}</td>
                            <td class="p-2 border text-center">${formatDate(s.date)}</td>
                            <td class="p-2 border text-center">${s.name}</td>
                            <td class="p-2 border text-center">${sexLabel}</td>
                            <td class="p-2 border text-center">${ageDisplay}</td>
                            <td class="p-2 border text-center font-bold">${s.w}</td>
                            <td class="p-2 border text-center font-bold">${s.h}</td>
                            <td class="p-2 border text-center">${stWA}</td>
                            <td class="p-2 border text-center">${stHA}</td>
                            <td class="p-2 border text-center">${stWH}</td>
                        </tr>`;
            });

            html += `</tbody></table>`;
            // add some spacing then append the detailed summary sections
            html += `<div class="my-6"></div>` + detailedHtml;
            detail.innerHTML = html;

            // Hide other sections inside capture area so only the class table remains
            const container = document.getElementById('captureAreaDashboard');
            if (container) {
                Array.from(container.children).forEach(ch => {
                    if (ch.id !== 'classDetail') ch.style.display = 'none';
                    else ch.style.display = 'block';
                });
            }

            // Show main content and hide the compact summary header (we render full report instead)
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('contentSection').style.display = 'block';
            if (dashEl) dashEl.classList.add('hidden');
        }

        function updateCharts(data, gender) {
            const genderObj = growthData[gender] || growthData['boy'];
            const latest = data[data.length - 1];
            const isOlder = latest && latest.ageTotalM > 72;

            const containerWA = document.getElementById('containerWA');
            const containerHA = document.getElementById('containerHA');
            
            // Colors logic ‚Äî reversed order as requested
            const colorsWH_6_19 = ['#f97316', '#98FB98', '#10b981', '#008000', '#DDA0DD', '#BA55D3'];
            // HA palette reversed
            const colorsHA_6_19 = ['#f97316', '#98FB98', '#10b981', '#008000', '#BA55D3'];
            // Reuse the same palette for 0-5 so both age groups remain consistent
            const colorsWH_0_5 = colorsWH_6_19;
            const colorsHA_0_5 = colorsHA_6_19;
            // WA uses same ordering as WH for visual alignment of weight categories
            const colorsWA_0_5 = colorsWH_0_5;

            if (isOlder) {
                if(containerWA) containerWA.classList.add('hidden');
                if(containerHA) containerHA.classList.add('xl:col-span-2');
                
                const rawHA = genderObj.group_6_19.h_a;
                const plotDataHA = data.map(d => Math.min(d.ageTotalM, 228));
                const refHA = rawHA.map(r => ({ x: r.x * 12, y: r.y }));
                createAreaChart('chartHA', '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', '‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', plotDataHA, data.map(d => d.h), refHA, 72, 228, colorsHA_6_19);

                const refWH = genderObj.group_6_19.w_h;
                const maxRefH = refWH[refWH.length-1].x;
                const plotDataWH = data.map(d => ({ x: Math.min(d.h, maxRefH), y: d.w }));
                createScatterAreaChart('chartWH', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)', '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', plotDataWH, refWH, 90, 185, colorsWH_6_19);
                
                document.getElementById('labelHA').innerHTML = `<span class="w-2 h-5 bg-teal-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (6-19 ‡∏õ‡∏µ)`;
                document.getElementById('labelWH').innerHTML = `<span class="w-2 h-5 bg-purple-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (6-19 ‡∏õ‡∏µ)`;

                document.getElementById('legendHA').innerHTML = `
                    <div class="flex flex-col gap-2 text-xs sm:text-sm">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#BA55D3"></span><span>‡∏™‡∏π‡∏á</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#008000"></span><span>‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#10b981"></span><span>‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#98FB98"></span><span>‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f97316"></span><span>‡πÄ‡∏ï‡∏µ‡πâ‡∏¢</span></div>
                    </div>
                `;
                document.getElementById('legendWH').innerHTML = `
                    <div class="flex flex-col gap-2 text-xs sm:text-sm">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#BA55D3"></span><span>‡∏≠‡πâ‡∏ß‡∏ô (&gt;+3SD)</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#DDA0DD"></span><span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô (+2SD)</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#008000"></span><span>‡∏ó‡πâ‡∏ß‡∏° (+1.5SD)</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#10b981"></span><span>‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#98FB98"></span><span>‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏°</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f97316"></span><span>‡∏ú‡∏≠‡∏° (&lt;-2SD)</span></div>
                    </div>
                `;

            } else {
                if(containerWA) containerWA.classList.remove('hidden');
                if(containerHA) containerHA.classList.remove('xl:col-span-2');

                const refWA = genderObj.group_0_5.w_a;
                createAreaChart('chartWA', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)', '‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', data.map(d => d.ageTotalM), data.map(d => d.w), refWA, 0, 72, colorsWA_0_5);
                
                const refHA = genderObj.group_0_5.h_a;
                createAreaChart('chartHA', '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', '‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', data.map(d => d.ageTotalM), data.map(d => d.h), refHA, 0, 72, colorsHA_0_5);

                const refWH = genderObj.group_0_5.w_h;
                const plotDataWH = data.map(d => ({ x: d.h, y: d.w }));
                createScatterAreaChart('chartWH', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)', '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', plotDataWH, refWH, 65, 120, colorsWH_0_5);

                document.getElementById('labelHA').innerHTML = `<span class="w-2 h-5 bg-teal-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏ (0-5 ‡∏õ‡∏µ)`;
                document.getElementById('labelWH').innerHTML = `<span class="w-2 h-5 bg-purple-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (0-5 ‡∏õ‡∏µ)`;
                
                document.getElementById('legendHA').innerHTML = `
                    <div class="flex flex-col gap-2 text-xs sm:text-sm">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#BA55D3"></span><span>‡∏™‡∏π‡∏á</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#008000"></span><span>‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#10b981"></span><span>‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#98FB98"></span><span>‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f97316"></span><span>‡πÄ‡∏ï‡∏µ‡πâ‡∏¢</span></div>
                    </div>
                `;
                document.getElementById('legendWH').innerHTML = `
                    <div class="flex flex-col gap-2 text-xs sm:text-sm">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#BA55D3"></span><span>‡∏≠‡πâ‡∏ß‡∏ô</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#DDA0DD"></span><span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πâ‡∏ß‡∏ô</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#008000"></span><span>‡∏ó‡πâ‡∏ß‡∏°</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#10b981"></span><span>‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#98FB98"></span><span>‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏°</span></div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f97316"></span><span>‡∏ú‡∏≠‡∏°</span></div>
                    </div>
                `;
            }
        }

        function createAreaChart(id, yLabel, xLabel, xData, yData, refData, minX, maxX, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            if(chartInstances[id]) chartInstances[id].destroy();
            const datasets = [];
            // Child Line (use brand dark instead of pure black for better match)
            datasets.push({ label: '‡πÄ‡∏î‡πá‡∏Å', data: xData.map((x, i) => ({ x: x, y: yData[i] })), borderColor: '#0f172a', borderWidth: 2, pointBackgroundColor: '#0f172a', pointRadius: 4, showLine: true, fill: false, tension: 0, order: 10 });
            // Ref Lines (Top down)
            const refCount = refData[0].y.length; 
            for (let i = refCount - 1; i >= 0; i--) {
                const color = colors[i % colors.length] || '#ccc';
                const d = refData.map(r => ({ x: r.x, y: r.y[i] }));
                datasets.push({ label: `L${i}`, data: d, borderColor: color, borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3, order: 1 });
            }
            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: [minX, maxX], datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', min: minX, max: maxX, title: { display: true, text: xLabel } }, y: { title: { display: true, text: yLabel } } }, plugins: { legend: { display: false } } }
            });
        }

        function createScatterAreaChart(id, yLabel, xLabel, points, refData, minX, maxX, colors) {
            const ctx = document.getElementById(id).getContext('2d');
            if(chartInstances[id]) chartInstances[id].destroy();
            const datasets = [];
            // Child Points (brand dark)
            datasets.push({ type: 'scatter', label: '‡πÄ‡∏î‡πá‡∏Å', data: points, backgroundColor: '#0f172a', pointRadius: 5, order: 10 });
            // Ref Lines
            const refCount = refData[0].y.length;
            for (let i = refCount - 1; i >= 0; i--) {
                const color = colors[i % colors.length] || '#ccc';
                const d = refData.map(r => ({ x: r.x, y: r.y[i] }));
                datasets.push({ type: 'line', data: d, borderColor: color, borderWidth: 1, pointRadius: 0, fill: false, tension: 0.3, order: 1 });
            }
            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: [minX, maxX], datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', min: minX, max: maxX, title: { display: true, text: xLabel } }, y: { title: { display: true, text: yLabel } } }, plugins: { legend: { display: false } } }
            });
        }

        // --- COMMON ---
        const modal = document.getElementById('addModal');
        function openAddModal() { modal.classList.remove('hidden'); if(currentSelectedName) { const r = allRecords.find(x=>x.name===currentSelectedName); document.getElementById('inputName').value = currentSelectedName; if(r && r.classroom) document.getElementById('inputClassroom').value = r.classroom; } else { document.getElementById('inputName').value=''; document.getElementById('inputClassroom').value=''; document.querySelector('input[value="boy"]').checked=true; updateModalTheme(); } }
        function openAddModalFor(name) { 
            const r = allRecords.find(x=>x.name===name); 
            document.getElementById('inputName').value=name; 
            if(r && r.classroom) document.getElementById('inputClassroom').value = r.classroom;
            modal.classList.remove('hidden'); 
        }
        function openAddModalForClass(className) {
            if(!className) className = '';
            document.getElementById('inputClassroom').value = className === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' ? '' : className;
            // clear name field so user can enter new student, keep gender default
            document.getElementById('inputName').value = '';
            modal.classList.remove('hidden');
        }
        function closeAddModal() { modal.classList.add('hidden'); }
        function updateModalTheme() { const g = document.querySelector('input[name="gender"]:checked').value; const h = modal.querySelector('.header-bg'); const b = document.getElementById('saveBtn'); if(g==='boy'){ h.className=h.className.replace('bg-pink-600','bg-blue-600'); b.className=b.className.replace('bg-pink-600','bg-blue-600'); } else { h.className=h.className.replace('bg-blue-600','bg-pink-600'); b.className=b.className.replace('bg-blue-600','bg-pink-600'); } }
        function readFileAsDataURL(f) { return new Promise(r=>{if(!f)r(null);const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f)}); }
        async function saveRecord() {
            const name = document.getElementById('inputName').value;
            const classroom = document.getElementById('inputClassroom').value.trim();
            const ageY = parseInt(document.getElementById('inputYear').value)||0;
            const ageM = parseInt(document.getElementById('inputMonth').value)||0;
            const w = parseFloat(document.getElementById('inputWeight').value);
            const h = parseFloat(document.getElementById('inputHeight').value);
            const gender = document.querySelector('input[name="gender"]:checked').value;
            if(!name || isNaN(w) || isNaN(h)) return alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
            const totalM = (ageY*12)+ageM;
            const rec = { id: Date.now(), date: new Date().toISOString(), name: name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠', classroom, ageY, ageM_Input: ageM, ageTotalM: totalM, w, h, gender };
            const photo = await readFileAsDataURL(document.getElementById('inputPhoto').files[0]);
            if(photo) rec.photo = photo;

            // compute refs and statuses
            const refs = getRefsFor(gender, rec.ageTotalM, rec.h);
            const statWA = refs.refWA ? evaluateStatus(rec.w, refs.refWA, 'WA') : { t: '-', c: 'bg-gray-100' };
            const statHA = refs.refHA ? evaluateStatus(rec.h, refs.refHA, 'HA') : { t: '-', c: 'bg-gray-100' };
            const statWH = refs.refWH ? evaluateStatus(rec.w, refs.refWH, 'WH') : { t: '-', c: 'bg-gray-100' };

            // prepare pending record and show modal (follow BMI flow)
            pendingRecord = Object.assign({}, rec, { statWA: statWA.t, statHA: statHA.t, statWH: statWH.t, colorWH: statWH.c, colorHA: statHA.c, colorWA: statWA.c });
            showResultModal(Object.assign({}, rec, { statWA, statHA, statWH }));
        }
        function exportToCSV() {
            if(!currentSelectedName) return;
            const items = allRecords.filter(r => r.name === currentSelectedName);
            let csv = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å,‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á,‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏,‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏¢‡∏∏,‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á\n";
            items.forEach(r => {
                const refs = getRefsFor(r.gender, r.ageTotalM, r.h);
                const wh = refs.refWH ? formatStatusText(evaluateStatus(r.w, refs.refWH, 'WH').t, 'WH') : '-';
                const ha = refs.refHA ? formatStatusText(evaluateStatus(r.h, refs.refHA, 'HA').t, 'HA') : '-';
                const wa = refs.refWA ? formatStatusText(evaluateStatus(r.w, refs.refWA, 'WA').t, 'WA') : '-';
                csv += `${formatDate(r.date)},${r.classroom ? '‡∏´‡πâ‡∏≠‡∏á ' + r.classroom : ''},${r.ageTotalM},${r.w},${r.h},${wa},${ha},${wh}\n`;
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
            link.download = `Growth_${currentSelectedName}.csv`;
            link.click();
        }
        async function exportToPNG() {
            const el = document.getElementById('captureAreaDashboard');
            const canvas = await html2canvas(el);
            const a = document.createElement('a');
            a.href = canvas.toDataURL("image/png");
            a.download = "dashboard.png";
            a.click();
        }
        
        // (Removed class-level PNG/CSV export functions ‚Äî UI no longer shows those buttons)

        function printClassReport(className) {
            const detail = document.getElementById('classDetail');
            if (!detail) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå');
            // Clone the table so we can print only its content
            const clone = detail.cloneNode(true);
            // Try opening a new window first. If blocked, fall back to an iframe-based print.
            const style = `
                <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                <style>
                    /* Print page margins and wrapper to avoid content touching edges */
                    @page { size: A4; margin: 18mm; }
                    html,body{height:100%;}
                    body{font-family: 'Sarabun', sans-serif; margin:0; padding:12mm; color:#111; background:#fff}
                    .print-wrap{max-width:180mm; margin:0 auto;}
                    table{border-collapse:collapse; width:100%; font-size:13px; table-layout:fixed}
                    th, td{border:1px solid #e5e7eb; padding:8px; text-align:center; vertical-align:middle}
                    thead tr{background:#f3f4f6}
                    /* keep any explicit left-aligned cells (e.g., name column) */
                    th.text-left, td.text-left{ text-align:left }
                    /* Slightly larger spacing for print readability */
                    th, td { padding:10px }
                    @media print {
                        body{padding:0}
                        .print-wrap{margin:0}
                    }
                </style>`;

            const tryWindow = () => {
                const w = window.open('', '_blank');
                if (!w) return null;
                w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á ${className}</title>${style}</head><body><div class="print-wrap">`);
                w.document.write(clone.innerHTML);
                w.document.write('</div></body></html>');
                w.document.close();
                // Give browser a moment to layout then print
                setTimeout(() => { try { w.focus(); w.print(); } catch(e){} }, 300);
                return w;
            };

            const w = tryWindow();
            if (w) return; // opened and printing

            // Fallback: iframe print (avoids popup blocker)
            try {
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.right = '0';
                iframe.style.bottom = '0';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = '0';
                iframe.id = 'printIframe';
                document.body.appendChild(iframe);
                const idoc = iframe.contentDocument || iframe.contentWindow.document;
                idoc.open();
                idoc.write(`<!doctype html><html><head><meta charset="utf-8"><title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡πâ‡∏≠‡∏á ${className}</title>${style}</head><body><div class="print-wrap">` + clone.innerHTML + '</div></body></html>');
                idoc.close();
                iframe.onload = () => {
                    try { iframe.contentWindow.focus(); iframe.contentWindow.print(); } catch(e) {}
                    setTimeout(() => { try { document.body.removeChild(iframe); } catch(e) {} }, 1000);
                };
                // In case onload doesn't fire, attempt print after short delay
                setTimeout(() => { try { if (iframe.contentWindow) { iframe.contentWindow.focus(); iframe.contentWindow.print(); document.body.removeChild(iframe); } } catch(e){} }, 600);
            } catch(e) {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ (‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏∑‡πà‡∏ô)');
            }
        }
        // Result modal controls (from BMI page)
        function showResultModal(data) {
            const modal = document.getElementById('resultModal');
            const d = new Date(data.date);
            document.getElementById('resDate').innerText = d.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: '2-digit' });
            document.getElementById('resName').innerText = data.name;
            document.getElementById('resAge').innerText = `‡∏≠‡∏≤‡∏¢‡∏∏ ${data.ageY} ‡∏õ‡∏µ ${data.ageM_Input} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            document.getElementById('resWeight').innerText = data.w;
            document.getElementById('resHeight').innerText = data.h;
            const imgEl = document.getElementById('resPhoto');
            const phEl = document.getElementById('resPhotoPlaceholder');
            if (data.photo) { imgEl.src = data.photo; imgEl.classList.remove('hidden'); phEl.classList.add('hidden'); }
            else { imgEl.classList.add('hidden'); phEl.classList.remove('hidden'); }
            const setStat = (id, statObj) => {
                const el = document.getElementById(id);
                el.innerText = statObj.t;
                el.className = `status-pill ${statObj.c}`;
            };
            setStat('resStatWH', data.statWH);
            setStat('resStatHA', data.statHA);
            setStat('resStatWA', data.statWA);
            modal.classList.remove('hidden');
        }
        function closeModal() { document.getElementById('resultModal').classList.add('hidden'); }
        function editResult() { closeModal(); openAddModal(); }
        function saveAndGoDashboard() {
            (async () => {
                if (pendingRecord) {
                    // persist to localStorage (and to in-memory list)
                    try {
                        allRecords.unshift(pendingRecord);
                        localStorage.setItem('bmiRecords', JSON.stringify(allRecords));
                    } catch (e) { console.error('Failed to save pendingRecord', e); }
                    pendingRecord = null;
                }
                // Close modal and refresh view to show saved record
                closeModal(); closeAddModal();
                try { renderSidebar('', currentRoom); if (currentRoom) showClassroomSummary(currentRoom); } catch(e) {}
            })();
        }
        // Delete a saved record by id
        async function deleteRecord(id) {
                try {
                    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                    // Attempt server-side delete first
                    let serverOk = false;
                    try {
                        const res = await fetch(`/api/bmi-record/${id}`, { method: 'DELETE' });
                        if (res && res.ok) {
                            const json = await res.json();
                            if (json && json.success) serverOk = true;
                        }
                    } catch (e) {
                        console.warn('Server delete failed', e);
                    }

                    if (!serverOk) {
                        // If server delete not available, ask user whether to proceed with local delete
                        if (!confirm('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
                    }

                    const idx = allRecords.findIndex(r => r.id === id);
                    if (idx === -1) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
                    allRecords.splice(idx, 1);
                    try { localStorage.setItem('bmiRecords', JSON.stringify(allRecords)); } catch (e) { console.error('Failed to save after delete', e); }

                    // Refresh sidebar and tables
                    renderSidebar('', currentRoom);
                    if (currentSelectedName) {
                        const remaining = allRecords.filter(r => (r.name||'').trim() === currentSelectedName);
                        if (remaining.length > 0) selectChild(currentSelectedName);
                        else { currentSelectedName = null; if (currentRoom) showClassroomSummary(currentRoom); else updateDashboard(); }
                    } else {
                        updateDashboard();
                    }
                } catch (e) { console.error('deleteRecord error', e); }
        }
        function toggleSidebarMobile() { document.querySelector('aside').classList.toggle('hidden'); }
        // Search removed ‚Äî no listener
        const pf = document.getElementById('inputPhoto'); if(pf) pf.addEventListener('change', function(){ const f=this.files[0]; if(f){ const r=new FileReader(); r.onload=()=>document.getElementById('inputPhotoPreview').src=r.result; r.readAsDataURL(f); document.getElementById('inputPhotoPreview').style.display='block'; }});

        initApp();
    </script>
</body>
</html>