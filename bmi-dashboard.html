<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏≤‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand-brown: #74640a; --brand-brown-dark: #3b3305; }
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%); }
        /* Brand overrides to match catalog theme */
        .header-bg { background-color: var(--brand-brown) !important; color: #fff !important; }
        .brand-btn { background-color: var(--brand-brown) !important; border-color: var(--brand-brown) !important; color: #fff !important; }
        .brand-btn:hover { background-color: #5f4f07 !important; }
        /* Sidebar brand styles */
        .side-item { transition: all 0.12s; }
        .side-item:hover { background-color: rgba(116,100,10,0.06); }
        .side-item.selected { background-color: rgba(116,100,10,0.08); border-left: 4px solid var(--brand-brown-dark); }
        .brand-avatar { width:2.5rem; height:2.5rem; border-radius:9999px; background-color: rgba(116,100,10,0.06); display:inline-flex; align-items:center; justify-content:center; color:var(--brand-brown); font-weight:700; }
        .brand-addbtn { margin-left:0.5rem; font-size:0.75rem; background-color: rgba(116,100,10,0.06); color: var(--brand-brown); padding:0.25rem 0.5rem; border-radius:9999px; }
        .brand-addbtn:hover { background-color: rgba(116,100,10,0.12); }
        /* Style file input button to match brand */
        input[type="file"]::-webkit-file-upload-button { background-color: rgba(116,100,10,0.06); color: var(--brand-brown); border: none; padding: 6px 10px; border-radius: 9999px; }
        input[type="file"]::file-selector-button { background-color: rgba(116,100,10,0.06); color: var(--brand-brown); border: none; padding: 6px 10px; border-radius: 9999px; }
        .text-brand { color: var(--brand-brown) !important; }
        .list-item { transition: all 0.2s; }
        .list-item.active { background-color: #eff6ff; border-left: 4px solid #3b82f6; }
        
        /* Pill Badges - ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á */
        .status-pill {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
            white-space: nowrap;
        }
        /* ‡πÅ‡∏î‡∏á (‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤) */
        .status-red { background-color: #ffe4e6; color: #e11d48; } 
        /* ‡∏™‡πâ‡∏° (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á) */
        .status-orange { background-color: #ffedd5; color: #c2410c; }
        /* ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏ó‡πâ‡∏ß‡∏° - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á) */
        .status-yellow { background-color: #fef9c3; color: #a16207; } 
        /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏õ‡∏Å‡∏ï‡∏¥) */
        .status-green { background-color: #dcfce7; color: #15803d; }
        /* Canvas full width on small screens */
        canvas{width:100% !important; height:auto !important; display:block}

        /* Larger mobile toggle buttons */
        #globalSidebarToggle, #mobileToggleBtn {
            width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; font-size:20px;
        }
        @media (min-width:640px) {
            #globalSidebarToggle, #mobileToggleBtn { width:36px; height:36px; font-size:16px; }
        }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-auto flex flex-col lg:flex-row">

    <!-- Global mobile sidebar toggle (visible when sidebar hidden) -->
    <button id="globalSidebarToggle" onclick="toggleSidebarMobile()" class="lg:hidden fixed top-4 left-4 z-40 p-2 bg-white/90 backdrop-blur-sm rounded-full shadow-md text-gray-700">‚ò∞</button>

    <aside class="w-full lg:w-[350px] bg-white border-r border-gray-200 flex flex-col h-full z-20 shadow-lg lg:shadow-none">
        <div class="p-5 border-b bg-white flex justify-between items-center sticky top-0">
            <div class="flex items-center gap-2">
                <button id="mobileToggleBtn" onclick="toggleSidebarMobile()" class="lg:hidden p-2 rounded-full bg-transparent hover:bg-transparent text-gray-600">‚ò∞</button>
                <h2 class="font-bold text-x text-gray-800">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2>
            </div>
            <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-full shadow transition-all flex items-center gap-1 brand-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
        </div>
        <div class="p-3 bg-gray-50 border-b">
            <input id="searchName" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." class="w-full p-2.5 bg-white border border-gray-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 transition-all" />
        </div>
        <div id="childrenList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50"></div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-auto relative">
        <div id="contentSection" class="flex-1 overflow-y-auto p-4 lg:p-8 pb-20 hidden">
            
            <div id="captureAreaDashboard" class="max-w-5xl mx-auto space-y-8 w-full px-2 sm:px-0">

                <div class="flex justify-center">
                    <div class="bg-white rounded-[2rem] shadow-xl p-8 w-full max-w-md text-center border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 rounded-bl-full -mr-10 -mt-10 opacity-50 pointer-events-none" style="background-color: rgba(116,100,10,0.06);"></div>

                        <h2 class="text-xl font-bold text-gray-800 mb-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2>
                        <p class="text-gray-400 text-sm mb-6" id="cardDate">-</p>

                        <div class="flex flex-col items-center mb-6">
                            <div class="w-28 h-28 bg-gray-100 rounded-full flex items-center justify-center text-5xl mb-4 shadow-inner border-4 border-white relative">
                                <img id="cardThumb" src="" class="w-full h-full object-cover rounded-full hidden">
                                <span id="cardThumbPlaceholder">üë∂</span>
                            </div>
                            <div class="text-gray-500 font-medium" id="cardAgeText">‡∏≠‡∏≤‡∏¢‡∏∏ - ‡∏õ‡∏µ - ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                        </div>

                        <div class="flex gap-4 mb-8">
                            <div class="flex-1 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                                <div class="text-gray-400 text-sm mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</div>
                                <div class="text-2xl font-bold text-gray-800"><span id="cardWeight">-</span> <span class="text-sm font-normal text-gray-500">‡∏Å‡∏Å.</span></div>
                            </div>
                            <div class="flex-1 bg-white border border-gray-100 rounded-2xl p-4 shadow-sm">
                                <div class="text-gray-400 text-sm mb-1">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</div>
                                <div class="text-2xl font-bold text-gray-800"><span id="cardHeight">-</span> <span class="text-sm font-normal text-gray-500">‡∏ã‡∏°.</span></div>
                            </div>
                        </div>

                        <div class="space-y-4 text-left">
                            <div class="flex items-center justify-between border-b border-gray-50 pb-2">
                                <span class="text-gray-600 font-medium">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</span>
                                <span id="badgeWH" class="status-pill status-red">‡∏£‡∏≠‡∏ú‡∏•</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-gray-50 pb-2">
                                <span class="text-gray-600 font-medium">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                <span id="badgeHA" class="status-pill status-green">‡∏£‡∏≠‡∏ú‡∏•</span>
                            </div>
                            <!-- WA Badge container, will hide if age > 6 -->
                            <div id="badgeContainerWA" class="flex items-center justify-between border-b border-gray-50 pb-2">
                                <span class="text-gray-600 font-medium">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏</span>
                                <span id="badgeWA" class="status-pill status-red">‡∏£‡∏≠‡∏ú‡∏•</span>
                            </div>
                        </div>

                        <div class="mt-8 text-xs text-gray-300">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (0-19 ‡∏õ‡∏µ)</div>
                        
                        <div class="mt-6 flex gap-2 justify-center">
                            <button onclick="openAddModal()" class="text-brand text-sm hover:underline">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                            <span class="text-gray-300">|</span>
                            <button onclick="exportToCSV()" class="text-green-500 text-sm hover:underline">Export CSV</button>
                            <button onclick="exportToPNG()" class="text-purple-600 text-sm hover:underline">Export PNG</button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                    <!-- ID added to containers for hiding -->
                    <div id="containerWA" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 id="labelWA" class="font-bold text-gray-700 mb-4 text-sm flex items-center"><span class="w-2 h-5 bg-blue-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏ (0-5 ‡∏õ‡∏µ)</h3>
                        <div class="h-[220px] sm:h-[300px]"><canvas id="chartWA"></canvas></div>
                        <div class="mt-3 text-xs text-gray-600">
                            <div class="flex flex-col gap-2 text-sm">
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#065f46"></span><span>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#10b981"></span><span>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f97316"></span><span>‡∏™‡πâ‡∏°: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#ef4444"></span><span>‡πÅ‡∏î‡∏á (‡∏•‡πà‡∏≤‡∏á): ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢</span></div>
                            </div>
                        </div>
                    </div>
                    <div id="containerHA" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 id="labelHA" class="font-bold text-gray-700 mb-4 text-sm flex items-center"><span class="w-2 h-5 bg-teal-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏ (0-5 ‡∏õ‡∏µ)</h3>
                        <div class="h-[220px] sm:h-[300px]"><canvas id="chartHA"></canvas></div>
                        <div class="mt-3 text-xs text-gray-600">
                            <div class="flex flex-col gap-2 text-sm">
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#065f46"></span><span>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏ö‡∏ô): ‡∏™‡∏π‡∏á</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#059669"></span><span>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f59e0b"></span><span>‡∏™‡πâ‡∏°: ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#ef4444"></span><span>‡πÅ‡∏î‡∏á: ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢</span></div>
                            </div>
                        </div>
                    </div>
                    <div id="containerWH" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 xl:col-span-2">
                        <h3 id="labelWH" class="font-bold text-gray-700 mb-4 text-sm flex items-center"><span class="w-2 h-5 bg-purple-500 rounded mr-2"></span>‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</h3>
                        <div class="h-[260px] sm:h-[350px]"><canvas id="chartWH"></canvas></div>
                        <div class="mt-3 text-xs text-gray-600">
                            <div class="flex flex-col gap-2 text-sm">
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#ef4444"></span><span>‡πÅ‡∏î‡∏á: ‡∏≠‡πâ‡∏ß‡∏ô</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#10b981"></span><span>‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß: ‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#f97316"></span><span>‡∏™‡πâ‡∏°: ‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏°</span></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-sm" style="background:#ef4444"></span><span>‡πÅ‡∏î‡∏á (‡∏•‡πà‡∏≤‡∏á): ‡∏ú‡∏≠‡∏°</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-50"><h3 class="font-bold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3></div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-50 text-gray-500 font-medium">
                                <tr>
                                    <th class="px-6 py-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="px-6 py-4">‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                    <th class="px-6 py-4 text-right">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å</th>
                                    <th class="px-6 py-4 text-right">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á</th>
                                    <th class="px-6 py-4 text-center">‡∏ô/‡∏™ (‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á)</th>
                                    <th class="px-6 py-4 text-center">‡∏™/‡∏≠ (‡∏™‡∏π‡∏á)</th>
                                    <th class="px-6 py-4 text-center">‡∏ô/‡∏≠ (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center text-4xl mb-4 text-gray-300">üìä</div>
            <p class="text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡πá‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</p>
            <p class="text-sm">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
        </div>
    </main>

    <div id="addModal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-all">
        <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden transform scale-100">
            <div class="bg-blue-600 p-5 relative flex justify-center items-center text-white header-bg">
                <h3 class="font-bold text-lg">‡∏™‡∏°‡∏≤‡∏£‡πå‡∏ó‡πÅ‡∏ó‡∏£‡∏Ñ</h3>
                <button onclick="closeAddModal()" class="absolute right-3 top-3 opacity-70 hover:opacity-100 text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-5">
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-600 mb-1">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢ / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î <span class="text-xs text-gray-400">(‡∏ñ‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô)</span></label>
                    <div class="flex items-center gap-3">
                        <input type="file" id="inputPhoto" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <img id="inputPhotoPreview" src="" alt="preview" style="display:none; width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb;" />
                    </div>
                </div>
                <div class="flex gap-3">
                    <label class="cursor-pointer w-1/2">
                        <input type="radio" name="gender" value="boy" class="peer hidden" checked onchange="updateModalTheme()">
                        <div class="py-3 rounded-2xl border-2 border-gray-100 peer-checked:border-blue-500 peer-checked:bg-blue-50 text-gray-400 peer-checked:text-blue-600 font-bold text-center transition-all">üë¶ ‡∏ä‡∏≤‡∏¢</div>
                    </label>
                    <label class="cursor-pointer w-1/2">
                        <input type="radio" name="gender" value="girl" class="peer hidden" onchange="updateModalTheme()">
                        <div class="py-3 rounded-2xl border-2 border-gray-100 peer-checked:border-pink-500 peer-checked:bg-pink-50 text-gray-400 peer-checked:text-pink-600 font-bold text-center transition-all">üëß ‡∏´‡∏ç‡∏¥‡∏á</div>
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠</label>
                    <input type="text" id="inputName" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-gray-700" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠..." />
                </div>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                        <input type="number" id="inputYear" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center" placeholder="0" />
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                        <input type="number" id="inputMonth" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center" placeholder="0" />
                    </div>
                </div>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                        <input type="number" id="inputWeight" step="0.1" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center text-blue-600 text-lg" placeholder="0.0" />
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-600 mb-1">‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label>
                        <input type="number" id="inputHeight" step="0.1" class="w-full p-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-blue-200 font-bold text-center text-blue-600 text-lg" placeholder="0.0" />
                    </div>
                </div>
                
                <button onclick="saveRecord()" id="saveBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-200 transition-all mt-2 brand-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA FROM UPLOADED PDF FILES (0-5 & 6-19) ---
        // Array Format: [ -2SD, -1.5SD, Median, +1.5SD, +2SD, +3SD ]
        
        const growthData = {
            boy: {
                group_0_5: {
                    w_h: [
                        {x:65,y:[6.6,6.9,7.5,8.3,8.9,9.8]}, 
                        {x:70,y:[7.4,7.8,8.5,9.5,10.2,11.5]}, 
                        {x:75,y:[8.2,8.7,9.6,10.8,11.6,13.0]}, 
                        {x:80,y:[9.1,9.6,10.6,12.0,12.9,14.6]}, 
                        {x:85,y:[10.0,10.7,11.8,13.4,14.5,16.4]}, 
                        {x:90,y:[11.0,11.8,13.0,14.8,16.0,18.2]}, 
                        {x:95,y:[12.1,12.9,14.3,16.4,17.7,20.1]}, 
                        {x:100,y:[13.2,14.1,15.7,18.0,19.5,22.2]}, 
                        {x:105,y:[14.4,15.5,17.3,19.9,21.5,24.5]}, 
                        {x:110,y:[15.8,16.9,19.0,22.0,23.7,27.0]}, 
                        {x:115,y:[17.2,18.5,20.9,24.2,26.1,29.9]}, 
                        {x:120,y:[18.8,20.2,23.0,26.7,28.8,33.0]},
                        {x:125,y:[20.5,22.1,25.3,29.5,31.8,36.5]},
                        {x:130,y:[22.5,24.3,28.0,32.7,35.3,40.6]},
                        {x:135,y:[24.8,26.8,30.9,36.2,39.2,45.1]},
                        {x:140,y:[27.3,29.7,34.3,40.2,43.6,50.4]}
                    ],
                    w_a: [
                        {x:0,y:[2.4,2.6,3.3,4.2,4.5]}, 
                        {x:6,y:[6.4,6.8,7.9,9.4,9.9]}, 
                        {x:12,y:[7.7,8.2,9.6,11.2,11.9]}, 
                        {x:18,y:[8.8,9.4,10.9,12.8,13.7]}, 
                        {x:24,y:[9.7,10.3,12.2,14.4,15.3]}, 
                        {x:30,y:[10.5,11.2,13.3,15.7,16.9]}, 
                        {x:36,y:[11.3,12.0,14.3,17.0,18.3]}, 
                        {x:42,y:[12.0,12.8,15.3,18.2,19.7]}, 
                        {x:48,y:[12.7,13.6,16.3,19.4,21.2]}, 
                        {x:54,y:[13.4,14.3,17.3,20.7,22.7]}, 
                        {x:60,y:[14.1,15.1,18.3,21.9,24.2]}, 
                        {x:72,y:[15.5,16.6,20.2,24.5,27.0]}
                    ],
                    h_a: [
                        {x:0,y:[46,47,50,53,54]}, 
                        {x:6,y:[63,64,68,71,72]}, 
                        {x:12,y:[71,72,76,79,81]}, 
                        {x:18,y:[77,78,82,86,88]}, 
                        {x:24,y:[81,82,87,92,93]}, 
                        {x:30,y:[85,86,92,97,98]}, 
                        {x:36,y:[88,90,96,101,103]}, 
                        {x:42,y:[92,93,100,105,107]}, 
                        {x:48,y:[95,96,103,109,111]}, 
                        {x:54,y:[98,99,107,113,115]}, 
                        {x:60,y:[100,102,110,116,119]}, 
                        {x:72,y:[105,107,116,123,125]}
                    ]
                },
                group_6_19: {
                    w_h: [
                        {x:90, y:[11.0, 11.8, 13.0, 14.8, 16.0, 18.2]},
                        {x:95, y:[12.1, 12.9, 14.3, 16.4, 17.7, 20.1]},
                        {x:100, y:[13.2, 14.1, 15.7, 18.0, 19.5, 22.2]},
                        {x:105, y:[14.4, 15.5, 17.3, 19.9, 21.5, 24.5]},
                        {x:110, y:[15.8, 16.9, 19.0, 22.0, 23.7, 27.0]},
                        {x:115, y:[17.2, 18.5, 20.9, 24.2, 26.1, 29.9]},
                        {x:120, y:[18.8, 20.2, 23.0, 26.7, 28.8, 33.0]},
                        {x:125, y:[20.5, 22.1, 25.3, 29.5, 31.8, 36.5]},
                        {x:130, y:[22.5, 24.3, 28.0, 32.7, 35.3, 40.6]},
                        {x:135, y:[24.8, 26.8, 30.9, 36.2, 39.2, 45.1]},
                        {x:140, y:[27.3, 29.7, 34.3, 40.2, 43.6, 50.4]},
                        {x:145, y:[30.0, 32.5, 37.5, 44.5, 48.0, 56.0]},
                        {x:150, y:[32.5, 35.5, 41.0, 48.5, 53.0, 61.5]},
                        {x:155, y:[35.5, 38.5, 45.0, 53.5, 58.0, 67.0]},
                        {x:160, y:[38.5, 42.0, 49.0, 58.0, 63.0, 73.0]},
                        {x:165, y:[41.5, 45.5, 53.0, 62.5, 68.0, 79.0]},
                        {x:170, y:[45.0, 49.0, 57.0, 67.0, 73.0, 85.0]},
                        {x:175, y:[48.0, 52.5, 61.0, 72.0, 78.0, 91.0]},
                        {x:180, y:[51.0, 56.0, 65.0, 77.0, 83.0, 97.0]},
                        {x:185, y:[54.0, 59.0, 69.0, 81.0, 88.0, 103.0]}
                    ],
                    h_a: [
                        {x:6, y:[106, 109, 116, 122, 125]},
                        {x:7, y:[111, 114, 121, 128, 131]},
                        {x:8, y:[116, 119, 127, 134, 137]},
                        {x:9, y:[121, 125, 132, 140, 143]},
                        {x:10, y:[126, 130, 138, 146, 149]},
                        {x:11, y:[131, 136, 144, 153, 157]},
                        {x:12, y:[137, 142, 151, 161, 165]},
                        {x:13, y:[144, 149, 159, 169, 174]},
                        {x:14, y:[150, 156, 166, 176, 181]},
                        {x:15, y:[155, 161, 171, 181, 186]},
                        {x:16, y:[158, 164, 174, 184, 189]},
                        {x:17, y:[160, 166, 176, 186, 190]},
                        {x:18, y:[161, 167, 177, 186, 191]},
                        {x:19, y:[161, 167, 177, 187, 191]}
                    ]
                }
            },
            girl: {
                group_0_5: {
                    w_h: [
                        {x:65,y:[6.3,6.5,7.2,8.1,8.7,9.6]}, 
                        {x:70,y:[7.0,7.3,8.2,9.2,9.9,11.1]}, 
                        {x:75,y:[7.8,8.2,9.1,10.3,11.1,12.5]}, 
                        {x:80,y:[8.6,9.1,10.2,11.5,12.4,14.0]}, 
                        {x:85,y:[9.6,10.1,11.4,12.9,13.9,15.7]}, 
                        {x:90,y:[10.6,11.2,12.7,14.4,15.6,17.7]}, 
                        {x:95,y:[11.7,12.4,14.1,16.1,17.4,19.8]}, 
                        {x:100,y:[12.9,13.7,15.7,18.0,19.4,22.2]}, 
                        {x:105,y:[14.2,15.1,17.4,20.1,21.7,24.9]}, 
                        {x:110,y:[15.7,16.7,19.3,22.4,24.3,27.8]}, 
                        {x:115,y:[17.3,18.4,21.4,25.0,27.1,31.1]}, 
                        {x:120,y:[19.1,20.4,23.8,27.9,30.3,34.8]}, 
                        {x:125,y:[21.1,22.6,26.6,31.3,34.0,39.1]}, 
                        {x:130,y:[23.4,25.1,29.8,35.2,38.3,44.1]}, 
                        {x:135,y:[25.9,27.9,33.3,39.6,43.1,49.8]}, 
                        {x:140,y:[28.7,31.1,37.3,44.6,48.6,56.4]}
                    ],
                    w_a: [
                        {x:0,y:[2.3,2.5,3.2,4.0,4.3]}, 
                        {x:6,y:[5.7,6.1,7.3,8.7,9.3]}, 
                        {x:12,y:[7.0,7.5,8.9,10.6,11.4]}, 
                        {x:18,y:[8.1,8.6,10.2,12.2,13.1]}, 
                        {x:24,y:[9.0,9.6,11.5,13.7,14.8]}, 
                        {x:30,y:[9.8,10.5,12.7,15.2,16.4]}, 
                        {x:36,y:[10.7,11.4,13.9,16.7,18.1]}, 
                        {x:42,y:[11.5,12.3,15.0,18.1,19.6]}, 
                        {x:48,y:[12.2,13.1,16.1,19.5,21.2]}, 
                        {x:54,y:[12.9,13.9,17.2,21.0,22.9]}, 
                        {x:60,y:[13.6,14.6,18.2,22.3,24.4]}, 
                        {x:72,y:[15.0,16.1,20.5,25.5,28.0]}
                    ],
                    h_a: [
                        {x:0,y:[45,46,49,52,53]}, 
                        {x:6,y:[61,62,66,69,70]}, 
                        {x:12,y:[69,70,74,78,79]}, 
                        {x:18,y:[75,76,81,85,87]}, 
                        {x:24,y:[80,81,86,91,92]}, 
                        {x:30,y:[84,85,91,96,97]}, 
                        {x:36,y:[87,89,95,101,102]}, 
                        {x:42,y:[91,92,99,105,106]}, 
                        {x:48,y:[94,95,103,109,111]}, 
                        {x:54,y:[97,98,106,113,115]}, 
                        {x:60,y:[99,101,109,117,119]}, 
                        {x:72,y:[105,106,116,123,125]}
                    ]
                },
                group_6_19: {
                    w_h: [
                        {x:90, y:[11.0, 11.5, 12.8, 14.5, 16.0, 17.5]},
                        {x:95, y:[12.0, 12.8, 14.0, 16.0, 17.5, 19.5]},
                        {x:100, y:[13.0, 14.0, 15.5, 17.5, 19.0, 21.5]},
                        {x:105, y:[14.2, 15.2, 17.2, 19.5, 21.5, 24.5]},
                        {x:110, y:[15.8, 16.8, 19.0, 22.0, 24.0, 27.5]},
                        {x:115, y:[17.5, 18.5, 21.0, 24.5, 27.0, 31.0]},
                        {x:120, y:[19.0, 20.5, 23.5, 27.5, 30.0, 34.5]},
                        {x:125, y:[21.0, 22.5, 26.0, 31.0, 33.5, 38.5]},
                        {x:130, y:[23.5, 25.0, 29.5, 34.5, 38.0, 43.5]},
                        {x:135, y:[26.0, 28.0, 33.0, 39.0, 42.5, 49.0]},
                        {x:140, y:[29.0, 31.0, 37.0, 44.0, 48.0, 55.5]},
                        {x:145, y:[31.5, 34.0, 40.5, 48.5, 53.0, 62.0]},
                        {x:150, y:[34.5, 37.0, 44.5, 53.5, 58.5, 68.0]},
                        {x:155, y:[37.5, 40.5, 48.0, 57.5, 63.5, 74.0]},
                        {x:160, y:[40.0, 43.5, 52.0, 62.0, 68.0, 80.0]},
                        {x:165, y:[43.0, 46.5, 55.5, 66.0, 72.5, 85.0]},
                        {x:170, y:[45.5, 49.0, 58.5, 70.0, 77.0, 90.0]},
                        {x:175, y:[47.5, 51.5, 61.5, 73.5, 81.0, 95.0]}
                    ],
                    h_a: [
                        {x:6, y:[105, 108, 115, 121, 124]},
                        {x:7, y:[110, 113, 120, 127, 130]},
                        {x:8, y:[115, 118, 126, 133, 136]},
                        {x:9, y:[120, 124, 132, 139, 142]},
                        {x:10, y:[126, 130, 138, 146, 149]},
                        {x:11, y:[132, 137, 145, 153, 157]},
                        {x:12, y:[138, 143, 151, 159, 163]},
                        {x:13, y:[144, 149, 156, 164, 167]},
                        {x:14, y:[147, 152, 159, 166, 169]},
                        {x:15, y:[149, 154, 160, 167, 170]},
                        {x:16, y:[150, 154, 161, 168, 171]},
                        {x:17, y:[150, 155, 161, 168, 171]},
                        {x:18, y:[150, 155, 161, 168, 171]},
                        {x:19, y:[151, 155, 162, 169, 172]}
                    ]
                }
            }
        };

        // Helper to choose a reference group by age/height
        function getRefsFor(gender, ageTotalM, height) {
            const g = growthData[gender] || growthData['boy'];
            const use0_5 = (ageTotalM <= 72); // <= 6 years
            const group = use0_5 ? g.group_0_5 : g.group_6_19;

            let refWA = null, refHA = null, refWH = null;

            if (use0_5) {
                if (group.w_a) refWA = getLinearInterpolation(group.w_a, ageTotalM);
                if (group.h_a) refHA = getLinearInterpolation(group.h_a, ageTotalM);
                if (group.w_h) refWH = getLinearInterpolation(group.w_h, height);
            } else {
                // For age > 19, cap reference at 19 years (228 months) for standards logic
                const cappedAgeM = Math.min(ageTotalM, 228); 
                const ageY = Math.floor(cappedAgeM / 12);
                if (group.h_a) refHA = getLinearInterpolation(group.h_a, ageY);
                if (group.w_h) refWH = getLinearInterpolation(group.w_h, height);
                // For ages 6-19 we do NOT provide Weight-for-Age (WA)
            }

            return { refWA, refHA, refWH };
        }

        // --- 2. EVALUATION LOGIC (Criteria from PDF Labels) ---
        function getLinearInterpolation(dataset, inputX) {
            if (inputX <= dataset[0].x) return dataset[0].y;
            if (inputX >= dataset[dataset.length-1].x) return dataset[dataset.length-1].y;
            for (let i = 0; i < dataset.length - 1; i++) {
                if (inputX >= dataset[i].x && inputX <= dataset[i+1].x) {
                    const t = (inputX - dataset[i].x) / (dataset[i+1].x - dataset[i].x);
                    const yArr = [];
                    // Handle 5 or 6 items array based on what available
                    const len = dataset[i].y.length;
                    for(let j=0; j<len; j++) yArr.push(dataset[i].y[j] * (1 - t) + dataset[i+1].y[j] * t);
                    return yArr;
                }
            }
            return dataset[0].y;
        }

        function evaluateStatus(val, ref, type) {
            // Generic evaluator that adapts to ref length.
            if (!ref || !Array.isArray(ref) || ref.length === 0) return { t: '-', c: 'bg-gray-100' };
            const len = ref.length;
            const median = ref[Math.floor((len - 1) / 2)];
            const low = ref[0];
            const high = ref[len - 1];

            if (type === 'HA') {
                if (val > high) return { t: "‡∏™‡∏π‡∏á", c: "status-green bg-green-100 text-green-700" };
                if (val >= median) return { t: "‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå", c: "status-green" };
                if (val >= low) return { t: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡∏µ‡πâ‡∏¢", c: "status-orange" };
                return { t: "‡πÄ‡∏ï‡∏µ‡πâ‡∏¢", c: "status-red" };
            }

            if (type === 'WA') {
                if (val > high) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏°‡∏≤‡∏Å", c: "status-red" };
                if (val >= median) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå", c: "status-green" };
                if (val >= low) return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢", c: "status-orange" };
                return { t: "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", c: "status-red" };
            }

            if (type === 'WH') {
                if (val > high) return { t: "‡∏≠‡πâ‡∏ß‡∏ô", c: "status-red" };
                if (val >= median) return { t: "‡∏™‡∏°‡∏™‡πà‡∏ß‡∏ô", c: "status-green" };
                if (val >= low) return { t: "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ú‡∏≠‡∏°", c: "status-orange" };
                return { t: "‡∏ú‡∏≠‡∏°", c: "status-red" };
            }

            return { t: '-', c: 'bg-gray-100' };
        }

        // --- 3. APP LOGIC ---
        let allRecords = [];
        let currentSelectedName = null;
        let chartInstances = {};

        async function fetchRecords() {
            try {
                const res = await fetch('/api/bmi-records');
                if (res.ok) { const json = await res.json(); return json.records || []; }
            } catch(e) {}
            return localStorage.getItem('bmiRecords') ? JSON.parse(localStorage.getItem('bmiRecords')) : [];
        }

        function groupByName(records) {
            const map = new Map();
            records.forEach(r => {
                const name = (r.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').trim();
                if (!map.has(name)) map.set(name, []);
                map.get(name).push(r);
            });
            return map;
        }

        function formatDate(d) {
            try { 
                return new Date(d).toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'2-digit'}); 
            } catch (e) { return d; }
        }

        async function initApp() {
            allRecords = await fetchRecords();
            renderSidebar();
        }

        function renderSidebar(filter = '') {
            const listEl = document.getElementById('childrenList');
            listEl.innerHTML = '';
            const grouped = groupByName(allRecords);
            const names = Array.from(grouped.keys()).filter(n => n.includes(filter));

            if (names.length === 0) {
                listEl.innerHTML = '<div class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }

            names.forEach(name => {
                const items = grouped.get(name).sort((a,b) => new Date(b.date) - new Date(a.date)); 
                const latest = items[0];
                const div = document.createElement('div');
                div.className = `p-4 cursor-pointer flex items-center gap-3 border-b border-gray-100 side-item ${currentSelectedName === name ? 'selected' : ''}`;
                div.onclick = () => selectChild(name);
                
                const imgSrc = latest.photo || '';
                const imgHtml = imgSrc ? `<img src="${imgSrc}" class="w-10 h-10 rounded-full object-cover">` : `<div class="brand-avatar">${name[0]}</div>`;
                
                div.innerHTML = `
                    ${imgHtml}
                    <div class="flex-1">
                        <div class="font-bold text-gray-700">${name}</div>
                        <div class="text-xs text-gray-400">${latest.ageY}‡∏õ‡∏µ ${latest.ageM_Input}‡∏î ¬∑ ${formatDate(latest.date)}</div>
                    </div>
                `;

                // add per-child add button (doesn't trigger selectChild when clicked)
                const addBtn = document.createElement('button');
                addBtn.type = 'button';
                addBtn.className = 'ml-2 text-xs brand-addbtn';
                addBtn.innerText = '+ ‡πÄ‡∏û‡∏¥‡πà‡∏°';
                addBtn.onclick = function(ev) { ev.stopPropagation(); openAddModalFor(name); };

                // place button to the right
                div.appendChild(addBtn);
                listEl.appendChild(div);
            });
        }

        function selectChild(name) {
            currentSelectedName = name;
            renderSidebar(document.getElementById('searchName').value);
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('contentSection').style.display = 'block';

            const items = allRecords.filter(r => r.name === name).sort((a,b) => a.ageTotalM - b.ageTotalM);
            const latest = items[items.length - 1]; 

            // Update Card
            const gender = latest.gender || 'boy';
            const refs = getRefsFor(gender, latest.ageTotalM, latest.h);

            const refWA = refs.refWA;
            const refHA = refs.refHA;
            const refWH = refs.refWH;

            // Status Calculations
            let stWH = {t:'-', c:'bg-gray-100'};
            if (refWH) {
                stWH = evaluateStatus(latest.w, refWH, 'WH');
            } else {
                stWH = {t:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', c:'bg-gray-100 text-gray-500'};
            }

            const stHA = refHA ? evaluateStatus(latest.h, refHA, 'HA') : {t:'-', c:'bg-gray-100'};
            const stWA = refWA ? evaluateStatus(latest.w, refWA, 'WA') : {t:'-', c:'bg-gray-100'};

            // Update DOM Elements
            document.getElementById('cardDate').innerText = new Date(latest.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: '2-digit' });
            document.getElementById('cardAgeText').innerText = `‡∏≠‡∏≤‡∏¢‡∏∏ ${latest.ageY} ‡∏õ‡∏µ ${latest.ageM_Input} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
            
            const imgEl = document.getElementById('cardThumb');
            const phEl = document.getElementById('cardThumbPlaceholder');
            if(latest.photo){ imgEl.src = latest.photo; imgEl.classList.remove('hidden'); phEl.classList.add('hidden'); }
            else { imgEl.classList.add('hidden'); phEl.classList.remove('hidden'); }

            document.getElementById('cardWeight').innerText = latest.w;
            document.getElementById('cardHeight').innerText = latest.h;

            const bWH = document.getElementById('badgeWH'); bWH.innerText = stWH.t; bWH.className = `status-pill ${stWH.c}`;
            const bHA = document.getElementById('badgeHA'); bHA.innerText = stHA.t; bHA.className = `status-pill ${stHA.c}`;
            const bWA = document.getElementById('badgeWA'); bWA.innerText = stWA.t; bWA.className = `status-pill ${stWA.c}`;

            // Hide WA badge if child > 6 years
            const isOlder = latest.ageTotalM > 72;
            const badgeContainerWA = document.getElementById('badgeContainerWA');
            if(badgeContainerWA) badgeContainerWA.style.display = isOlder ? 'none' : 'flex';

            // History Table
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            [...items].reverse().forEach(row => {
                const rowGender = row.gender || gender;
                const rowRefs = getRefsFor(rowGender, row.ageTotalM, row.h);
                
                // Only calculate WA if available
                const rWA = rowRefs.refWA ? evaluateStatus(row.w, rowRefs.refWA, 'WA') : {t:'-', c:'bg-gray-100'};
                const rHA = rowRefs.refHA ? evaluateStatus(row.h, rowRefs.refHA, 'HA') : {t:'-', c:'bg-gray-100'};
                let rWH = {t:'-', c:''};
                if (rowRefs.refWH) {
                    rWH = evaluateStatus(row.w, rowRefs.refWH, 'WH');
                }
                
                const tr = document.createElement('tr');
                tr.className = "bg-white hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4">${formatDate(row.date)}</td>
                    <td class="px-6 py-4">${row.ageY}‡∏õ‡∏µ ${row.ageM_Input}‡∏î</td>
                    <td class="px-6 py-4 text-right font-bold">${row.w}</td>
                    <td class="px-6 py-4 text-right font-bold">${row.h}</td>
                    <td class="px-6 py-4 text-center"><span class="status-pill ${rWH.c} text-xs py-1 px-3">${rWH.t}</span></td>
                    <td class="px-6 py-4 text-center"><span class="status-pill ${rHA.c} text-xs py-1 px-3">${rHA.t}</span></td>
                    <td class="px-6 py-4 text-center"><span class="status-pill ${rWA.c} text-xs py-1 px-3">${rWA.t}</span></td>
                `;
                tbody.appendChild(tr);
            });

            updateCharts(items, gender);
            // On small screens, hide sidebar to show content fully and scroll to content
            try {
                if (window.innerWidth < 1024) {
                    const as = document.querySelector('aside'); if (as) as.classList.add('hidden');
                    const cs = document.getElementById('contentSection'); if (cs) cs.scrollIntoView({ behavior: 'smooth' });
                }
            } catch(e) { /* ignore */ }
        }

        // --- CHARTS (Matched to PDF Zones) ---
        function updateCharts(data, gender) {
            const genderObj = growthData[gender] || growthData['boy'];
            
            // Check if older group (>6 years / 72 months)
            const latest = data[data.length - 1];
            const isOlder = latest && latest.ageTotalM > 72;

            // --- 1. WA Chart logic (Weight for Age) ---
            // If older, HIDE containerWA. Else show it.
            const containerWA = document.getElementById('containerWA');
            if (isOlder) {
                if(containerWA) containerWA.classList.add('hidden');
            } else {
                if(containerWA) containerWA.classList.remove('hidden');
                // Render 0-5 WA chart
                const refWA = genderObj.group_0_5 && genderObj.group_0_5.w_a ? genderObj.group_0_5.w_a : [];
                createAreaChart('chartWA', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)', '‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', data.map(d => d.ageTotalM), data.map(d => d.w), refWA, 0, 72);
            }

            // --- 2. HA Chart logic (Height for Age) ---
            let refHA = [];
            let minX_HA = 0, maxX_HA = 72;
            let titleHA = "‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏ (0-5 ‡∏õ‡∏µ)";
            const containerHA = document.getElementById('containerHA');

            if (isOlder) {
                // For older group, make it full width
                if(containerHA) containerHA.classList.add('xl:col-span-2');

                // Use 6-19 data. X is Years in data, convert to Months for plot
                const raw = genderObj.group_6_19 && genderObj.group_6_19.h_a ? genderObj.group_6_19.h_a : [];
                refHA = raw.map(r => ({ x: r.x * 12, y: r.y }));
                minX_HA = 72; // 6 years
                maxX_HA = 228; // 19 years
                titleHA = "‡∏Å‡∏£‡∏≤‡∏ü‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏≤‡∏¢‡∏∏ (6-19 ‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà)";
            } else {
                // For younger group, standard width
                if(containerHA) containerHA.classList.remove('xl:col-span-2');

                refHA = genderObj.group_0_5 && genderObj.group_0_5.h_a ? genderObj.group_0_5.h_a : [];
            }
            
            const labelHA = document.getElementById('labelHA');
            if(labelHA) labelHA.innerHTML = `<span class="w-2 h-5 bg-teal-500 rounded mr-2"></span>${titleHA}`;
            
            // Plot logic for HA: cap age at 228 if > 19 years
            const plotDataHA = data.map(d => {
                if (isOlder && d.ageTotalM > 228) return 228;
                return d.ageTotalM;
            });
            createAreaChart('chartHA', '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', '‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)', plotDataHA, data.map(d => d.h), refHA, minX_HA, maxX_HA);

            // --- 3. WH Chart logic (Weight for Height) ---
            // Determine based on max height or age. 6-19 WH typically starts from 90cm height.
            const maxH = Math.max(...data.map(d=>d.h));
            const useOlderWH = isOlder || maxH > 120; // Heuristic switch

            let refWH = [];
            let minX_WH = 65, maxX_WH = 125;
            let titleWH = "‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (0-5 ‡∏õ‡∏µ)";

            if (useOlderWH) {
                refWH = genderObj.group_6_19 && genderObj.group_6_19.w_h ? genderObj.group_6_19.w_h : [];
                minX_WH = 90;
                maxX_WH = 185;
                titleWH = "‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (6-19 ‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà)";
            } else {
                refWH = genderObj.group_0_5 && genderObj.group_0_5.w_h ? genderObj.group_0_5.w_h : [];
            }

            const labelWH = document.getElementById('labelWH');
            if(labelWH) labelWH.innerHTML = `<span class="w-2 h-5 bg-purple-500 rounded mr-2"></span>${titleWH}`;

            // Plot logic for WH: clamp height to max Ref height if taller than reference
            const maxRefHeight = refWH.length > 0 ? refWH[refWH.length-1].x : 185;
            const plotDataWH = data.map(d => ({
                x: useOlderWH ? Math.min(d.h, maxRefHeight) : d.h, 
                y: d.w
            }));

            createScatterAreaChart('chartWH', '‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)', '‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', plotDataWH, refWH, minX_WH, maxX_WH);
        }

        function createAreaChart(id, yLabel, xLabel, xData, yData, refData, minX, maxX) {
            const ctx = document.getElementById(id).getContext('2d');
            if(chartInstances[id]) chartInstances[id].destroy();
            
            let labels = [];
            if (refData && refData.length) {
                labels = refData.map(d => d.x);
            } else {
                labels = [minX, maxX];
            }

            const refCount = (refData && refData.length && Array.isArray(refData[0].y)) ? refData[0].y.length : 0;
            const datasets = [];

            datasets.push({ label: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏Å', data: xData.map((x, i) => ({ x: x, y: yData[i] })), borderColor: '#000', borderWidth: 2, pointBackgroundColor: '#000', pointRadius: 5, pointHoverRadius: 7, showLine: true, fill: false, tension: 0, order: 1 });

            // Palette green-yellow-red appropriate for growth charts
            const palette = ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#059669', '#065f46'];

            for (let i = refCount - 1; i >= 0; i--) {
                const paletteIndex = (refCount - 1 - i) % palette.length;
                const color = palette[paletteIndex];
                const data = (refData || []).map(d => ({ x: d.x, y: (Array.isArray(d.y) ? d.y[i] : null) }));
                datasets.push({ label: `ref_${i}`, data: data, borderColor: color, borderWidth: 1, pointRadius: 0, fill: false, tension: 0.2, order: 0 });
            }

            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', min: minX, max: maxX, title: { display: true, text: xLabel } }, y: { title: { display: true, text: yLabel } } }, plugins: { legend: { display: false } } }
            });
        }

        function createScatterAreaChart(id, yLabel, xLabel, points, refData, minX, maxX) {
            const ctx = document.getElementById(id).getContext('2d');
            if(chartInstances[id]) chartInstances[id].destroy();
            const labels = refData.map(d => d.x);
            
            const refCount = (refData && refData.length && Array.isArray(refData[0].y)) ? refData[0].y.length : 0;
            const datasets = [];
            datasets.push({ type: 'scatter', label: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡πá‡∏Å', data: points, backgroundColor: '#000', pointRadius: 5, order: 1 });

            const palette = ['#ef4444', '#f97316', '#f59e0b', '#10b981', '#059669', '#065f46'];
            for (let i = refCount - 1; i >= 0; i--) {
                const paletteIndex = (refCount - 1 - i) % palette.length;
                const color = palette[paletteIndex];
                const data = (refData || []).map(d => ({ x: d.x, y: (Array.isArray(d.y) ? d.y[i] : null) }));
                datasets.push({ type: 'line', data: data, borderColor: color, backgroundColor: color, pointRadius: 0, fill: false, borderWidth: 1, tension: 0.2, order: 0 });
            }

            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'linear', min: minX, max: maxX, title: { display: true, text: xLabel } }, y: { title: { display: true, text: yLabel } } }, plugins: { legend: { display: false } } }
            });
        }

        // --- ACTIONS ---
        const modal = document.getElementById('addModal');
        function openAddModal() {
            modal.classList.remove('hidden');
            if (currentSelectedName) { document.getElementById('inputName').value = currentSelectedName; }
            else { document.getElementById('inputName').value = ''; document.querySelector('input[value="boy"]').checked = true; updateModalTheme(); }
            document.getElementById('inputWeight').value = ''; document.getElementById('inputHeight').value = '';
        }
        
        function openAddModalFor(name) {
            try {
                const items = allRecords.filter(r => (r.name||'').trim() === name).sort((a,b) => new Date(b.date) - new Date(a.date));
                const latest = items.length ? items[0] : null;
                document.getElementById('inputName').value = name || '';
                if (latest && latest.gender) {
                    const radio = document.querySelector(`input[name="gender"][value="${latest.gender}"]`);
                    if (radio) radio.checked = true;
                } else {
                    document.querySelector('input[name="gender"][value="boy"]').checked = true;
                }
                updateModalTheme();
                document.getElementById('inputWeight').value = '';
                document.getElementById('inputHeight').value = '';
                modal.classList.remove('hidden');
            } catch (e) { console.warn('[openAddModalFor] error', e && e.message); modal.classList.remove('hidden'); }
        }
        function closeAddModal() { modal.classList.add('hidden'); }
        function updateModalTheme() {
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const btn = document.getElementById('saveBtn');
            const header = modal.querySelector('.header-bg');
            if (gender === 'boy') {
                btn.className = btn.className.replace('bg-pink-600 hover:bg-pink-700', 'bg-blue-600 hover:bg-blue-700');
                header.className = header.className.replace('bg-pink-600', 'bg-blue-600');
            } else {
                btn.className = btn.className.replace('bg-blue-600 hover:bg-blue-700', 'bg-pink-600 hover:bg-pink-700');
                header.className = header.className.replace('bg-blue-600', 'bg-pink-600');
            }
        }
        function readFileAsDataURL(file) { return new Promise(r => { if(!file)return r(null); const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(file); }); }
        async function saveRecord() {
            const name = document.getElementById('inputName').value.trim();
            const ageY = parseInt(document.getElementById('inputYear').value)||0;
            const ageM = parseInt(document.getElementById('inputMonth').value)||0;
            const w = parseFloat(document.getElementById('inputWeight').value);
            const h = parseFloat(document.getElementById('inputHeight').value);
            const gender = document.querySelector('input[name="gender"]:checked').value;
            const photo = await readFileAsDataURL(document.getElementById('inputPhoto').files[0]);
            if(!name || isNaN(w) || isNaN(h)) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }

            const rec = { id: Date.now(), date: new Date().toISOString(), name, ageY, ageM_Input: ageM, ageTotalM: (ageY*12)+ageM, w, h, gender, photo };

            try {
                let photoBase64 = null, photoMime = null;
                if (rec.photo && typeof rec.photo === 'string') {
                    const m = rec.photo.match(/^data:(image\/[a-zA-Z0-9.+-]+);base64,(.*)$/);
                    if (m) { photoMime = m[1]; photoBase64 = m[2]; }
                }

                const payload = Object.assign({}, rec, { photoBase64, photoMime });
                const resp = await fetch('/api/bmi-record', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (resp && resp.ok) {
                    const j = await resp.json();
                    if (j && j.success && j.id) rec._id = j.id;
                    allRecords.push(rec);
                    try { localStorage.setItem('bmiRecords', JSON.stringify(allRecords)); } catch(e) {}
                    closeAddModal(); renderSidebar(); selectChild(name);
                    return;
                }
            } catch (e) {
                console.warn('[dashboard] failed to save to server, falling back to localStorage', e && e.message);
            }

            allRecords.push(rec);
            try { localStorage.setItem('bmiRecords', JSON.stringify(allRecords)); } catch(e) {}
            closeAddModal(); renderSidebar(); selectChild(name);
        }
        function exportToCSV() {
            if(!currentSelectedName) return;
            const items = allRecords.filter(r => r.name === currentSelectedName).sort((a,b) => new Date(a.date)-new Date(b.date));
            let csv = "\uFEFFDate,Age_Month,Weight,Height,Status_WH,Status_HA,Status_WA\n";
            items.forEach(r => {
                const refs = getRefsFor(r.gender||'boy', r.ageTotalM, r.h);
                const rWA = refs.refWA ? evaluateStatus(r.w, refs.refWA, 'WA').t : '-';
                const rHA = refs.refHA ? evaluateStatus(r.h, refs.refHA, 'HA').t : '-';
                let rWH = '-';
                if (refs.refWH) rWH = evaluateStatus(r.w, refs.refWH, 'WH').t;

                csv += `${new Date(r.date).toLocaleDateString('en-GB')},${r.ageTotalM},${r.w},${r.h},${rWH},${rHA},${rWA}\n`;
            });
            const link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8,"+encodeURIComponent(csv);
            link.download = `Growth_${currentSelectedName}.csv`;
            link.click();
        }

        async function exportToPNG() {
            const el = document.getElementById('captureAreaDashboard');
            if (!el) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'); return; }

            const bodyStyle = document.body.style.overflow;
            const aside = document.querySelector('aside');
            const asideDisplay = aside ? aside.style.display : null;
            const globalToggle = document.getElementById('globalSidebarToggle');
            const mobileToggle = document.getElementById('mobileToggleBtn');
            const contentSection = document.getElementById('contentSection');
            const captureStyle = el.style.cssText;

            try {
                document.body.style.overflow = 'visible';
                if (aside) aside.style.display = 'none';
                if (globalToggle) globalToggle.style.display = 'none';
                if (mobileToggle) mobileToggle.style.display = 'none';
                if (contentSection) contentSection.style.overflow = 'visible';

                const prevMaxWidth = el.style.maxWidth || '';
                const prevWidth = el.style.width || '';
                const prevPadding = el.style.padding || '';
                const prevMargin = el.style.margin || '';
                el.style.maxWidth = '1200px';
                el.style.width = '1200px';
                el.style.padding = '0';
                el.style.margin = '0 auto';

                const historyWrapper = document.getElementById('historyTableBody') ? document.getElementById('historyTableBody').parentElement : null;
                let historyPrev = null;
                if (historyWrapper) {
                    historyPrev = { overflow: historyWrapper.style.overflow, height: historyWrapper.style.height, maxHeight: historyWrapper.style.maxHeight };
                    historyWrapper.style.overflow = 'visible';
                    historyWrapper.style.height = 'auto';
                    historyWrapper.style.maxHeight = 'none';
                }

                try {
                    Object.keys(chartInstances || {}).forEach(k => {
                        const c = chartInstances[k]; if (c && typeof c.resize === 'function') c.resize();
                        if (c && typeof c.update === 'function') c.update();
                    });
                } catch(e) { /* ignore */ }

                await new Promise(r => setTimeout(r, 300));

                const targetScale = 2; 
                const canvas = await html2canvas(el, { scale: targetScale, useCORS: true, backgroundColor: '#ffffff', scrollY: 0 });

                await new Promise(r => setTimeout(r, 50));

                canvas.toBlob((blob) => {
                    if (!blob) { alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'); return; }
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bmi_dashboard_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.png`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                }, 'image/png', 1.0);

                el.style.maxWidth = prevMaxWidth;
                el.style.width = prevWidth;
                el.style.padding = prevPadding;
                el.style.margin = prevMargin;

            } catch (err) {
                console.error('exportToPNG failed', err);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PNG ‡πÑ‡∏î‡πâ: ' + (err && err.message));
            } finally {
                document.body.style.overflow = bodyStyle || '';
                if (aside) aside.style.display = asideDisplay || '';
                if (globalToggle) globalToggle.style.display = '';
                if (mobileToggle) mobileToggle.style.display = '';
                if (contentSection) contentSection.style.overflow = '';
                el.style.cssText = captureStyle || '';
                try {
                    if (historyWrapper && historyPrev) {
                        historyWrapper.style.overflow = historyPrev.overflow || '';
                        historyWrapper.style.height = historyPrev.height || '';
                        historyWrapper.style.maxHeight = historyPrev.maxHeight || '';
                    }
                } catch(e) { /* ignore */ }
            }
        }
        
        function toggleSidebarMobile() {
            try {
                const as = document.querySelector('aside');
                if (!as) return;
                if (as.classList.contains('hidden')) as.classList.remove('hidden');
                else as.classList.add('hidden');
            } catch (e) { console.warn('toggleSidebarMobile', e && e.message); }
        }
        document.getElementById('searchName').addEventListener('input', e => renderSidebar(e.target.value.trim()));

        const inputPhoto = document.getElementById('inputPhoto');
        const inputPhotoPreview = document.getElementById('inputPhotoPreview');
        if (inputPhoto && inputPhotoPreview) {
            inputPhoto.addEventListener('change', function(){
                const f = this.files && this.files[0];
                if (!f) { inputPhotoPreview.style.display = 'none'; inputPhotoPreview.src = ''; return; }
                const fr = new FileReader();
                fr.onload = () => { inputPhotoPreview.src = fr.result; inputPhotoPreview.style.display = 'block'; };
                fr.readAsDataURL(f);
            });
        }

        initApp();
    </script>
</body>
</html>